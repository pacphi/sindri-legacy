#!/bin/bash
# ai-tools.extension - AI CLI tools and coding assistants
# Extension API v2.0
#
# This extension installs AI CLI tools using a hybrid approach:
# - Native installs: Ollama (binary), Fabric (git clone)
# - mise npm backend: codex-cli, @google/gemini-cli (if Node.js available)
# - mise go backend: hector (if Go available)
# - Fallback: Direct npm/go install if mise unavailable

# Source shared extension library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$(dirname "$(dirname "$SCRIPT_DIR")")/extensions-common.sh"

# ============================================================================
# METADATA
# ============================================================================

EXT_NAME="ai-tools"
EXT_VERSION="2.0.0"
EXT_API_VERSION="2.0"
EXT_DESCRIPTION="AI CLI tools and coding assistants (hybrid: native + mise-managed)"
EXT_CATEGORY="ai-tools"
EXT_INSTALL_METHOD="mixed"  # Native + mise
EXT_UPGRADE_STRATEGY="automatic"

# Initialize extension environment
extension_init

# ============================================================================
# PREREQUISITES
# ============================================================================

prerequisites() {
  print_status "Checking prerequisites for ${EXT_NAME}..."

  # Check for required system tools
  local missing_tools=()
  for tool in curl git sudo; do
    if ! command_exists "$tool"; then
      missing_tools+=("$tool")
    fi
  done

  if [[ ${#missing_tools[@]} -gt 0 ]]; then
    print_error "Missing required tools: ${missing_tools[*]}"
    print_status "Install with: sudo apt-get install ${missing_tools[*]}"
    return 1
  fi

  # Check disk space (AI tools need ~1GB)
  local available_space
  available_space=$(df -BM / | awk 'NR==2 {print $4}' | sed 's/M//')
  if [[ $available_space -lt 1500 ]]; then
    print_warning "Low disk space: ${available_space}MB available (1.5GB recommended for AI tools)"
  fi

  # Optional: Check for mise (preferred method)
  if command_exists mise; then
    print_status "mise detected - will use for npm/go tools"
  else
    print_warning "mise not available - will use fallback installations"
  fi

  # Optional dependencies (enable additional tools)
  local optional_deps=()
  command_exists npm && optional_deps+=("npm")
  command_exists go && optional_deps+=("go")
  command_exists pip && optional_deps+=("pip")
  command_exists gh && optional_deps+=("gh")
  command_exists aws && optional_deps+=("aws")

  if [[ ${#optional_deps[@]} -gt 0 ]]; then
    print_status "Optional dependencies available: ${optional_deps[*]}"
  fi

  print_success "All prerequisites met"
  return 0
}

# ============================================================================
# INSTALL
# ============================================================================

install() {
  print_status "Installing AI CLI tools using hybrid approach..."

  # ========================================================================
  # NATIVE INSTALLATIONS (Always installed this way)
  # ========================================================================

  # Check if running in CI mode
  if is_ci_mode; then
    print_status "CI mode detected - skipping native tools (Ollama, Fabric)"
  else
    # Ollama - Native binary installation
    print_status "Installing Ollama (native binary)..."
    if command_exists ollama; then
      print_warning "Ollama already installed"
    else
      local install_output
      if install_output=$(curl -fsSL https://ollama.com/install.sh | sh 2>&1); then
        if command_exists ollama; then
          print_success "Ollama installed"
          print_status "Start with: nohup ollama serve > ~/ollama.log 2>&1 &"
        else
          print_warning "Failed to install Ollama - binary not found after installation"
        fi
      else
        print_warning "Failed to install Ollama"
        echo "$install_output" | grep -i "error\|warn" | head -3
      fi
    fi

    # Fabric - Git clone + Go build (if Go available)
    print_status "Installing Fabric (git clone)..."
    if command_exists fabric; then
      print_warning "Fabric already installed"
    elif ! command_exists go; then
      print_warning "Go not found - skipping Fabric (requires Go to build)"
      print_status "Install golang extension for Fabric"
    else
      local FABRIC_DIR="$HOME/.local/share/fabric"
      mkdir -p "$HOME/.local/bin"

      if [[ -d "$FABRIC_DIR" ]]; then
        print_warning "Fabric repository already exists"
      else
        if git clone --depth 1 https://github.com/danielmiessler/fabric.git "$FABRIC_DIR" 2>&1; then
          print_success "Fabric repository cloned"
        else
          print_warning "Failed to clone Fabric repository"
        fi
      fi

      if [[ -d "$FABRIC_DIR" ]]; then
        cd "$FABRIC_DIR" || return 1
        if go build -o fabric 2>&1; then
          ln -sf "$FABRIC_DIR/fabric" "$HOME/.local/bin/fabric"
          export PATH="$HOME/.local/bin:$PATH"
          print_success "Fabric built and linked"
          print_status "Initialize with: fabric --setup"
        else
          print_warning "Failed to build Fabric"
        fi
        cd - > /dev/null || true
      fi
    fi
  fi

  # ========================================================================
  # MISE-MANAGED INSTALLATIONS (Preferred method)
  # ========================================================================

  if command_exists mise; then
    print_status "Installing AI tools via mise..."

    # Create mise config for ai-tools
    local MISE_CONF_DIR="$HOME/.config/mise/conf.d"
    mkdir -p "$MISE_CONF_DIR"
    local TOML_FILE="$MISE_CONF_DIR/ai-tools.toml"

    # Build toml content dynamically based on available runtimes
    local toml_content="# AI Tools - mise configuration\n# Auto-generated by ai-tools extension\n\n[tools]\n"

    # Add npm-based tools if Node.js is available
    if command_exists npm || command_exists node; then
      toml_content+="# npm-based tools (requires nodejs extension)\n"
      toml_content+='"npm:codex-cli" = "latest"\n'
      toml_content+='"npm:@google/gemini-cli" = "latest"\n'
      toml_content+="\n"
    fi

    # Add Go-based tools if Go is available
    if command_exists go; then
      toml_content+="# Go-based tools (requires golang extension)\n"
      toml_content+='"go:github.com/kadirpekel/hector/cmd/hector" = "latest"\n'
      toml_content+="\n"
    fi

    # Write toml file
    echo -e "$toml_content" > "$TOML_FILE"
    print_success "Created mise config: $TOML_FILE"

    # Install tools via mise
    if mise install 2>&1 | tee /tmp/mise-install.log; then
      print_success "mise install completed"
    else
      print_warning "mise install encountered issues - check /tmp/mise-install.log"
    fi

  else
    # ========================================================================
    # FALLBACK INSTALLATIONS (Direct npm/go install)
    # ========================================================================
    print_warning "mise not available - using fallback installations"

    # Fallback: npm global installs
    if command_exists npm; then
      print_status "Installing npm-based tools (fallback)..."

      # Codex CLI
      if command_exists codex; then
        print_warning "Codex CLI already installed"
      else
        if npm install -g codex-cli 2>&1; then
          command_exists codex && print_success "Codex CLI installed"
        else
          print_warning "Failed to install Codex CLI"
        fi
      fi

      # Gemini CLI
      if command_exists gemini; then
        print_warning "Gemini CLI already installed"
      else
        if npm install -g @google/gemini-cli 2>&1; then
          command_exists gemini && print_success "Gemini CLI installed"
        else
          print_warning "Failed to install Gemini CLI"
        fi
      fi
    else
      print_warning "npm not found - skipping npm-based tools"
      print_status "Install nodejs extension for npm-based tools"
    fi

    # Fallback: go install
    if command_exists go; then
      print_status "Installing Go-based tools (fallback)..."

      # Set up Go bin path
      export GOPATH=$HOME/go
      export GOBIN=$GOPATH/bin
      export PATH=$PATH:$GOBIN
      mkdir -p "$GOBIN"

      # Hector
      if command_exists hector; then
        print_warning "Hector already installed"
      else
        if timeout 300 go install github.com/kadirpekel/hector/cmd/hector@latest 2>&1; then
          command_exists hector && print_success "Hector installed"
        else
          print_warning "Failed to install Hector"
        fi
      fi
    else
      print_warning "Go not found - skipping Go-based tools"
      print_status "Install golang extension for Go-based tools"
    fi
  fi

  # ========================================================================
  # PLATFORM CLIs (No change - installed via platform-specific methods)
  # ========================================================================

  # GitHub Copilot CLI
  print_status "Installing GitHub Copilot CLI..."
  if command_exists gh; then
    if gh extension list 2>/dev/null | grep -q "github/gh-copilot"; then
      print_warning "GitHub Copilot CLI already installed"
    else
      if gh extension install github/gh-copilot 2>&1; then
        print_success "GitHub Copilot CLI installed"
      else
        print_warning "Failed to install GitHub Copilot CLI"
      fi
    fi
  else
    print_warning "GitHub CLI (gh) not found - skipping GitHub Copilot CLI"
    print_status "Install github-cli extension for gh"
  fi

  # AWS Q Developer
  if command_exists aws; then
    print_status "AWS CLI available - Amazon Q Developer accessible via 'aws q' commands"
  else
    print_warning "AWS CLI not found - Amazon Q Developer unavailable"
    print_status "Install cloud-tools extension for AWS CLI"
  fi

  # Python-based tools (xAI Grok SDK)
  if command_exists pip || command_exists pip3; then
    local pip_cmd="pip"
    command_exists pip3 && pip_cmd="pip3"

    print_status "Installing xAI Grok SDK..."
    if $pip_cmd list 2>/dev/null | grep -q "xai-grok-sdk"; then
      print_warning "xAI Grok SDK already installed"
    else
      if $pip_cmd install xai-grok-sdk 2>&1; then
        print_success "xAI Grok SDK installed"
        print_status "Use in Python: from xai_grok_sdk import GrokClient"
      else
        print_warning "Failed to install xAI Grok SDK"
      fi
    fi
  else
    print_warning "pip not found - skipping xAI Grok SDK"
    print_status "Install python extension for Python-based tools"
  fi

  return 0
}

# ============================================================================
# CONFIGURE
# ============================================================================

configure() {
  print_status "Configuring AI CLI tools..."

  # Configure ~/.local/bin PATH for Fabric
  if [[ -d "$HOME/.local/bin" ]]; then
    if command_exists setup_tool_path 2>/dev/null; then
      setup_tool_path "local-bin" 'export PATH=$HOME/.local/bin:$PATH'
    else
      # Fallback: add to bashrc
      if ! grep -q '$HOME/.local/bin' "$HOME/.bashrc" 2>/dev/null; then
        echo "" >> "$HOME/.bashrc"
        echo "# ${EXT_NAME} - Local bin" >> "$HOME/.bashrc"
        echo 'export PATH=$HOME/.local/bin:$PATH' >> "$HOME/.bashrc"
        print_success "Added ~/.local/bin to PATH"
      fi
    fi
    export PATH=$HOME/.local/bin:$PATH
  fi

  # Configure Go bin PATH for SSH sessions (if Go tools were installed)
  if command_exists go && [[ -d "$HOME/go/bin" ]]; then
    if command_exists setup_tool_path 2>/dev/null; then
      setup_tool_path "go-tools" 'export PATH=$PATH:$HOME/go/bin'
    else
      # Fallback: add to bashrc
      if ! grep -q '$HOME/go/bin' "$HOME/.bashrc" 2>/dev/null; then
        echo "" >> "$HOME/.bashrc"
        echo "# ${EXT_NAME} - Go tools" >> "$HOME/.bashrc"
        echo 'export PATH=$PATH:$HOME/go/bin' >> "$HOME/.bashrc"
        print_success "Added Go tools to PATH"
      fi
    fi
    export PATH=$PATH:$HOME/go/bin
  fi

  # Create SSH wrappers
  if command_exists create_tool_wrapper 2>/dev/null; then
    local ai_tools=(codex gemini ollama fabric hector)
    for tool in "${ai_tools[@]}"; do
      if command_exists "$tool"; then
        create_tool_wrapper "$tool" "$(which $tool)"
      fi
    done
  fi

  # Create AI tools aliases
  if ! grep -q "# AI tools aliases" "$HOME/.bashrc" 2>/dev/null; then
    print_status "Creating AI tools aliases..."
    cat "$(dirname "${BASH_SOURCE[0]}")/ai-tools.bashrc.template" >> "$HOME/.bashrc"
    print_success "AI tools aliases created"
  else
    print_debug "AI tools aliases already exist"
  fi

  # Create AI tools workspace
  # Use global WORKSPACE_DIR from common.sh (/workspace/developer/extensions)
  print_status "Setting up AI tools workspace..."
  mkdir -p "$WORKSPACE_DIR/ai-tools"/{ollama-models,fabric-patterns,projects}

  # Create comprehensive README
  if [[ ! -f "$WORKSPACE_DIR/ai-tools/README.md" ]]; then
    cat "$(dirname "${BASH_SOURCE[0]}")/ai-tools.readme.template" > "$WORKSPACE_DIR/ai-tools/README.md"
    print_success "AI tools README created"
  fi

  print_success "AI CLI tools configured"
  return 0
}

# ============================================================================
# VALIDATE
# ============================================================================

validate() {
  print_status "Validating AI CLI tools installation (hybrid approach)..."

  local all_valid=true
  local tools_found=0

  # Native tools
  print_status "Checking native tools..."
  if command_exists ollama; then
    local ollama_version=$(ollama --version 2>/dev/null || echo "unknown")
    print_success "Ollama: $ollama_version"
    ((tools_found++))
  fi

  if command_exists fabric; then
    # Fabric --help doesn't always return clean version info
    print_success "Fabric: installed"
    ((tools_found++))
  fi

  # npm-based tools (mise or fallback)
  print_status "Checking npm-based tools..."
  if command_exists codex; then
    local codex_version=$(codex --version 2>/dev/null || echo "installed")
    print_success "codex: $codex_version"
    ((tools_found++))
  fi

  if command_exists gemini; then
    local gemini_version=$(gemini --version 2>/dev/null || echo "installed")
    print_success "gemini: $gemini_version"
    ((tools_found++))
  fi

  # Go-based tools (mise or fallback)
  print_status "Checking Go-based tools..."
  if command_exists hector; then
    local hector_version=$(hector version 2>/dev/null || echo "installed")
    print_success "hector: $hector_version"
    ((tools_found++))
  fi

  # Python-based tools
  print_status "Checking Python-based SDKs..."
  local pip_cmd="pip"
  command_exists pip3 && pip_cmd="pip3"
  if command_exists $pip_cmd && $pip_cmd list 2>/dev/null | grep -q "xai-grok-sdk"; then
    print_success "xai-grok-sdk: installed"
    ((tools_found++))
  fi

  # Platform CLIs
  print_status "Checking platform CLIs..."
  local platform_found=0
  if command_exists gh && gh extension list 2>/dev/null | grep -q "gh-copilot"; then
    print_success "GitHub Copilot CLI: installed"
    ((platform_found++))
  fi
  if command_exists aws; then
    print_success "AWS Q Developer: available via 'aws q'"
    ((platform_found++))
  fi

  # Check mise config if mise is available
  if command_exists mise; then
    local TOML_FILE="$HOME/.config/mise/conf.d/ai-tools.toml"
    if [[ -f "$TOML_FILE" ]]; then
      print_success "mise config: $TOML_FILE"
    fi
  fi

  # Check workspace
  # Use global WORKSPACE_DIR from common.sh
  if [[ -d "$WORKSPACE_DIR/ai-tools" ]]; then
    print_success "AI tools workspace: exists"
  else
    print_warning "AI tools workspace: not found"
  fi

  # Summary
  print_status "Total tools found: $tools_found (including $platform_found platform CLIs)"

  if [[ $tools_found -eq 0 ]]; then
    print_error "No AI tools found"
    all_valid=false
  fi

  if [[ "$all_valid" == "true" ]]; then
    print_success "Validation passed"
    return 0
  else
    print_error "Validation failed"
    return 1
  fi
}

# ============================================================================
# STATUS
# ============================================================================

status() {
  print_extension_header

  # Check installation status - at least one tool should be present
  local any_tool_found=false
  local all_tools=(codex gemini ollama fabric hector)
  for tool in "${all_tools[@]}"; do
    if command_exists "$tool"; then
      any_tool_found=true
      break
    fi
  done

  if ! $any_tool_found; then
    echo "Status: ✗ NOT INSTALLED"
    return 1
  fi

  echo "Status: ✓ INSTALLED (Hybrid: Native + mise)"
  echo ""

  # Installation method
  if command_exists mise; then
    local TOML_FILE="$HOME/.config/mise/conf.d/ai-tools.toml"
    if [[ -f "$TOML_FILE" ]]; then
      print_status "Installation method: mise (preferred) + native"
    else
      print_status "Installation method: Native + fallback"
    fi
  else
    print_status "Installation method: Native + fallback (mise not available)"
  fi
  echo ""

  # Native tools
  echo "  Native installations:"
  if command_exists ollama; then
    local version=$(ollama --version 2>/dev/null || echo "installed")
    echo "    ✓ Ollama: $version"
  else
    echo "    ✗ Ollama: not installed"
  fi

  if command_exists fabric; then
    echo "    ✓ Fabric: installed (git clone + Go build)"
  else
    echo "    ✗ Fabric: not installed"
  fi

  # mise-managed or fallback tools
  echo ""
  if command_exists mise && [[ -f "$HOME/.config/mise/conf.d/ai-tools.toml" ]]; then
    echo "  mise-managed tools:"
  else
    echo "  Fallback installations:"
  fi

  # npm-based tools
  if command_exists npm || command_exists node; then
    echo "    npm-based:"
    for tool in codex gemini; do
      if command_exists "$tool"; then
        local version=$($tool --version 2>/dev/null || echo "installed")
        echo "      ✓ $tool: $version"
      else
        echo "      ✗ $tool: not installed"
      fi
    done
  else
    echo "    npm-based: (Node.js not available)"
  fi

  # Go-based tools
  if command_exists go; then
    echo "    Go-based:"
    if command_exists hector; then
      local version=$(hector version 2>/dev/null || echo "installed")
      echo "      ✓ hector: $version"
    else
      echo "      ✗ hector: not installed"
    fi
  else
    echo "    Go-based: (Go not available)"
  fi

  # Python-based tools
  echo ""
  echo "  Python-based SDKs:"
  local pip_cmd="pip"
  command_exists pip3 && pip_cmd="pip3"
  if command_exists $pip_cmd && $pip_cmd list 2>/dev/null | grep -q "xai-grok-sdk"; then
    echo "    ✓ xai-grok-sdk: installed"
  else
    echo "    ✗ xai-grok-sdk: not installed (requires pip)"
  fi

  # Platform CLIs
  echo ""
  echo "  Platform CLIs:"
  if command_exists gh && gh extension list 2>/dev/null | grep -q "gh-copilot"; then
    echo "    ✓ GitHub Copilot CLI (via gh extension)"
  else
    echo "    ✗ GitHub Copilot CLI (requires gh)"
  fi
  if command_exists aws; then
    echo "    ✓ AWS Q Developer (via 'aws q' commands)"
  else
    echo "    ✗ AWS Q Developer (requires AWS CLI)"
  fi

  # API key requirements
  echo ""
  print_status "API key requirements:"
  echo "  • Ollama: None (local models)"
  echo "  • Fabric: Optional (for AI features)"
  echo "  • Codex: Requires API key"
  echo "  • Gemini: Requires GOOGLE_GEMINI_API_KEY"
  echo "  • GitHub Copilot: Requires GitHub subscription"
  echo "  • AWS Q: Requires AWS credentials"
  echo "  • xAI Grok SDK: Requires XAI_API_KEY"

  # Dependencies
  echo ""
  print_status "Available dependencies:"
  local deps=()
  command_exists mise && deps+=("mise")
  command_exists npm && deps+=("npm")
  command_exists go && deps+=("go")
  command_exists pip && deps+=("pip")
  command_exists gh && deps+=("gh")
  command_exists aws && deps+=("aws")

  if [[ ${#deps[@]} -gt 0 ]]; then
    echo "  ${deps[*]}"
  else
    echo "  (none)"
  fi

  # mise config location
  if command_exists mise; then
    echo ""
    print_status "mise configuration:"
    local TOML_FILE="$HOME/.config/mise/conf.d/ai-tools.toml"
    if [[ -f "$TOML_FILE" ]]; then
      echo "  $TOML_FILE"
    else
      echo "  (not configured)"
    fi
  fi

  # Workspace
  echo ""
  # Use global WORKSPACE_DIR from common.sh
  if [[ -d "$WORKSPACE_DIR/ai-tools" ]]; then
    print_status "AI tools workspace:"
    echo "  $WORKSPACE_DIR/ai-tools/"
    for dir in ollama-models fabric-patterns projects; do
      [[ -d "$WORKSPACE_DIR/ai-tools/$dir" ]] && echo "    ├── $dir/"
    done
  fi

  return 0
}

# ============================================================================
# HELPER FUNCTIONS
# ============================================================================

# check_dependent_extensions is now provided by extensions-common.sh

# ============================================================================
# UPGRADE
# ============================================================================

upgrade() {
  print_status "Upgrading ${EXT_NAME}..."

  local upgraded_count=0
  local failed_count=0

  # Upgrade mise-managed tools if available
  if command_exists mise; then
    print_status "Upgrading mise-managed AI tools..."
    activate_mise_environment

    if upgrade_mise_tools "${EXT_NAME}"; then
      print_success "mise-managed AI tools upgraded"
      ((upgraded_count++))
    else
      print_warning "Failed to upgrade some mise-managed tools"
      ((failed_count++))
    fi
  fi

  # Upgrade Ollama (native binary)
  if command_exists ollama; then
    print_status "Upgrading Ollama..."
    if curl -fsSL https://ollama.com/install.sh | sh 2>&1 | grep -q "Ollama"; then
      print_success "Ollama upgraded"
      ((upgraded_count++))
    else
      print_warning "Failed to upgrade Ollama"
      ((failed_count++))
    fi
  fi

  # Upgrade Fabric (git repo)
  if [[ -d "$HOME/.local/share/fabric" ]]; then
    print_status "Upgrading Fabric..."
    if upgrade_git_repo "$HOME/.local/share/fabric"; then
      cd "$HOME/.local/share/fabric" || return 1
      if command_exists go && go build -o fabric 2>&1; then
        ln -sf "$HOME/.local/share/fabric/fabric" "$HOME/.local/bin/fabric"
        print_success "Fabric upgraded and rebuilt"
        ((upgraded_count++))
      else
        print_warning "Failed to rebuild Fabric"
        ((failed_count++))
      fi
      cd - > /dev/null || true
    else
      print_warning "Failed to upgrade Fabric"
      ((failed_count++))
    fi
  fi

  # Upgrade GitHub Copilot extension
  if command_exists gh && gh extension list 2>/dev/null | grep -q "gh-copilot"; then
    print_status "Upgrading GitHub Copilot CLI..."
    if gh extension upgrade github/gh-copilot 2>&1; then
      print_success "GitHub Copilot CLI upgraded"
      ((upgraded_count++))
    else
      print_warning "Failed to upgrade GitHub Copilot CLI"
      ((failed_count++))
    fi
  fi

  # Summary
  echo ""
  print_status "Upgrade summary: $upgraded_count upgraded, $failed_count failed"

  if [[ $upgraded_count -gt 0 ]]; then
    print_success "AI tools upgrade completed"
    return 0
  else
    print_warning "No AI tools were upgraded"
    return 1
  fi
}

# ============================================================================
# REMOVE
# ============================================================================

remove() {
  print_warning "Uninstalling AI CLI tools (hybrid approach)..."

  show_dependent_extensions_warning "codex" "gemini" "ollama" "fabric" "hector"

  if ! prompt_confirmation "Continue with AI tools removal?"; then
    print_status "Removal cancelled"
    return 1
  fi

  # Remove mise config
  if command_exists mise; then
    local TOML_FILE="$HOME/.config/mise/conf.d/ai-tools.toml"
    if [[ -f "$TOML_FILE" ]]; then
      print_status "Removing mise configuration..."
      rm -f "$TOML_FILE"
      print_success "mise config removed"
    fi
  fi

  # Remove npm-based tools (if installed via fallback)
  if command_exists npm; then
    print_status "Removing npm-based tools..."
    local npm_tools=(codex-cli @google/gemini-cli)
    for tool in "${npm_tools[@]}"; do
      if npm list -g "$tool" 2>/dev/null | grep -q "$tool"; then
        npm uninstall -g "$tool" 2>/dev/null
      fi
    done
  fi

  # Remove GitHub Copilot extension
  if command_exists gh && gh extension list 2>/dev/null | grep -q "gh-copilot"; then
    gh extension remove github/gh-copilot 2>/dev/null
    print_success "GitHub Copilot CLI removed"
  fi

  # Remove Ollama (native installation)
  if command_exists ollama; then
    print_status "Removing Ollama..."
    sudo systemctl stop ollama 2>/dev/null || killall ollama 2>/dev/null
    sudo rm -f /usr/local/bin/ollama /usr/bin/ollama
    rm -rf ~/.ollama
    print_success "Ollama removed"
  fi

  # Remove Fabric (git clone + build)
  if [[ -d "$HOME/.local/share/fabric" ]]; then
    print_status "Removing Fabric..."
    rm -rf "$HOME/.local/share/fabric"
    [[ -L "$HOME/.local/bin/fabric" ]] && rm -f "$HOME/.local/bin/fabric"
    print_success "Fabric removed"
  fi

  # Remove Go-based tools (if installed via fallback)
  if [[ -d "$HOME/go/bin" ]]; then
    [[ -f "$HOME/go/bin/hector" ]] && rm -f "$HOME/go/bin/hector"
  fi

  # Remove Python-based tools
  if command_exists pip || command_exists pip3; then
    local pip_cmd="pip"
    command_exists pip3 && pip_cmd="pip3"
    $pip_cmd uninstall -y xai-grok-sdk 2>/dev/null
  fi

  # Remove aliases
  cleanup_bashrc "# AI tools aliases"

  # Remove Go tools PATH from bashrc
  cleanup_bashrc "# ${EXT_NAME} - Go tools"

  # Remove local bin PATH from bashrc
  cleanup_bashrc "# ${EXT_NAME} - Local bin"

  # Remove workspace
  # Use global WORKSPACE_DIR from common.sh
  if [[ -d "$WORKSPACE_DIR/ai-tools" ]]; then
    read -p "Remove AI tools workspace directory? (y/N): " -r
    if [[ $REPLY =~ ^[Yy]$ ]]; then
      rm -rf "$WORKSPACE_DIR/ai-tools"
      print_success "AI tools workspace removed"
    fi
  fi

  print_success "AI CLI tools uninstalled"
  print_warning "Restart shell: source ~/.bashrc"
  return 0
}

# ============================================================================
# MAIN EXECUTION
# ============================================================================

extension_main "$@"
