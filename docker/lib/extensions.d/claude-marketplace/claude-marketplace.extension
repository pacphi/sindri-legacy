#!/bin/bash
# claude-marketplace.extension - Claude Code plugin marketplace integration
# Extension API v2.0
#
# This extension configures Claude Code marketplaces and plugins via YAML configuration.
# Converts marketplaces.yml to JSON and merges into ~/.claude/settings.json.
# Claude Code automatically installs marketplaces and plugins when next invoked.
# Requires Claude Code to be authenticated (via claude-auth-with-api-key extension or manual auth).

# Source shared extension library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$(dirname "$(dirname "$SCRIPT_DIR")")/extensions-common.sh"

# ============================================================================
# METADATA
# ============================================================================

EXT_NAME="claude-marketplace"
EXT_VERSION="2.0.0"
EXT_API_VERSION="2.0"
EXT_DESCRIPTION="Claude Code plugin marketplace integration via YAML configuration and settings.json"
EXT_CATEGORY="dev-tools"
EXT_INSTALL_METHOD="native"
EXT_UPGRADE_STRATEGY="manual"

# Initialize extension environment
extension_init

# ============================================================================
# CONFIGURATION
# ============================================================================

CLAUDE_CONFIG_DIR="$HOME/.claude"
CLAUDE_SETTINGS="$CLAUDE_CONFIG_DIR/settings.json"

# Select appropriate YAML file based on CI mode
if is_ci_mode; then
  MARKETPLACES_YAML="marketplaces.ci.yml"
  MARKETPLACES_EXAMPLE="$SCRIPT_DIR/marketplaces.ci.yml.example"
else
  MARKETPLACES_YAML="marketplaces.yml"
  MARKETPLACES_EXAMPLE="$SCRIPT_DIR/marketplaces.yml.example"
fi

# Working file location in config directory (developer-owned)
MARKETPLACES_CONFIG_DIR="/workspace/config"
MARKETPLACES_FILE="$MARKETPLACES_CONFIG_DIR/$MARKETPLACES_YAML"

# ============================================================================
# PREREQUISITES
# ============================================================================

prerequisites() {
  print_status "Checking prerequisites for ${EXT_NAME}..."

  # Hard requirement: Claude Code CLI must be available (pre-installed in base image)
  if ! command_exists claude; then
    print_error "Claude CLI is required but not found (should be pre-installed)"
    print_status "For API key auth: extension-manager install claude-auth-with-api-key"
    print_status "Or authenticate manually: claude"
    return 1
  fi

  print_success "Claude CLI is available"

  # Check Claude config directory exists
  if [[ ! -d "$CLAUDE_CONFIG_DIR" ]]; then
    print_error "Claude config directory not found: $CLAUDE_CONFIG_DIR"
    print_status "Run 'claude' first to initialize configuration"
    return 1
  fi

  print_success "Claude config directory exists"

  # Check for jq (required for JSON merging)
  if ! command_exists jq; then
    print_error "jq is required but not installed"
    print_status "jq is needed to merge JSON into settings.json"
    return 1
  fi

  print_success "jq is available"

  # Check for yq (required for YAML parsing)
  if ! command_exists yq; then
    print_error "yq is required but not installed"
    print_status "yq should be installed as part of the base image"
    return 1
  fi

  print_success "yq is available"

  print_success "All prerequisites met"
  return 0
}

# ============================================================================
# INSTALL
# ============================================================================

install() {
  print_status "Installing ${EXT_NAME}..."

  # Ensure config directory exists (should be created by setup-workspace.sh, but verify)
  if [[ ! -d "$MARKETPLACES_CONFIG_DIR" ]]; then
    mkdir -p "$MARKETPLACES_CONFIG_DIR"
    print_status "Created config directory: $MARKETPLACES_CONFIG_DIR"
  fi

  # Copy YAML example template to config directory
  local workspace_example="$MARKETPLACES_CONFIG_DIR/$(basename "$MARKETPLACES_EXAMPLE")"
  if [[ ! -f "$workspace_example" ]]; then
    print_status "Creating YAML example template..."
    if cp "$MARKETPLACES_EXAMPLE" "$workspace_example"; then
      print_success "Created $workspace_example"
    else
      print_warning "Could not create YAML example template"
    fi
  fi

  # In CI mode or if YAML file doesn't exist, copy from example
  if [[ ! -f "$MARKETPLACES_FILE" ]]; then
    if is_ci_mode; then
      print_status "CI mode: Creating $MARKETPLACES_YAML from CI template..."
    else
      print_status "Creating $MARKETPLACES_YAML from template..."
    fi

    if cp "$MARKETPLACES_EXAMPLE" "$MARKETPLACES_FILE"; then
      print_success "Created $MARKETPLACES_FILE"
    else
      print_error "Could not create $MARKETPLACES_FILE"
      return 1
    fi
  fi

  # Process YAML configuration if it exists
  if [[ -f "$MARKETPLACES_FILE" ]]; then
    print_status "Processing marketplace configuration from $MARKETPLACES_YAML..."

    # Change to extension directory (for relative paths to default-settings.json)
    cd "$SCRIPT_DIR" || return 1

    # Convert YAML to JSON
    local marketplace_json="/tmp/marketplaces-$$.json"
    if ! convert_yaml_to_json "$MARKETPLACES_FILE" "$marketplace_json"; then
      rm -f "$marketplace_json"
      return 1
    fi

    # Merge into settings.json
    if ! merge_settings_json "$marketplace_json"; then
      rm -f "$marketplace_json"
      return 1
    fi

    # Cleanup temporary file
    rm -f "$marketplace_json"

    print_success "Marketplace configuration installed to settings.json"
    echo ""
    print_status "Next steps:"
    echo "  1. Invoke 'claude' to trigger automatic marketplace and plugin installation"
    echo "  2. Claude Code will register marketplaces from extraKnownMarketplaces"
    echo "  3. Claude Code will install plugins from enabledPlugins (enabled=true)"
    echo ""
    echo "To verify configuration: cat $CLAUDE_SETTINGS"
  else
    print_status "No $MARKETPLACES_YAML file found (optional)"
    print_status "Create $MARKETPLACES_FILE to configure marketplaces"
    print_status "See $workspace_example for template"
  fi

  print_success "${EXT_NAME} installation complete"
  return 0
}

# ============================================================================
# HELPER FUNCTIONS
# ============================================================================

# Convert YAML configuration to JSON
# Args: $1 - path to YAML file
# Args: $2 - path to output JSON file
# Returns: 0 on success, 1 on failure
convert_yaml_to_json() {
  local yaml_file="$1"
  local json_file="$2"

  if [[ ! -f "$yaml_file" ]]; then
    print_error "YAML file not found: $yaml_file"
    return 1
  fi

  print_status "Converting YAML to JSON..."

  if ! yq eval -o=json "$yaml_file" > "$json_file" 2>/dev/null; then
    print_error "Failed to convert YAML to JSON"
    print_error "Check YAML syntax in: $yaml_file"
    return 1
  fi

  # Validate JSON output
  if ! jq empty "$json_file" 2>/dev/null; then
    print_error "Generated invalid JSON from YAML"
    return 1
  fi

  print_success "YAML converted to JSON: $json_file"
  return 0
}

# Backup settings.json with timestamp
# Returns: 0 on success, 1 on failure
backup_settings_json() {
  if [[ ! -f "$CLAUDE_SETTINGS" ]]; then
    # No existing settings to backup
    return 0
  fi

  local backup_dir="${CLAUDE_CONFIG_DIR}/backups"
  mkdir -p "$backup_dir"

  local timestamp
  timestamp=$(date +%Y%m%d-%H%M%S)
  local backup_file="${backup_dir}/settings-${timestamp}.json"

  print_status "Backing up settings.json..."

  if ! cp "$CLAUDE_SETTINGS" "$backup_file"; then
    print_warning "Could not create backup"
    return 1
  fi

  print_success "Backup created: $backup_file"

  # Keep only last 5 backups
  local backup_count
  backup_count=$(find "$backup_dir" -name "settings-*.json" -type f | wc -l)
  if [[ $backup_count -gt 5 ]]; then
    print_status "Cleaning old backups (keeping last 5)..."
    find "$backup_dir" -name "settings-*.json" -type f -printf '%T+ %p\n' | \
      sort | \
      head -n -5 | \
      cut -d' ' -f2- | \
      xargs rm -f
  fi

  return 0
}

# Merge marketplace JSON into settings.json
# Args: $1 - path to marketplace JSON file
# Returns: 0 on success, 1 on failure
merge_settings_json() {
  local marketplace_json="$1"

  if [[ ! -f "$marketplace_json" ]]; then
    print_error "Marketplace JSON not found: $marketplace_json"
    return 1
  fi

  print_status "Merging marketplace configuration into settings.json..."

  # Create Claude config directory if it doesn't exist
  mkdir -p "$CLAUDE_CONFIG_DIR"

  # Determine base settings file
  local base_settings
  if [[ -f "$CLAUDE_SETTINGS" ]]; then
    base_settings="$CLAUDE_SETTINGS"
    print_status "Using existing settings.json as base"
  else
    base_settings="$SCRIPT_DIR/default-settings.json"
    print_status "Using default-settings.json as base (no existing settings.json)"
  fi

  # Verify base settings exists
  if [[ ! -f "$base_settings" ]]; then
    print_error "Base settings file not found: $base_settings"
    return 1
  fi

  # Create temporary merged file
  local merged_file="/tmp/claude-settings-merged-$$.json"

  # Merge: base_settings * marketplace_json (marketplace_json overwrites on conflict)
  if ! jq -s '.[0] * .[1]' "$base_settings" "$marketplace_json" > "$merged_file" 2>/dev/null; then
    print_error "Failed to merge JSON files"
    rm -f "$merged_file"
    return 1
  fi

  # Validate merged JSON
  if ! jq empty "$merged_file" 2>/dev/null; then
    print_error "Generated invalid JSON during merge"
    rm -f "$merged_file"
    return 1
  fi

  # Backup existing settings (if exists)
  backup_settings_json

  # Install merged settings
  if ! cp -f "$merged_file" "$CLAUDE_SETTINGS"; then
    print_error "Failed to write settings.json"
    rm -f "$merged_file"
    return 1
  fi

  # Set proper permissions
  chmod 644 "$CLAUDE_SETTINGS"

  rm -f "$merged_file"
  print_success "Settings merged into: $CLAUDE_SETTINGS"
  return 0
}

# ============================================================================
# CONFIGURE
# ============================================================================

configure() {
  print_status "Configuring ${EXT_NAME}..."

  # Verify settings.json was created successfully
  if [[ -f "$CLAUDE_SETTINGS" ]]; then
    print_success "Claude settings.json exists: $CLAUDE_SETTINGS"

    # Display configured marketplaces
    if command_exists jq; then
      local marketplace_count
      marketplace_count=$(jq -r '.extraKnownMarketplaces // {} | length' "$CLAUDE_SETTINGS" 2>/dev/null || echo "0")
      local plugin_count
      plugin_count=$(jq -r '.enabledPlugins // {} | length' "$CLAUDE_SETTINGS" 2>/dev/null || echo "0")

      echo ""
      print_status "Marketplace configuration summary:"
      echo "  Configured marketplaces: $marketplace_count"
      echo "  Enabled plugins: $plugin_count"
      echo ""
    fi
  else
    print_warning "Claude settings.json not found (expected at: $CLAUDE_SETTINGS)"
    print_status "Run 'extension-manager install claude-marketplace' to create it"
  fi

  # Provide next steps guidance
  echo ""
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  print_status "Marketplace installation workflow:"
  echo ""
  echo "  1. Configuration written to: $CLAUDE_SETTINGS"
  echo "  2. Marketplaces and plugins will be installed automatically"
  echo "     when you next invoke Claude Code"
  echo ""
  echo "  To customize marketplaces/plugins:"
  echo "    • Edit: $MARKETPLACES_FILE"
  echo "    • Reinstall: extension-manager install claude-marketplace"
  echo ""
  echo "  To verify configuration:"
  echo "    • View settings: cat $CLAUDE_SETTINGS"
  echo "    • Check status: extension-manager status claude-marketplace"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ""

  # Create SSH wrapper for claude command if not already created by claude extension
  if command_exists create_tool_wrapper 2>/dev/null; then
    if command_exists claude; then
      local claude_path
      claude_path=$(which claude)
      create_tool_wrapper "claude" "$claude_path"
      print_success "Created SSH wrapper for claude"
    fi
  fi

  print_success "${EXT_NAME} configuration complete"
  return 0
}

# ============================================================================
# VALIDATE
# ============================================================================

validate() {
  print_status "Validating ${EXT_NAME} installation..."

  local all_valid=true

  # Check claude command exists
  if ! command_exists claude; then
    print_error "claude command not found"
    all_valid=false
  else
    print_success "claude command available"
  fi

  # Check yq command exists
  if ! command_exists yq; then
    print_error "yq command not found (required for YAML parsing)"
    all_valid=false
  else
    print_success "yq command available"
  fi

  # Check jq command exists
  if ! command_exists jq; then
    print_error "jq command not found (required for JSON merging)"
    all_valid=false
  else
    print_success "jq command available"
  fi

  # Check settings.json exists
  if [[ ! -f "$CLAUDE_SETTINGS" ]]; then
    print_error "Claude settings.json not found: $CLAUDE_SETTINGS"
    all_valid=false
  else
    print_success "Claude settings.json exists: $CLAUDE_SETTINGS"

    # Validate JSON syntax
    if ! jq empty "$CLAUDE_SETTINGS" 2>/dev/null; then
      print_error "settings.json has invalid JSON syntax"
      all_valid=false
    else
      print_success "settings.json has valid JSON syntax"
    fi

    # Validate extraKnownMarketplaces structure
    if jq -e '.extraKnownMarketplaces' "$CLAUDE_SETTINGS" >/dev/null 2>&1; then
      local marketplace_type
      marketplace_type=$(jq -r '.extraKnownMarketplaces | type' "$CLAUDE_SETTINGS" 2>/dev/null)

      if [[ "$marketplace_type" == "object" ]]; then
        local marketplace_count
        marketplace_count=$(jq -r '.extraKnownMarketplaces | length' "$CLAUDE_SETTINGS" 2>/dev/null)
        print_success "extraKnownMarketplaces is valid object ($marketplace_count marketplaces)"
      else
        print_error "extraKnownMarketplaces is not an object (found: $marketplace_type)"
        all_valid=false
      fi
    else
      print_warning "extraKnownMarketplaces not found in settings.json"
    fi

    # Validate enabledPlugins structure
    if jq -e '.enabledPlugins' "$CLAUDE_SETTINGS" >/dev/null 2>&1; then
      local plugins_type
      plugins_type=$(jq -r '.enabledPlugins | type' "$CLAUDE_SETTINGS" 2>/dev/null)

      if [[ "$plugins_type" == "object" ]]; then
        local plugin_count
        plugin_count=$(jq -r '.enabledPlugins | length' "$CLAUDE_SETTINGS" 2>/dev/null)
        print_success "enabledPlugins is valid object ($plugin_count plugins)"

        # Validate plugin references match known marketplaces
        local marketplace_names
        marketplace_names=$(jq -r '.extraKnownMarketplaces // {} | keys[]' "$CLAUDE_SETTINGS" 2>/dev/null || echo "")

        local invalid_plugins=0
        while IFS= read -r plugin; do
          if [[ "$plugin" =~ @ ]]; then
            local marketplace="${plugin##*@}"
            if ! echo "$marketplace_names" | grep -q "^${marketplace}$"; then
              print_warning "Plugin '$plugin' references unknown marketplace: $marketplace"
              invalid_plugins=$((invalid_plugins + 1))
            fi
          fi
        done < <(jq -r '.enabledPlugins | to_entries[] | select(.value == true) | .key' "$CLAUDE_SETTINGS" 2>/dev/null)

        if [[ $invalid_plugins -gt 0 ]]; then
          print_warning "$invalid_plugins plugin(s) reference unknown marketplaces"
        else
          print_success "All plugin references are valid"
        fi
      else
        print_error "enabledPlugins is not an object (found: $plugins_type)"
        all_valid=false
      fi
    else
      print_warning "enabledPlugins not found in settings.json"
    fi
  fi

  # Check YAML template exists
  local yaml_example="$MARKETPLACES_CONFIG_DIR/$(basename "$MARKETPLACES_EXAMPLE")"
  if [[ -f "$yaml_example" ]]; then
    print_success "YAML template exists: $yaml_example"
  else
    print_warning "YAML template not found: $yaml_example"
  fi

  # Check YAML configuration file exists
  if [[ -f "$MARKETPLACES_FILE" ]]; then
    print_success "YAML configuration exists: $MARKETPLACES_FILE"

    # Validate YAML syntax
    if yq eval '.' "$MARKETPLACES_FILE" >/dev/null 2>&1; then
      print_success "YAML configuration has valid syntax"
    else
      print_error "YAML configuration has invalid syntax"
      all_valid=false
    fi
  else
    print_warning "YAML configuration not found: $MARKETPLACES_FILE"
  fi

  if [[ "$all_valid" == "true" ]]; then
    print_success "Validation passed"
    return 0
  else
    print_error "Validation failed"
    return 1
  fi
}

# ============================================================================
# STATUS
# ============================================================================

status() {
  print_extension_header

  # Check dependency
  if ! command_exists claude; then
    echo "Status: ✗ NOT INSTALLED (claude dependency missing)"
    return 1
  fi

  # Check if settings.json exists
  if [[ ! -f "$CLAUDE_SETTINGS" ]]; then
    echo "Status: ✗ NOT INSTALLED (settings.json not found)"
    echo ""
    echo "Run: extension-manager install claude-marketplace"
    return 1
  fi

  # Validate settings.json is valid JSON
  if ! jq empty "$CLAUDE_SETTINGS" 2>/dev/null; then
    echo "Status: ✗ ERROR (settings.json has invalid JSON)"
    return 1
  fi

  # Check if marketplace configuration exists in settings.json
  # Either extraKnownMarketplaces or enabledPlugins must be present
  local has_marketplaces=false
  local has_plugins=false

  if jq -e '.extraKnownMarketplaces' "$CLAUDE_SETTINGS" >/dev/null 2>&1; then
    has_marketplaces=true
  fi

  if jq -e '.enabledPlugins' "$CLAUDE_SETTINGS" >/dev/null 2>&1; then
    has_plugins=true
  fi

  if [[ "$has_marketplaces" == "false" ]] && [[ "$has_plugins" == "false" ]]; then
    echo "Status: ✗ NOT INSTALLED (marketplace configuration not found)"
    echo ""
    echo "Run: extension-manager install claude-marketplace"
    return 1
  fi

  echo "Status: ✓ INSTALLED"
  echo ""

  # Show settings file location
  print_status "Settings File:"
  echo "  $CLAUDE_SETTINGS"
  if [[ -f "$CLAUDE_SETTINGS" ]]; then
    echo "  (exists ✓)"
  fi
  echo ""

  # Show configured marketplaces
  print_status "Configured Marketplaces:"
  if command_exists jq; then
    local marketplace_count
    marketplace_count=$(jq -r '.extraKnownMarketplaces // {} | length' "$CLAUDE_SETTINGS" 2>/dev/null || echo "0")

    if [[ "$marketplace_count" -eq 0 ]]; then
      echo "  (none configured)"
    else
      echo "  Total: $marketplace_count"
      echo ""

      # List each marketplace with its source
      jq -r '.extraKnownMarketplaces // {} | to_entries[] | "  • \(.key)\n    Source: \(.value.source.source)\n    Repo: \(.value.source.repo // .value.source.url // .value.source.path)"' "$CLAUDE_SETTINGS" 2>/dev/null
    fi
  else
    echo "  (jq not available - cannot parse)"
  fi
  echo ""

  # Show enabled plugins
  print_status "Enabled Plugins:"
  if command_exists jq; then
    local plugin_count
    plugin_count=$(jq -r '.enabledPlugins // {} | length' "$CLAUDE_SETTINGS" 2>/dev/null || echo "0")

    if [[ "$plugin_count" -eq 0 ]]; then
      echo "  (none enabled)"
    else
      echo "  Total: $plugin_count"
      echo ""

      # Group plugins by marketplace
      local marketplaces
      marketplaces=$(jq -r '.extraKnownMarketplaces // {} | keys[]' "$CLAUDE_SETTINGS" 2>/dev/null)

      for marketplace in $marketplaces; do
        local marketplace_plugins
        marketplace_plugins=$(jq -r --arg mp "$marketplace" '.enabledPlugins // {} | to_entries[] | select(.value == true and (.key | endswith("@" + $mp))) | .key' "$CLAUDE_SETTINGS" 2>/dev/null)

        if [[ -n "$marketplace_plugins" ]]; then
          echo "  From $marketplace:"
          echo "$marketplace_plugins" | while IFS= read -r plugin; do
            local plugin_name="${plugin%%@*}"
            echo "    - $plugin_name"
          done
        fi
      done
    fi
  else
    echo "  (jq not available - cannot parse)"
  fi
  echo ""

  # Show YAML configuration file status
  print_status "YAML Configuration:"
  if [[ -f "$MARKETPLACES_FILE" ]]; then
    echo "  File: $MARKETPLACES_FILE"
    echo "  Status: ✓ exists"
  else
    echo "  File: $MARKETPLACES_FILE"
    echo "  Status: ✗ not found"
    echo ""
    echo "  To create: cp $(basename "$MARKETPLACES_EXAMPLE") $MARKETPLACES_FILE"
  fi
  echo ""

  # Show management commands
  print_status "Management:"
  echo "  • Edit YAML: vim $MARKETPLACES_FILE"
  echo "  • Reinstall: extension-manager install claude-marketplace"
  echo "  • View settings: cat $CLAUDE_SETTINGS"
  echo "  • Backup settings: cp $CLAUDE_SETTINGS $CLAUDE_SETTINGS.backup"
  echo ""

  print_status "Note:"
  echo "  Marketplaces and plugins are installed automatically when Claude Code is invoked."

  return 0
}

# ============================================================================
# UPGRADE - Extension API v2.0
# ============================================================================

upgrade() {
  print_status "Upgrading ${EXT_NAME}..."

  # Re-process YAML configuration and update settings.json
  if [[ -f "$MARKETPLACES_FILE" ]]; then
    print_status "Re-processing $MARKETPLACES_YAML configuration..."

    # Change to extension directory (for relative paths to default-settings.json)
    cd "$SCRIPT_DIR" || return 1

    # Convert YAML to JSON
    local marketplace_json="/tmp/marketplaces-upgrade-$$.json"
    if ! convert_yaml_to_json "$MARKETPLACES_FILE" "$marketplace_json"; then
      rm -f "$marketplace_json"
      return 1
    fi

    # Merge into settings.json
    if ! merge_settings_json "$marketplace_json"; then
      rm -f "$marketplace_json"
      return 1
    fi

    # Cleanup temporary file
    rm -f "$marketplace_json"

    print_success "Marketplace configuration upgraded in settings.json"
  else
    print_status "No $MARKETPLACES_YAML file found - nothing to upgrade"
  fi

  print_success "${EXT_NAME} upgraded successfully"
  return 0
}

# ============================================================================
# REMOVE
# ============================================================================

remove() {
  print_warning "Uninstalling ${EXT_NAME}..."

  # Remove marketplace configuration from settings.json
  if [[ -f "$CLAUDE_SETTINGS" ]]; then
    echo ""
    if prompt_confirmation "Remove marketplace configuration from settings.json?"; then
      print_status "Removing marketplace configuration..."

      # Backup settings.json before modification
      backup_settings_json

      # Create temporary file with marketplace config removed
      local cleaned_settings="/tmp/claude-settings-cleaned-$$.json"

      # Remove extraKnownMarketplaces and marketplace-related enabledPlugins
      if jq 'del(.extraKnownMarketplaces) | .enabledPlugins = (.enabledPlugins // {} | with_entries(select(.key | contains("@") | not)))' "$CLAUDE_SETTINGS" > "$cleaned_settings" 2>/dev/null; then
        if jq empty "$cleaned_settings" 2>/dev/null; then
          cp -f "$cleaned_settings" "$CLAUDE_SETTINGS"
          chmod 644 "$CLAUDE_SETTINGS"
          print_success "Marketplace configuration removed from settings.json"
        else
          print_error "Generated invalid JSON during cleanup"
          rm -f "$cleaned_settings"
          print_status "Settings.json backup preserved at: ${CLAUDE_CONFIG_DIR}/backups/"
        fi
      else
        print_error "Failed to remove marketplace configuration"
        rm -f "$cleaned_settings"
      fi

      rm -f "$cleaned_settings"
    else
      print_status "Skipping settings.json cleanup"
    fi
  else
    print_status "No settings.json found - nothing to clean"
  fi

  # Optionally remove YAML configuration files
  echo ""
  if prompt_confirmation "Remove YAML configuration files?"; then
    local files_removed=0

    if [[ -f "$MARKETPLACES_FILE" ]]; then
      rm -f "$MARKETPLACES_FILE"
      print_success "Removed: $MARKETPLACES_FILE"
      files_removed=$((files_removed + 1))
    fi

    local yaml_example="$MARKETPLACES_CONFIG_DIR/$(basename "$MARKETPLACES_EXAMPLE")"
    if [[ -f "$yaml_example" ]]; then
      rm -f "$yaml_example"
      print_success "Removed: $yaml_example"
      files_removed=$((files_removed + 1))
    fi

    if [[ $files_removed -gt 0 ]]; then
      print_success "YAML configuration files removed"
    else
      print_status "No YAML configuration files found"
    fi
  else
    print_status "YAML configuration files preserved"
  fi

  print_success "${EXT_NAME} uninstalled"
  print_status "Settings.json backups preserved at: ${CLAUDE_CONFIG_DIR}/backups/"
  return 0
}

# ============================================================================
# MAIN EXECUTION
# ============================================================================

extension_main "$@"
