#!/bin/bash
# claude-marketplace.extension - Claude Code plugin marketplace integration
# Extension API v2.0
#
# This extension installs curated plugins from marketplaces specified in a .marketplaces file.
# Each marketplace is a GitHub repository containing .claude-plugin/marketplace.json.
# Requires the claude extension to be installed first.

# Source shared extension library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$(dirname "$(dirname "$SCRIPT_DIR")")/extensions-common.sh"

# ============================================================================
# METADATA
# ============================================================================

EXT_NAME="claude-marketplace"
EXT_VERSION="2.0.0"
EXT_API_VERSION="2.0"
EXT_DESCRIPTION="Claude Code plugin marketplace integration via .marketplaces configuration file"
EXT_CATEGORY="dev-tools"
EXT_INSTALL_METHOD="native"
EXT_UPGRADE_STRATEGY="manual"

# Initialize extension environment
extension_init

# ============================================================================
# CONFIGURATION
# ============================================================================

CLAUDE_CONFIG_DIR="$HOME/.claude"
CLAUDE_SETTINGS="$CLAUDE_CONFIG_DIR/settings.json"
MARKETPLACES_FILE="/workspace/.marketplaces"

# Select appropriate example file based on CI mode
if is_ci_mode; then
  MARKETPLACES_EXAMPLE="$SCRIPT_DIR/.marketplaces.ci.example"
else
  MARKETPLACES_EXAMPLE="$SCRIPT_DIR/.marketplaces.example"
fi

# ============================================================================
# PREREQUISITES
# ============================================================================

prerequisites() {
  print_status "Checking prerequisites for ${EXT_NAME}..."

  # Hard requirement: claude extension must be installed
  if ! command_exists claude; then
    print_error "Claude CLI is required but not installed"
    print_status "Install with: extension-manager install claude"
    return 1
  fi

  print_success "Claude CLI is available"

  # Check Claude config directory exists
  if [[ ! -d "$CLAUDE_CONFIG_DIR" ]]; then
    print_error "Claude config directory not found: $CLAUDE_CONFIG_DIR"
    print_status "Run 'claude' first to initialize configuration"
    return 1
  fi

  print_success "Claude config directory exists"

  # Check for git (required for cloning plugin repositories)
  if ! command_exists git; then
    print_error "git is required but not installed"
    print_status "git is needed to clone plugin repositories"
    return 1
  fi

  print_success "All prerequisites met"
  return 0
}

# ============================================================================
# INSTALL
# ============================================================================

install() {
  print_status "Installing ${EXT_NAME}..."

  # Copy .marketplaces.example to workspace if it doesn't exist
  if [[ ! -f "/workspace/.marketplaces.example" ]]; then
    print_status "Creating .marketplaces.example template..."
    if cp "$MARKETPLACES_EXAMPLE" /workspace/.marketplaces.example; then
      print_success "Created /workspace/.marketplaces.example"
    else
      print_warning "Could not create .marketplaces.example template"
    fi
  fi

  # In CI mode, automatically create .marketplaces file from CI template
  if is_ci_mode && [[ ! -f "$MARKETPLACES_FILE" ]]; then
    print_status "CI mode: Creating .marketplaces from CI template..."
    if cp "$SCRIPT_DIR/.marketplaces.ci.example" "$MARKETPLACES_FILE"; then
      print_success "Created $MARKETPLACES_FILE from CI template (3 test marketplaces)"
    else
      print_warning "Could not create CI marketplaces file"
    fi
  fi

  # Install plugins from marketplaces specified in .marketplaces file if it exists
  if [[ -f "$MARKETPLACES_FILE" ]]; then
    print_status "Found .marketplaces file, installing marketplaces and their plugins..."
    install_marketplaces_from_file
  else
    print_status "No .marketplaces file found (optional)"
    print_status "Create $MARKETPLACES_FILE to auto-install marketplaces and plugins"
    print_status "See /workspace/.marketplaces.example for template"
  fi

  print_success "${EXT_NAME} installation complete"
  return 0
}

# ============================================================================
# HELPER FUNCTIONS
# ============================================================================

# Check if Claude is authenticated
# Returns: 0 if authenticated, 1 if not
is_claude_authenticated() {
  # Method 1: Check if ANTHROPIC_API_KEY is set
  if [[ -n "${ANTHROPIC_API_KEY:-}" ]]; then
    return 0
  fi

  # Method 2: Try to list marketplaces (requires auth)
  if command_exists claude; then
    if timeout 5s claude /plugin marketplace list >/dev/null 2>&1; then
      return 0
    fi
  fi

  return 1
}

# Wait for marketplace directory to be cloned after adding
# Args: $1 - owner/repo string (e.g., "steveyegge/beads")
# Returns: 0 if directory exists with marketplace.json, 1 if timeout
wait_for_marketplace_clone() {
  local repo="$1"
  local timeout=30  # seconds
  local interval=2  # seconds
  local elapsed=0

  while [ $elapsed -lt $timeout ]; do
    if find_marketplace_directory "$repo" >/dev/null 2>&1; then
      return 0
    fi

    sleep $interval
    elapsed=$((elapsed + interval))
  done

  return 1
}

# Find marketplace directory after it's been added
# Args: $1 - owner/repo string (e.g., "steveyegge/beads")
# Returns: full path to marketplace directory
# Exits with error if not found
find_marketplace_directory() {
  local repo="$1"
  local known_marketplaces="${CLAUDE_CONFIG_DIR}/plugins/known_marketplaces.json"

  # Method 1: Check known_marketplaces.json for installLocation
  if [[ -f "$known_marketplaces" ]]; then
    local install_location=""

    if command_exists jq; then
      # Use jq to find marketplace by repo
      install_location=$(jq -r --arg repo "$repo" '.[] | select(.source.repo == $repo) | .installLocation' "$known_marketplaces" 2>/dev/null | head -1)
    else
      # Fallback: grep for repo and extract installLocation
      # This is a simple heuristic and might not work for all cases
      local entry
      entry=$(grep -A 5 "\"repo\": \"$repo\"" "$known_marketplaces" 2>/dev/null)
      if [[ -n "$entry" ]]; then
        install_location=$(echo "$entry" | grep -o '"installLocation": "[^"]*"' | cut -d'"' -f4)
      fi
    fi

    if [[ -n "$install_location" ]] && [[ -d "$install_location" ]] && [[ -f "$install_location/.claude-plugin/marketplace.json" ]]; then
      echo "$install_location"
      return 0
    fi
  fi

  # Method 2: Try common patterns (fallback)
  local repo_basename="${repo##*/}"
  local marketplaces_dir="${CLAUDE_CONFIG_DIR}/plugins/marketplaces"

  local common_patterns=(
    "${repo_basename}-marketplace"
    "${repo_basename}"
    "${repo_basename}-plugins"
  )

  for pattern in "${common_patterns[@]}"; do
    local candidate="${marketplaces_dir}/${pattern}"
    if [[ -d "$candidate" ]] && [[ -f "$candidate/.claude-plugin/marketplace.json" ]]; then
      echo "$candidate"
      return 0
    fi
  done

  # Method 3: Fall back to finding the most recently modified directory with marketplace.json
  local newest_dir
  newest_dir=$(find "$marketplaces_dir" -mindepth 1 -maxdepth 1 -type d -exec test -f {}/.claude-plugin/marketplace.json \; -print -quit 2>/dev/null | head -1)

  if [[ -n "$newest_dir" ]] && [[ -f "$newest_dir/.claude-plugin/marketplace.json" ]]; then
    echo "$newest_dir"
    return 0
  fi

  return 1
}

# Get marketplace info from marketplace.json
# Args: $1 - marketplace directory path
# Outputs: marketplace_name and plugin_names (space-separated)
# Sets global variables: MARKETPLACE_NAME, PLUGIN_NAMES
parse_marketplace_json() {
  local marketplace_dir="$1"
  local marketplace_json="${marketplace_dir}/.claude-plugin/marketplace.json"

  if [[ ! -f "$marketplace_json" ]]; then
    return 1
  fi

  # Extract marketplace name
  if command_exists jq; then
    MARKETPLACE_NAME=$(jq -r '.name' "$marketplace_json" 2>/dev/null)
    PLUGIN_NAMES=$(jq -r '.plugins[]? | .name' "$marketplace_json" 2>/dev/null | tr '\n' ' ')
  else
    # Fallback: simple grep-based extraction
    MARKETPLACE_NAME=$(grep -o '"name"[[:space:]]*:[[:space:]]*"[^"]*"' "$marketplace_json" | head -1 | sed 's/"name"[[:space:]]*:[[:space:]]*"\([^"]*\)"/\1/')
    # Extract plugin names (skip the marketplace name itself)
    PLUGIN_NAMES=$(grep -o '"name"[[:space:]]*:[[:space:]]*"[^"]*"' "$marketplace_json" | \
      tail -n +2 | \
      sed 's/"name"[[:space:]]*:[[:space:]]*"\([^"]*\)"/\1/' | \
      tr '\n' ' ')
  fi

  [[ -n "$MARKETPLACE_NAME" ]] && [[ -n "$PLUGIN_NAMES" ]]
}

install_marketplaces_from_file() {
  local repo_count=0
  local plugin_count=0
  local installed_count=0
  local failed_count=0

  while IFS= read -r line; do
    # Skip comments and empty lines
    [[ "$line" =~ ^#.*$ ]] && continue
    [[ -z "$line" ]] && continue

    repo_count=$((repo_count + 1))
    print_status "Processing marketplace: $line"

    # Step 1: Add marketplace
    print_status "  → Adding marketplace: $line"
    local add_output
    if ! add_output=$(claude /plugin marketplace add "$line" 2>&1); then
      if echo "$add_output" | grep -qi "already"; then
        print_warning "  ⚠  Marketplace already exists: $line"
      else
        print_error "  ✗ Failed to add marketplace: $line"
        print_error "     Error: $add_output"
        failed_count=$((failed_count + 1))
        echo ""
        continue
      fi
    else
      print_success "  ✓ Marketplace added: $line"
    fi

    # Step 2: Wait for marketplace to be cloned and find directory
    print_status "  → Waiting for marketplace to be cloned..."
    if ! wait_for_marketplace_clone "$line"; then
      print_error "  ✗ Marketplace clone timeout for: $line"
      print_error "     Waited 30 seconds for clone to complete"

      # Debug: Check if marketplace was registered
      local known_marketplaces="${CLAUDE_CONFIG_DIR}/plugins/known_marketplaces.json"
      if [[ -f "$known_marketplaces" ]]; then
        print_status "     Debug: Checking known_marketplaces.json..."
        if command_exists jq; then
          local registered
          registered=$(jq -r --arg repo "$line" '.[] | select(.source.repo == $repo) | .installLocation' "$known_marketplaces" 2>/dev/null)
          if [[ -n "$registered" ]]; then
            print_status "     Registered at: $registered"
            if [[ -d "$registered" ]]; then
              print_status "     Directory exists but marketplace.json missing"
            else
              print_status "     Directory does not exist - clone may have failed"
            fi
          else
            print_status "     Not found in known_marketplaces.json"
          fi
        fi
      fi

      print_error "     Checked: ${CLAUDE_CONFIG_DIR}/plugins/marketplaces/"
      failed_count=$((failed_count + 1))
      echo ""
      continue
    fi

    # Step 3: Get marketplace directory
    print_status "  → Locating marketplace directory..."
    local marketplace_dir
    if ! marketplace_dir=$(find_marketplace_directory "$line"); then
      print_error "  ✗ Cannot find marketplace directory for: $line"
      print_error "     Checked: ${CLAUDE_CONFIG_DIR}/plugins/marketplaces/"
      failed_count=$((failed_count + 1))
      echo ""
      continue
    fi
    print_success "  ✓ Found: $marketplace_dir"

    # Step 4: Parse marketplace.json
    print_status "  → Parsing marketplace.json..."
    local MARKETPLACE_NAME=""
    local PLUGIN_NAMES=""

    if ! parse_marketplace_json "$marketplace_dir"; then
      print_error "  ✗ Failed to parse marketplace.json from: $marketplace_dir"
      print_error "     Missing or invalid: $marketplace_dir/.claude-plugin/marketplace.json"
      failed_count=$((failed_count + 1))
      echo ""
      continue
    fi

    print_success "  ✓ Marketplace name: $MARKETPLACE_NAME"
    print_status "  → Plugins found: $PLUGIN_NAMES"

    # Step 5: Install each plugin from the marketplace
    for plugin_name in $PLUGIN_NAMES; do
      plugin_count=$((plugin_count + 1))
      print_status "  → Installing plugin: ${plugin_name}@${MARKETPLACE_NAME}"

      local install_output
      if install_output=$(timeout 30s claude /plugin install "${plugin_name}@${MARKETPLACE_NAME}" 2>&1); then
        if echo "$install_output" | grep -qE "(Successfully installed|already installed)"; then
          print_success "  ✓ Installed: ${plugin_name}"
          installed_count=$((installed_count + 1))
        else
          print_warning "  ✗ Failed to install: ${plugin_name}"
          print_warning "     Output: $install_output"
          failed_count=$((failed_count + 1))
        fi
      else
        print_warning "  ✗ Installation timed out: ${plugin_name}"
        failed_count=$((failed_count + 1))
      fi
    done

    echo ""
  done < "$MARKETPLACES_FILE"

  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  print_status "Plugin installation summary:"
  echo "  Marketplaces processed: $repo_count"
  echo "  Total plugins: $plugin_count"
  echo "  Successfully installed: $installed_count"
  echo "  Failed: $failed_count"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

  if [ "$failed_count" -gt 0 ]; then
    print_warning "Some plugins failed to install"
  else
    print_success "All plugins installed successfully"
  fi
}

# ============================================================================
# CONFIGURE
# ============================================================================

configure() {
  print_status "Configuring ${EXT_NAME}..."

  # In CI mode, ensure .marketplaces file exists and install marketplaces/plugins
  # This handles the case where extension was pre-installed
  if is_ci_mode; then
    if [[ ! -f "$MARKETPLACES_FILE" ]]; then
      print_status "CI mode: Creating .marketplaces from CI template..."
      if cp "$SCRIPT_DIR/.marketplaces.ci.example" "$MARKETPLACES_FILE"; then
        print_success "Created $MARKETPLACES_FILE from CI template (3 test marketplaces)"
      else
        print_warning "Could not create CI marketplaces file"
      fi
    fi

    # Check if Claude is authenticated before attempting plugin installation
    if [[ -f "$MARKETPLACES_FILE" ]]; then
      if is_claude_authenticated; then
        print_status "CI mode: Claude authenticated, installing marketplaces from .marketplaces file..."
        install_marketplaces_from_file
      else
        echo ""
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        print_warning "Claude is not authenticated - skipping plugin installation"
        echo ""
        echo "Plugin installation requires Claude Code authentication."
        echo "To enable plugin installation in CI:"
        echo "  1. Set ANTHROPIC_API_KEY as a repository secret"
        echo "  2. Pass it to the workflow:"
        echo "     env:"
        echo "       ANTHROPIC_API_KEY: \${{ secrets.ANTHROPIC_API_KEY }}"
        echo ""
        echo "The marketplace will still be configured, but plugins"
        echo "will need to be installed manually or in an authenticated context."
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo ""
      fi
    fi
  fi

  # Verify marketplace is accessible
  print_status "Verifying marketplace configuration..."
  if command_exists claude; then
    # List marketplaces to verify configuration
    if claude /plugin marketplace list >/dev/null 2>&1; then
      print_success "Claude plugin system is operational"
    else
      print_warning "Could not verify plugin system (may be normal)"
    fi
  fi

  # Create SSH wrapper for claude command if not already created by claude extension
  if command_exists create_tool_wrapper 2>/dev/null; then
    if command_exists claude; then
      local claude_path
      claude_path=$(which claude)
      create_tool_wrapper "claude" "$claude_path"
      print_success "Created SSH wrapper for claude"
    fi
  fi

  print_success "${EXT_NAME} configuration complete"
  print_status "Plugins can be managed with: claude /plugin"
  return 0
}

# ============================================================================
# VALIDATE
# ============================================================================

validate() {
  print_status "Validating ${EXT_NAME} installation..."

  local all_valid=true

  # Check claude command exists
  if ! command_exists claude; then
    print_error "claude command not found"
    all_valid=false
  else
    print_success "claude command available"
  fi

  # Check settings file exists
  if [[ -f "$CLAUDE_SETTINGS" ]]; then
    print_success "Claude settings file exists"
  else
    print_warning "Claude settings file not found (will be created on first use)"
  fi

  # Check .marketplaces.example exists
  if [[ -f "/workspace/.marketplaces.example" ]]; then
    print_success "Marketplaces template exists: /workspace/.marketplaces.example"
  else
    print_warning "Marketplaces template not found"
  fi

  # Test plugin system access
  if command_exists claude; then
    if timeout 5s claude /plugin marketplace list >/dev/null 2>&1; then
      print_success "Plugin marketplace accessible"
    else
      print_warning "Could not access plugin marketplace (may need authentication)"
    fi
  fi

  # Check for git (runtime dependency)
  if ! command_exists git; then
    print_error "git not found (required for plugin installation)"
    all_valid=false
  fi

  # Verify plugins were installed in CI mode
  if is_ci_mode; then
    print_status "CI mode: Verifying plugin installation..."

    # Check .marketplaces file exists
    if [[ ! -f "$MARKETPLACES_FILE" ]]; then
      print_error ".marketplaces file not found (expected in CI mode)"
      all_valid=false
    else
      print_success ".marketplaces file exists"

      # Count expected plugins by parsing marketplace JSONs
      local expected_count=0
      local marketplace_count=0
      while IFS= read -r line; do
        [[ "$line" =~ ^#.*$ ]] && continue
        [[ -z "$line" ]] && continue

        marketplace_count=$((marketplace_count + 1))

        # Find marketplace directory
        local marketplace_dir
        if marketplace_dir=$(find_marketplace_directory "$line"); then
          # Parse marketplace.json
          local MARKETPLACE_NAME=""
          local PLUGIN_NAMES=""
          if parse_marketplace_json "$marketplace_dir"; then
            local plugin_count_for_marketplace
            plugin_count_for_marketplace=$(echo "$PLUGIN_NAMES" | wc -w | tr -d ' ')
            expected_count=$((expected_count + plugin_count_for_marketplace))
          else
            print_warning "Could not parse marketplace.json for: $line"
            # Assume 1 plugin if we can't parse
            expected_count=$((expected_count + 1))
          fi
        else
          print_warning "Marketplace directory not found for: $line"
          # Assume 1 plugin if marketplace not found
          expected_count=$((expected_count + 1))
        fi
      done < "$MARKETPLACES_FILE"

      print_status "Expected plugins from $marketplace_count marketplaces: $expected_count"

      # Check if Claude is authenticated
      if ! is_claude_authenticated; then
        print_warning "Claude not authenticated - plugin installation was skipped"
        print_status "Set ANTHROPIC_API_KEY to enable plugin installation testing"
        # Don't fail validation if not authenticated - this is expected behavior
      else
        # List installed plugins only if authenticated
        if command_exists claude; then
          print_status "Listing installed plugins..."
          if timeout 10s claude /plugin list 2>&1 | tee /tmp/plugins.txt; then
            # Count installed plugins (look for plugin names, not necessarily with /)
            # The output format may vary, so count non-empty, non-header lines
            installed_count=$(grep -v '^$' /tmp/plugins.txt | grep -v -i "installed plugins" | wc -l | tr -d ' ')
            echo "  Installed count: $installed_count"

            if [ "$installed_count" -ge "$expected_count" ]; then
              print_success "All expected plugins installed ($installed_count/$expected_count)"
            else
              print_error "Expected at least $expected_count plugins, found $installed_count"
              echo "Plugin list output:"
              cat /tmp/plugins.txt || true
              all_valid=false
            fi
          else
            print_error "Could not list plugins"
            all_valid=false
          fi
        fi
      fi
    fi
  fi

  if [[ "$all_valid" == "true" ]]; then
    print_success "Validation passed"
    return 0
  else
    print_error "Validation failed"
    return 1
  fi
}

# ============================================================================
# STATUS
# ============================================================================

status() {
  print_extension_header

  # Check dependency
  if ! command_exists claude; then
    echo "Status: ✗ NOT INSTALLED (claude dependency missing)"
    return 1
  fi

  # Check if Claude has any known marketplaces registered
  local known_marketplaces_file="${CLAUDE_CONFIG_DIR}/plugins/known_marketplaces.json"

  if [[ ! -f "$known_marketplaces_file" ]]; then
    echo "Status: ✗ NOT INSTALLED (no marketplaces registered)"
    return 1
  fi

  # If .marketplaces file exists, verify all marketplaces are registered
  if [[ -f "$MARKETPLACES_FILE" ]]; then
    local all_registered=true
    local missing_marketplaces=""

    while IFS= read -r line; do
      # Skip comments and empty lines
      [[ "$line" =~ ^#.*$ ]] && continue
      [[ -z "$line" ]] && continue

      # Check if this marketplace (owner/repo format) is in known_marketplaces.json
      local repo="$line"

      # Use jq to check if any entry has source.repo matching this line
      if command_exists jq; then
        if ! jq -e --arg repo "$repo" '.[] | select(.source.repo == $repo)' "$known_marketplaces_file" >/dev/null 2>&1; then
          all_registered=false
          missing_marketplaces="${missing_marketplaces}${repo}\n"
        fi
      else
        # Fallback: simple grep check
        if ! grep -q "\"$repo\"" "$known_marketplaces_file"; then
          all_registered=false
          missing_marketplaces="${missing_marketplaces}${repo}\n"
        fi
      fi
    done < "$MARKETPLACES_FILE"

    if [[ "$all_registered" != "true" ]]; then
      echo "Status: ✗ NOT FULLY INSTALLED (missing marketplaces)"
      if [[ -n "$missing_marketplaces" ]]; then
        echo "Missing:"
        echo -e "$missing_marketplaces" | grep -v '^$' | sed 's/^/  - /'
      fi
      return 1
    fi
  fi

  echo "Status: ✓ INSTALLED"
  echo ""

  # Show registered marketplaces
  if command_exists claude; then
    print_status "Registered marketplaces:"
    if timeout 5s claude /plugin marketplace list 2>/dev/null; then
      echo ""
    else
      echo "  (unable to retrieve - may need authentication)"
      echo ""
    fi
  fi

  # Show .marketplaces file status
  print_status "Marketplaces configuration:"
  if [[ -f "$MARKETPLACES_FILE" ]]; then
    echo "  .marketplaces file: ✓ exists"
    local count
    count=$(grep -v '^#' "$MARKETPLACES_FILE" | grep -v '^$' | wc -l | tr -d ' ')
    echo "  Marketplaces specified: $count"
  else
    echo "  .marketplaces file: ✗ not found"
    echo "  Template: /workspace/.marketplaces.example"
  fi
  echo ""

  # Show available commands
  print_status "Available commands:"
  echo "  • claude /plugin                      - Browse and install plugins"
  echo "  • claude /plugin marketplace list     - List marketplaces"
  echo "  • claude /plugin marketplace add      - Add marketplace"
  echo "  • claude /plugin list                 - List installed plugins"
  echo "  • claude /plugin install <name>       - Install plugin"
  echo ""

  # Show config file location
  print_status "Configuration:"
  echo "  Settings: $CLAUDE_SETTINGS"
  echo "  Marketplaces file: $MARKETPLACES_FILE"

  return 0
}

# ============================================================================
# UPGRADE - Extension API v2.0
# ============================================================================

upgrade() {
  print_status "Upgrading ${EXT_NAME}..."

  # Re-sync marketplaces and plugins from .marketplaces file
  if [[ -f "$MARKETPLACES_FILE" ]]; then
    print_status "Re-syncing marketplaces and plugins from .marketplaces file..."
    install_marketplaces_from_file
  else
    print_status "No .marketplaces file found - nothing to upgrade"
  fi

  print_success "${EXT_NAME} upgraded successfully"
  return 0
}

# ============================================================================
# REMOVE
# ============================================================================

remove() {
  print_warning "Uninstalling ${EXT_NAME}..."

  # Optionally remove plugins from marketplaces
  if [[ -f "$MARKETPLACES_FILE" ]]; then
    echo ""
    if prompt_confirmation "Remove all plugins from marketplaces in .marketplaces file?"; then
      print_status "Uninstalling plugins from marketplaces..."
      local plugin_count=0
      local removed_count=0
      local failed_count=0

      while IFS= read -r line; do
        # Skip comments and empty lines
        [[ "$line" =~ ^#.*$ ]] && continue
        [[ -z "$line" ]] && continue

        print_status "Processing marketplace: $line"

        # Find marketplace directory
        local marketplace_dir
        if ! marketplace_dir=$(find_marketplace_directory "$line"); then
          print_warning "  ⚠  Cannot find marketplace directory for: $line"
          continue
        fi

        # Parse marketplace.json
        local MARKETPLACE_NAME=""
        local PLUGIN_NAMES=""
        if ! parse_marketplace_json "$marketplace_dir"; then
          print_warning "  ⚠  Cannot parse marketplace.json for: $line"
          continue
        fi

        print_status "  → Found plugins in $MARKETPLACE_NAME: $PLUGIN_NAMES"

        # Uninstall each plugin
        for plugin_name in $PLUGIN_NAMES; do
          plugin_count=$((plugin_count + 1))
          print_status "  → Uninstalling plugin: ${plugin_name}"

          if claude /plugin uninstall "${plugin_name}" 2>&1; then
            print_success "  ✓ Uninstalled: ${plugin_name}"
            removed_count=$((removed_count + 1))
          else
            print_warning "  ✗ Failed to uninstall: ${plugin_name}"
            failed_count=$((failed_count + 1))
          fi
        done

        echo ""
      done < "$MARKETPLACES_FILE"

      echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      print_status "Plugin removal summary:"
      echo "  Total plugins: $plugin_count"
      echo "  Successfully removed: $removed_count"
      echo "  Failed: $failed_count"
      echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    else
      print_status "Skipping plugin removal"
    fi
  else
    print_status "No .marketplaces file found - no plugins to remove"
  fi

  # Optionally remove .marketplaces files
  echo ""
  if prompt_confirmation "Remove .marketplaces and .marketplaces.example files?"; then
    rm -f "$MARKETPLACES_FILE" /workspace/.marketplaces.example
    print_success "Marketplaces configuration files removed"
  else
    print_status "Marketplaces configuration files preserved"
  fi

  print_success "${EXT_NAME} uninstalled"
  return 0
}

# ============================================================================
# MAIN EXECUTION
# ============================================================================

extension_main "$@"
