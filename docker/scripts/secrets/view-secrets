#!/bin/bash
#
# view-secrets - View decrypted secrets
#
# This command decrypts and displays the contents of the encrypted secrets file.
# Secrets are stored in ~/.secrets/secrets.enc.yaml and encrypted with SOPS + age.
#
# Usage:
#   view-secrets
#
# Exit codes:
#   0 - Success
#   1 - Secrets file not found or decryption failed
#

set -euo pipefail

# Configuration
SECRETS_FILE="${HOME}/.secrets/secrets.enc.yaml"
AGE_KEY_FILE="${HOME}/.age/key.txt"

# Check if secrets file exists
if [ ! -f "$SECRETS_FILE" ]; then
    echo "No secrets file found at $SECRETS_FILE"
    exit 1
fi

# Check if age key exists
if [ ! -f "$AGE_KEY_FILE" ]; then
    echo "Age encryption key not found at $AGE_KEY_FILE"
    exit 1
fi

# Decrypt and display secrets
if ! SOPS_AGE_KEY_FILE="$AGE_KEY_FILE" sops --decrypt "$SECRETS_FILE" 2>/dev/null; then
    echo "Failed to decrypt secrets file"
    exit 1
fi
