#!/bin/bash
#
# load-secrets - Load secrets into current shell environment
#
# This command decrypts secrets and exports them as environment variables
# in the CURRENT SHELL ONLY. To use this command, you must source it:
#
#   source load-secrets
#   OR
#   . load-secrets
#
# Usage:
#   source load-secrets
#
# Exit codes:
#   0 - Success
#   1 - Secrets file not found or decryption failed
#
# Note: If called directly (not sourced), it will print a warning and
# display what would be loaded, but won't modify the environment.
#

# Check if being sourced
if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
    cat << 'EOF'
⚠️  Warning: This script should be sourced, not executed directly.

To load secrets into your current shell, use:
    source load-secrets
    OR
    . load-secrets

Showing what would be loaded (environment not modified):
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
EOF
    # Show secrets but don't export them
    source "${HOME}/.secrets/lib.sh" 2>/dev/null || exit 1
    if [ -f "${HOME}/.secrets/secrets.enc.yaml" ]; then
        SOPS_AGE_KEY_FILE="${HOME}/.age/key.txt" sops --decrypt "${HOME}/.secrets/secrets.enc.yaml" 2>/dev/null | \
        while IFS=': ' read -r key value; do
            [[ "$key" =~ ^#.*$ || -z "$key" ]] && continue
            echo "  export ${key}=<value hidden>"
        done
    fi
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    exit 1
fi

# Being sourced - actually load secrets
source "${HOME}/.secrets/lib.sh" 2>/dev/null || return 1
load_secrets
