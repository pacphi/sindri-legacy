#!/bin/bash
#
# edit-secrets - Edit encrypted secrets
#
# This command opens the encrypted secrets file in your default editor (SOPS handles
# transparent decryption/encryption). Changes are automatically encrypted when you save.
#
# Usage:
#   edit-secrets
#
# Environment variables:
#   EDITOR - Editor to use (defaults to vim)
#
# Exit codes:
#   0 - Success
#   1 - Age key not found or SOPS failed
#

set -euo pipefail

# Configuration
SECRETS_FILE="${HOME}/.secrets/secrets.enc.yaml"
AGE_KEY_FILE="${HOME}/.age/key.txt"

# Check if age key exists
if [ ! -f "$AGE_KEY_FILE" ]; then
    echo "Age encryption key not found at $AGE_KEY_FILE"
    echo "Run the secrets setup first"
    exit 1
fi

# Create secrets file if it doesn't exist
if [ ! -f "$SECRETS_FILE" ]; then
    echo "Creating new secrets file..."
    mkdir -p "$(dirname "$SECRETS_FILE")"
    echo "# Encrypted secrets managed by SOPS + age" > "$SECRETS_FILE.tmp"

    # Get age public key for encryption
    age_recipient=$(grep '^# public key:' "$AGE_KEY_FILE" | cut -d':' -f2 | tr -d ' ')

    # Encrypt the template
    if ! SOPS_AGE_KEY_FILE="$AGE_KEY_FILE" \
         SOPS_AGE_RECIPIENTS="$age_recipient" \
         sops --encrypt --input-type=yaml --output-type=yaml --age "$age_recipient" \
              "$SECRETS_FILE.tmp" > "$SECRETS_FILE" 2>/dev/null; then
        echo "Failed to create encrypted secrets file"
        rm -f "$SECRETS_FILE.tmp"
        exit 1
    fi

    rm -f "$SECRETS_FILE.tmp"
    chmod 600 "$SECRETS_FILE"
fi

# Edit secrets file with SOPS
SOPS_AGE_KEY_FILE="$AGE_KEY_FILE" sops "$SECRETS_FILE"
