#!/bin/bash
#
# with-secrets - Run command with secrets loaded in environment
#
# This command decrypts secrets and runs the specified command with them
# available as environment variables. The secrets are only available to
# the command being executed and don't persist after it completes.
#
# Usage:
#   with-secrets <command> [args...]
#
# Examples:
#   with-secrets env | grep API_KEY
#   with-secrets claude
#   with-secrets npm run deploy
#
# Exit codes:
#   0 - Success
#   1 - Secrets file not found, decryption failed, or no command provided
#   * - Exit code of the executed command
#

set -euo pipefail

# Configuration
SECRETS_FILE="${HOME}/.secrets/secrets.enc.yaml"
AGE_KEY_FILE="${HOME}/.age/key.txt"

# Check for command argument
if [ $# -eq 0 ]; then
    cat << 'EOF'
Usage: with-secrets <command> [args...]

Run a command with secrets loaded as environment variables.

Examples:
    with-secrets env | grep API_KEY
    with-secrets claude
    with-secrets npm run deploy

The secrets are only available to the command being executed.
EOF
    exit 1
fi

# Check if secrets file exists
if [ ! -f "$SECRETS_FILE" ]; then
    echo "No secrets file found at $SECRETS_FILE"
    exit 1
fi

# Check if age key exists
if [ ! -f "$AGE_KEY_FILE" ]; then
    echo "Age encryption key not found at $AGE_KEY_FILE"
    exit 1
fi

# Source the secrets library
# shellcheck disable=SC1091
source "${HOME}/.secrets/lib.sh" 2>/dev/null || {
    echo "Failed to load secrets library"
    exit 1
}

# Run command with secrets loaded
with_secrets "$@"
