name: Quick Checks

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read

jobs:
  # ============================================================================
  # Detect Changed Files
  # ============================================================================

  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      docs_changed: ${{ steps.filter.outputs.docs_changed }}
      core_system: ${{ steps.filter.outputs.core_system }}
      extensions_changed: ${{ steps.filter.outputs.extensions_changed }}
      changed_extensions: ${{ steps.extensions.outputs.list }}
      only_docs: ${{ steps.compute-only-docs.outputs.only_docs }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 2

      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            docs_changed:
              - '**/*.md'
              - 'docs/**'
            core_system:
              - 'Dockerfile'
              - 'fly.toml'
              - 'docker/lib/extension-manager.sh'
              - 'docker/lib/common.sh'
              - 'docker/lib/extensions-common.sh'
              - 'docker/lib/upgrade-history.sh'
              - 'docker/lib/upgrade-notifier.sh'
              - '.github/workflows/**'
              - '.github/actions/**'
            extensions_changed:
              - 'docker/lib/extensions.d/**'

      - name: Identify changed extensions
        id: extensions
        if: steps.filter.outputs.extensions_changed == 'true'
        run: |
          # Get list of changed extension files
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi

          # Extract unique extension names from changed files
          EXTENSIONS=$(echo "$CHANGED_FILES" | \
            grep 'docker/lib/extensions.d/' | \
            grep -E '\.(extension|toml)$' | \
            sed 's|docker/lib/extensions.d/||' | \
            sed 's|/.*||' | \
            sort -u | \
            tr '\n' ' ')

          echo "Changed extensions: $EXTENSIONS"
          echo "list=$EXTENSIONS" >> $GITHUB_OUTPUT

      - name: Compute only-docs flag
        id: compute-only-docs
        run: |
          # Only docs changed if docs were changed AND neither core system nor extensions changed
          DOCS_CHANGED="${{ steps.filter.outputs.docs_changed }}"
          CORE_CHANGED="${{ steps.filter.outputs.core_system }}"
          EXTS_CHANGED="${{ steps.filter.outputs.extensions_changed }}"

          if [ "$DOCS_CHANGED" = "true" ] && [ "$CORE_CHANGED" != "true" ] && [ "$EXTS_CHANGED" != "true" ]; then
            echo "only_docs=true" >> $GITHUB_OUTPUT
            echo "Only documentation files changed"
          else
            echo "only_docs=false" >> $GITHUB_OUTPUT
            echo "Code or configuration files changed"
          fi

      - name: Log detection results
        run: |
          echo "## Change Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Docs Changed**: ${{ steps.filter.outputs.docs_changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Core System Changed**: ${{ steps.filter.outputs.core_system }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Extensions Changed**: ${{ steps.filter.outputs.extensions_changed }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.filter.outputs.extensions_changed }}" = "true" ]; then
            echo "- **Changed Extensions**: ${{ steps.extensions.outputs.list }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**→ Only Docs Changed**: ${{ steps.compute-only-docs.outputs.only_docs }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Fast Validation (Always Run Unless Docs-Only)
  # ============================================================================

  shellcheck:
    name: Shellcheck
    needs: detect-changes
    if: needs.detect-changes.outputs.only_docs != 'true'
    uses: ./.github/workflows/shellcheck-validation.yml

  yaml-validation:
    name: YAML Validation
    needs: detect-changes
    if: needs.detect-changes.outputs.only_docs != 'true'
    uses: ./.github/workflows/yaml-validation.yml

  extension-manager:
    name: Extension Manager
    needs: detect-changes
    if: needs.detect-changes.outputs.only_docs != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Extension manager validation
        run: |
          echo "Validating extension manager..."

          if [[ ! -x "docker/lib/extension-manager.sh" ]]; then
            echo "❌ Extension manager script not found or not executable"
            exit 1
          fi

          for ext in docker/lib/extensions.d/*.extension docker/lib/extensions.d/*/*.extension; do
            if [[ -f "$ext" ]]; then
              if ! grep -q "extension_init" "$ext"; then
                echo "⚠️  Missing extension_init in $ext"
              fi
            fi
          done

          echo "✅ Extension manager validation passed"

  # ============================================================================
  # Test Changed Extensions (Only If Extensions Changed)
  # ============================================================================

  test-changed-extensions:
    name: Test Changed Extensions
    needs: detect-changes
    if: needs.detect-changes.outputs.extensions_changed == 'true' && needs.detect-changes.outputs.changed_extensions != ''
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Report changed extensions
        run: |
          echo "## Changed Extensions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following extensions have changed and will be tested:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for ext in ${{ needs.detect-changes.outputs.changed_extensions }}; do
            echo "- \`$ext\`" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note**: Full extension testing will be performed via the single-extension-test workflow." >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Summary
  # ============================================================================

  summary:
    name: Quick Checks Summary
    if: always()
    needs: [detect-changes, shellcheck, yaml-validation, extension-manager, test-changed-extensions]
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "## Quick Checks Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.detect-changes.outputs.only_docs }}" = "true" ]; then
            echo "✅ **Documentation-only changes detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No code validation or testing required." >> $GITHUB_STEP_SUMMARY
          else
            echo "### Validation Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Shellcheck**: ${{ needs.shellcheck.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- **YAML Validation**: ${{ needs.yaml-validation.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Extension Manager**: ${{ needs.extension-manager.result }}" >> $GITHUB_STEP_SUMMARY

            if [ "${{ needs.detect-changes.outputs.extensions_changed }}" = "true" ]; then
              echo "- **Changed Extensions**: ${{ needs.test-changed-extensions.result }}" >> $GITHUB_STEP_SUMMARY
            fi

            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "${{ needs.detect-changes.outputs.core_system }}" = "true" ]; then
              echo "⚠️  **Core system changes detected** - Full test suite will run via extension-tests workflow" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.detect-changes.outputs.extensions_changed }}" = "true" ]; then
              echo "ℹ️  **Extension changes detected** - Targeted testing recommended" >> $GITHUB_STEP_SUMMARY
            else
              echo "✅ **No core system or extension changes** - Quick checks completed" >> $GITHUB_STEP_SUMMARY
            fi
          fi
