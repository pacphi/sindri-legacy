name: Developer Workflow Test

on:
  workflow_call:
    inputs:
      test_app_prefix:
        description: "Test app prefix"
        required: false
        default: "sindri-ci-test"
        type: string
      region:
        description: "Fly.io region"
        required: false
        default: "sjc"
        type: string
      skip_cleanup:
        description: "Skip cleanup for debugging"
        required: false
        default: false
        type: boolean
      pre_built_image:
        description: "Pre-built Docker image URL (optional)"
        required: false
        default: ""
        type: string
    secrets:
      FLYIO_AUTH_TOKEN:
        required: true
      ANTHROPIC_API_KEY:
        required: false

permissions:
  contents: read

jobs:
  developer-workflow:
    name: Developer Workflow Integration
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: read
    # Only run on workflow_dispatch or when explicitly requested
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[test-workflow]')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      # Using composite action for setup
      - name: Setup Fly.io test environment
        id: setup
        uses: ./.github/actions/setup-fly-test-env
        with:
          app-prefix: ${{ inputs.test_app_prefix }}
          extension-name: "workflow"
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}
          region: ${{ inputs.region }}
          vm-memory: "2048"
          vm-cpu-kind: "shared"
          vm-cpu-count: "1"
          volume-size: "10"

      # Using composite action for deployment
      - name: Deploy test environment
        uses: ./.github/actions/deploy-fly-app
        with:
          app-name: ${{ steps.setup.outputs.app-name }}
          region: ${{ inputs.region }}
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}
          deploy-timeout: "300"
          pre-built-image: ${{ inputs.pre_built_image }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          ci-mode: "true"

      # Using composite action for waiting
      - name: Wait for deployment
        uses: ./.github/actions/wait-fly-deployment
        with:
          app-name: ${{ steps.setup.outputs.app-name }}
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}
          timeout-seconds: "240"
          expected-status: "started"

      - name: Add core extensions to manifest
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          # Source retry utilities
          source .github/scripts/common/ssh-helpers.sh

          app_name="${{ steps.setup.outputs.app-name }}"

          echo "Verifying base system components..."
          # Execute with retry
          ssh_command_retry "$app_name" "/bin/bash -lc '
            cd /workspace/scripts/lib
            manifest_file=\"extensions.d/active-extensions.conf\"

            # Create manifest from CI template if needed
            if [ ! -f \"\$manifest_file\" ]; then
              cp extensions.d/active-extensions.ci.conf \"\$manifest_file\" 2>/dev/null || touch \"\$manifest_file\"
            fi

            echo \"\"
            echo \"=== Manifest Contents ===\"
            grep -v \"^[[:space:]]*#\" \"\$manifest_file\" | grep -v \"^[[:space:]]*$\" || echo \"(empty)\"

            # Verify base system components are available
            echo \"\"
            echo \"Verifying base system components...\"

            if command -v mise &> /dev/null; then
              echo \"✅ mise package manager available\"
            else
              echo \"❌ mise package manager not available\"
              exit 1
            fi

            if command -v claude &> /dev/null; then
              echo \"✅ claude CLI available\"
            else
              echo \"❌ claude CLI not available\"
              exit 1
            fi

            if [ -f /etc/profile.d/00-ssh-environment.sh ]; then
              echo \"✅ SSH environment configured\"
            else
              echo \"❌ SSH environment not configured\"
              exit 1
            fi
          '"

      - name: Install all extensions from manifest
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          # Source retry utilities
          source .github/scripts/common/ssh-helpers.sh

          app_name="${{ steps.setup.outputs.app-name }}"

          echo "Installing all activated extensions..."
          # Execute with retry
          ssh_command_retry "$app_name" "/bin/bash -lc '
            cd /workspace/scripts/lib

            echo \"Running install-all...\"
            if bash extension-manager.sh install-all; then
              echo \"✅ All extensions installed\"
            else
              echo \"❌ Extension installation failed\"
              exit 1
            fi
          '"

      - name: Verify all extensions installed correctly
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          # Source retry utilities
          source .github/scripts/common/ssh-helpers.sh

          app_name="${{ steps.setup.outputs.app-name }}"

          echo "Verifying extension installations..."
          # Execute with retry
          ssh_command_retry "$app_name" "/bin/bash -lc '
            # Source SSH environment
            if [ -f /etc/profile.d/00-ssh-environment.sh ]; then
              source /etc/profile.d/00-ssh-environment.sh
            fi

            echo \"=== Verification ===\"

            # Verify workspace structure (multi-project design)
            if [ -d /workspace/projects ] && [ -d /workspace/scripts ]; then
              echo \"✅ Workspace structure created\"
            else
              echo \"❌ Workspace structure missing\"
              exit 1
            fi

            # Verify Node.js
            if command -v node >/dev/null 2>&1; then
              echo \"✅ Node.js installed: \$(node --version)\"
            else
              echo \"❌ Node.js not found\"
              exit 1
            fi

            # Verify SSH environment
            if [ -f /etc/profile.d/00-ssh-environment.sh ]; then
              echo \"✅ SSH environment configured\"
            else
              echo \"❌ SSH environment not configured\"
              exit 1
            fi

            echo \"\"
            echo \"✅ All extensions verified\"
          '"

      - name: Test extension status command
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          # Source retry utilities
          source .github/scripts/common/ssh-helpers.sh

          app_name="${{ steps.setup.outputs.app-name }}"

          echo "Testing extension status command..."
          # Execute with retry
          ssh_command_retry "$app_name" "/bin/bash -lc '
            cd /workspace/scripts/lib

            echo \"\"
            echo \"Checking status of nodejs...\"
            if bash extension-manager.sh status nodejs; then
              echo \"✅ Status command works for nodejs\"
            else
              echo \"⚠️  Status command failed for nodejs\"
              exit 1
            fi
          '"

      # Using composite action for cleanup
      - name: Cleanup test resources
        if: always() && !inputs.skip_cleanup
        uses: ./.github/actions/cleanup-fly-app
        with:
          app-name: ${{ steps.setup.outputs.app-name }}
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}
