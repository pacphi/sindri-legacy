name: Test Extensions Metadata

on:
  workflow_call:
    inputs:
      test_app_prefix:
        description: "Test app prefix"
        required: false
        default: "ext-test"
        type: string
      region:
        description: "Fly.io region"
        required: false
        default: "sjc"
        type: string
      skip_cleanup:
        description: "Skip cleanup for debugging"
        required: false
        default: false
        type: boolean
      pre_built_image:
        description: "Pre-built Docker image URL (optional)"
        required: false
        default: ""
        type: string
    secrets:
      FLYIO_AUTH_TOKEN:
        required: true

permissions:
  contents: read

jobs:
  test-extensions-metadata:
    name: Verify Extension API v2.0 Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Verify all extensions have upgrade()
        run: |
          MISSING=0
          for ext in docker/lib/extensions.d/*/*.extension; do
            [[ "$(basename "$ext")" == "template.extension" ]] && continue
            if ! grep -q "^upgrade()" "$ext"; then
              echo "✗ Missing upgrade(): $ext"
              MISSING=$((MISSING + 1))
            else
              echo "✓ Has upgrade(): $ext"
            fi
          done
          if [ $MISSING -gt 0 ]; then
            echo "ERROR: $MISSING extensions missing upgrade() function"
            exit 1
          fi
          echo "SUCCESS: All extensions have upgrade() function"

      - name: Verify all extensions have metadata
        run: |
          MISSING=0
          for ext in docker/lib/extensions.d/*/*.extension; do
            [[ "$(basename "$ext")" == "template.extension" ]] && continue
            if ! grep -q "^EXT_INSTALL_METHOD=" "$ext"; then
              echo "✗ Missing EXT_INSTALL_METHOD: $ext"
              MISSING=$((MISSING + 1))
            fi
            if ! grep -q "^EXT_UPGRADE_STRATEGY=" "$ext"; then
              echo "✗ Missing EXT_UPGRADE_STRATEGY: $ext"
              MISSING=$((MISSING + 1))
            fi
            if ! grep -q "^EXT_API_VERSION=" "$ext"; then
              echo "✗ Missing EXT_API_VERSION: $ext"
              MISSING=$((MISSING + 1))
            fi
          done
          if [ $MISSING -gt 0 ]; then
            echo "ERROR: $MISSING metadata fields missing"
            exit 1
          fi
          echo "SUCCESS: All extensions have required metadata"

      - name: Verify Extension API compatibility
        run: |
          REQUIRED_API_VERSION="2.0"
          INVALID=0

          for ext in docker/lib/extensions.d/*/*.extension; do
            [[ "$(basename "$ext")" == "template.extension" ]] && continue

            # Extract metadata
            EXT_VERSION=$(grep "^EXT_VERSION=" "$ext" | cut -d'"' -f2)
            API_VERSION=$(grep "^EXT_API_VERSION=" "$ext" | cut -d'"' -f2)

            # Validate API version matches required (2.0)
            if [[ "$API_VERSION" != "$REQUIRED_API_VERSION" ]]; then
              echo "✗ Incompatible API: $ext (API v$API_VERSION, expected v$REQUIRED_API_VERSION)"
              INVALID=$((INVALID + 1))
              continue
            fi

            # Validate extension version format (MAJOR.MINOR.PATCH or MAJOR.MINOR.PATCH-prerelease)
            if [[ ! "$EXT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]]; then
              echo "✗ Invalid version format: $ext (version: $EXT_VERSION)"
              INVALID=$((INVALID + 1))
              continue
            fi

            # Extract MAJOR version from extension version
            MAJOR_VERSION=$(echo "$EXT_VERSION" | cut -d'.' -f1)

            # Ensure extension MAJOR version matches API MAJOR version
            API_MAJOR=$(echo "$API_VERSION" | cut -d'.' -f1)
            if [[ "$MAJOR_VERSION" != "$API_MAJOR" ]]; then
              echo "✗ Version mismatch: $ext (extension v$EXT_VERSION, API v$API_VERSION)"
              INVALID=$((INVALID + 1))
              continue
            fi

            echo "✓ $ext: v$EXT_VERSION (API v$API_VERSION)"
          done

          if [ $INVALID -gt 0 ]; then
            echo ""
            echo "ERROR: $INVALID extensions have incompatible versions"
            exit 1
          fi

          echo ""
          echo "SUCCESS: All extensions are compatible with Extension API v$REQUIRED_API_VERSION"
