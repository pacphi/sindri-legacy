name: Single Extension Test

on:
  workflow_call:
    inputs:
      extension_name:
        description: "Extension name to test (required)"
        required: true
        type: string
      test_app_prefix:
        description: "Test app prefix"
        required: false
        default: "single-ext-test"
        type: string
      region:
        description: "Fly.io region"
        required: false
        default: "sjc"
        type: string
      skip_cleanup:
        description: "Skip cleanup for debugging"
        required: false
        default: false
        type: boolean
      pre_built_image:
        description: "Pre-built Docker image URL (optional)"
        required: false
        default: ""
        type: string
    secrets:
      FLYIO_AUTH_TOKEN:
        required: true
      ANTHROPIC_API_KEY:
        required: false

  workflow_dispatch:
    inputs:
      extension_name:
        description: "Extension name to test"
        required: true
        type: choice
        options:
          # Claude AI Extensions
          - claude-marketplace
          - openskills
          # mise-powered Languages
          - nodejs
          - nodejs-devtools
          - python
          - rust
          - golang
          # Traditional Languages
          - ruby
          - php
          - jvm
          - dotnet
          # Infrastructure
          - docker
          - infra-tools
          - cloud-tools
          # Development Tools
          - github-cli
          - ai-tools
          - playwright
          # Utilities
          - monitoring
          - tmux-workspace
          - agent-manager
          - context-loader
      region:
        description: "Fly.io region"
        required: false
        default: "sjc"
        type: choice
        options:
          # North America
          - sjc  # San Jose, California (US)
          - lax  # Los Angeles, California (US)
          - dfw  # Dallas, Texas (US)
          - ord  # Chicago, Illinois (US)
          - iad  # Ashburn, Virginia (US)
          - ewr  # Secaucus, New Jersey (US)
          - yyz  # Toronto, Canada
          # Europe
          - lhr  # London, United Kingdom
          - ams  # Amsterdam, Netherlands
          - cdg  # Paris, France
          - fra  # Frankfurt, Germany
          - arn  # Stockholm, Sweden
          # Asia Pacific
          - nrt  # Tokyo, Japan
          - sin  # Singapore
          - syd  # Sydney, Australia
          - bom  # Mumbai, India
          # South America
          - gru  # São Paulo, Brazil
          # Africa
          - jnb  # Johannesburg, South Africa
      test_app_prefix:
        description: "Test app prefix"
        required: false
        default: "single-ext-test"
        type: string
      skip_cleanup:
        description: "Skip cleanup for debugging"
        required: false
        default: false
        type: boolean

permissions:
  contents: read

jobs:
  test-extension:
    name: Test ${{ inputs.extension_name }}
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Mask secrets
        uses: ./.github/actions/mask-secrets

      - name: Validate extension exists
        id: validate
        run: |
          EXT_NAME="${{ inputs.extension_name }}"
          echo "Validating extension: $EXT_NAME"

          # Check if extension file exists
          if [[ -f "docker/lib/extensions.d/${EXT_NAME}.extension" ]]; then
            EXT_FILE="docker/lib/extensions.d/${EXT_NAME}.extension"
            echo "Found: $EXT_FILE"
          elif [[ -f "docker/lib/extensions.d/${EXT_NAME}/${EXT_NAME}.extension" ]]; then
            EXT_FILE="docker/lib/extensions.d/${EXT_NAME}/${EXT_NAME}.extension"
            echo "Found: $EXT_FILE"
          else
            echo "❌ Extension not found: $EXT_NAME"
            exit 1
          fi

          echo "extension_file=$EXT_FILE" >> $GITHUB_OUTPUT
          echo "✅ Extension validated"

      - name: Setup test environment
        uses: ./.github/actions/setup-fly-test-env
        with:
          app-prefix: ${{ inputs.test_app_prefix }}
          extension-name: ${{ inputs.extension_name }}
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}
          region: ${{ inputs.region }}

      - name: Deploy test VM
        id: deploy
        uses: ./.github/actions/deploy-fly-app
        with:
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}
          app-name: ${{ inputs.test_app_prefix }}-${{ inputs.extension_name }}-${{ github.run_id }}
          region: ${{ inputs.region }}
          pre-built-image: ${{ inputs.pre_built_image }}

      - name: Install extension dependencies
        if: steps.deploy.outputs.app-name != ''
        run: |
          # Source retry utilities
          source .github/scripts/common/ssh-helpers.sh

          echo "Checking for extension dependencies..."

          # Source the extension file to get dependencies
          source ${{ steps.validate.outputs.extension_file }}

          # Check if extension declares dependencies
          if declare -f extension_dependencies > /dev/null 2>&1; then
            DEPS=$(extension_dependencies)
            if [[ -n "$DEPS" ]]; then
              echo "Installing dependencies: $DEPS"
              for dep in $DEPS; do
                ssh_command_retry ${{ steps.deploy.outputs.app-name }} "extension-manager install $dep"
              done
            fi
          fi

          echo "✅ Dependencies ready"

      - name: Test extension installation
        if: steps.deploy.outputs.app-name != ''
        run: |
          # Source retry utilities
          source .github/scripts/common/ssh-helpers.sh

          echo "Testing installation of: ${{ inputs.extension_name }}"

          if ssh_command_retry ${{ steps.deploy.outputs.app-name }} "extension-manager install ${{ inputs.extension_name }}"; then
            echo "✅ Extension installed successfully"
          else
            echo "❌ Extension installation failed"
            exit 1
          fi

      - name: Validate extension
        if: steps.deploy.outputs.app-name != ''
        run: |
          # Source retry utilities
          source .github/scripts/common/ssh-helpers.sh

          echo "Validating extension: ${{ inputs.extension_name }}"

          if ssh_command_retry ${{ steps.deploy.outputs.app-name }} "extension-manager validate ${{ inputs.extension_name }}"; then
            echo "✅ Extension validation passed"
          else
            echo "❌ Extension validation failed"
            exit 1
          fi

      - name: Test API compliance
        if: steps.deploy.outputs.app-name != ''
        run: |
          # Source retry utilities
          source .github/scripts/common/ssh-helpers.sh

          echo "Testing Extension API compliance..."

          # Test required functions exist
          REQUIRED_FUNCTIONS=("prerequisites" "install" "configure" "validate" "status" "remove")

          for func in "${REQUIRED_FUNCTIONS[@]}"; do
            echo "Checking function: ${func}"
            if ssh_command_retry ${{ steps.deploy.outputs.app-name }} "bash -c 'source docker/lib/extension-manager.sh && type ${func}_${{ inputs.extension_name }} > /dev/null 2>&1'"; then
              echo "✅ Function ${func} exists"
            else
              echo "❌ Missing required function: ${func}"
              exit 1
            fi
          done

          echo "✅ API compliance check passed"

      - name: Test idempotency
        if: steps.deploy.outputs.app-name != ''
        run: |
          # Source retry utilities
          source .github/scripts/common/ssh-helpers.sh

          echo "Testing idempotent reinstallation..."

          # Install extension again
          if ssh_command_retry ${{ steps.deploy.outputs.app-name }} "extension-manager install ${{ inputs.extension_name }}"; then
            echo "✅ Idempotent reinstallation successful"
          else
            echo "❌ Idempotent reinstallation failed"
            exit 1
          fi

          # Validate again
          if ssh_command_retry ${{ steps.deploy.outputs.app-name }} "extension-manager validate ${{ inputs.extension_name }}"; then
            echo "✅ Post-reinstallation validation passed"
          else
            echo "❌ Post-reinstallation validation failed"
            exit 1
          fi

      - name: Cleanup test resources
        if: always() && steps.deploy.outputs.app-name != '' && inputs.skip_cleanup == false
        uses: ./.github/actions/cleanup-fly-app
        with:
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}
          app-name: ${{ steps.deploy.outputs.app-name }}

      - name: Report results
        if: always()
        run: |
          echo "## Single Extension Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Extension**: \`${{ inputs.extension_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ job.status }}" == "success" ]]; then
            echo "✅ All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Tests failed - check job logs for details" >> $GITHUB_STEP_SUMMARY
          fi
