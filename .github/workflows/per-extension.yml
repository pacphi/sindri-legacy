name: Per-Extension Tests

on:
  workflow_call:
    inputs:
      extension_name:
        description: "Test specific extension (optional)"
        required: false
        default: ""
        type: string
      skip_cleanup:
        description: "Skip cleanup for debugging"
        required: false
        default: false
        type: boolean
      skip_idempotency:
        description: "Skip idempotency tests"
        required: false
        default: false
        type: boolean
      test_app_prefix:
        description: "Test app prefix"
        required: false
        default: "ext-test"
        type: string
      region:
        description: "Fly.io region"
        required: false
        default: "sjc"
        type: string
      pre_built_image:
        description: "Pre-built Docker image URL (optional)"
        required: false
        default: ""
        type: string
    secrets:
      FLYIO_AUTH_TOKEN:
        required: true
      ANTHROPIC_API_KEY:
        required: false

permissions:
  contents: read

jobs:
  per-extension-tests:
    name: Test Extension - ${{ matrix.extension.name }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read

    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        extension:
          # mise-powered language extensions
          - { name: "nodejs", commands: "node,npm", key_tool: "node", timeout: "15m" }
          - { name: "python", commands: "python3,pip3", key_tool: "python3", timeout: "15m" }
          - { name: "rust", commands: "rustc,cargo", key_tool: "rustc", timeout: "20m" }
          - { name: "golang", commands: "go", key_tool: "go", timeout: "20m" }
          - { name: "nodejs-devtools", commands: "tsc,eslint,prettier", key_tool: "tsc", timeout: "15m", depends_on: "nodejs" }
          # Claude AI extensions (claude pre-installed in Docker image)
          - { name: "claude-marketplace", commands: "claude", key_tool: "claude-marketplace", timeout: "15m" }
          - { name: "openskills", commands: "openskills", key_tool: "openskills", timeout: "15m", depends_on: "nodejs" }
          # Traditional extensions (unchanged)
          - { name: "ruby", commands: "ruby,gem,bundle", key_tool: "ruby", timeout: "30m", status_timeout: 2 }
          - { name: "php", commands: "php,composer", key_tool: "php", timeout: "30m" }
          - { name: "jvm", commands: "java,sdk", key_tool: "java", timeout: "30m" }
          - { name: "dotnet", commands: "dotnet", key_tool: "dotnet", timeout: "30m" }
          # Infrastructure
          - { name: "docker", commands: "docker", key_tool: "docker", timeout: "30m" }
          - { name: "infra-tools", commands: "terraform,ansible", key_tool: "terraform", timeout: "30m", status_timeout: 5 }
          - { name: "cloud-tools", commands: "aws", key_tool: "aws", timeout: "30m", status_timeout: 5 }
          - { name: "ai-tools", commands: "codex,gemini", key_tool: "codex", timeout: "30m", depends_on: "nodejs" }
          # Utilities
          - { name: "playwright", commands: "playwright", key_tool: "playwright", timeout: "25m", depends_on: "nodejs", key_test_timeout: 5 }
          - { name: "monitoring", commands: "claude-monitor,uv", key_tool: "claude-monitor", timeout: "20m", depends_on: "python,nodejs" }
          - { name: "tmux-workspace", commands: "tmux", key_tool: "tmux", timeout: "15m", key_test_timeout: 5 }
          - { name: "agent-manager", commands: "agent-manager", key_tool: "agent-manager", timeout: "15m" }
          - { name: "context-loader", commands: "context-load", key_tool: "echo", timeout: "10m" }
          - { name: "github-cli", commands: "gh", key_tool: "gh", timeout: "15m" }

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Check if extension should be tested
        id: should-test
        run: |
          # Skip if workflow_dispatch with specific extension that doesn't match
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && \
             [ -n "${{ github.event.inputs.extension_name }}" ] && \
             [ "${{ github.event.inputs.extension_name }}" != "${{ matrix.extension.name }}" ]; then
            echo "should_test=false" >> $GITHUB_OUTPUT
            echo "Skipping ${{ matrix.extension.name }} - not requested"
          else
            echo "should_test=true" >> $GITHUB_OUTPUT
            echo "Testing ${{ matrix.extension.name }}"
          fi

      # NEW: Using composite action for setup
      - name: Setup Fly.io test environment
        if: steps.should-test.outputs.should_test == 'true'
        id: setup
        uses: ./.github/actions/setup-fly-test-env
        with:
          app-prefix: ${{ inputs.test_app_prefix }}
          extension-name: ${{ matrix.extension.name }}
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}
          region: ${{ inputs.region }}

      # NEW: Using composite action for deployment
      - name: Deploy test environment
        if: steps.should-test.outputs.should_test == 'true'
        uses: ./.github/actions/deploy-fly-app
        with:
          app-name: ${{ steps.setup.outputs.app-name }}
          region: ${{ inputs.region }}
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}
          pre-built-image: ${{ inputs.pre_built_image }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          ci-mode: "true"

      # NEW: Using composite action for waiting
      - name: Wait for deployment
        if: steps.should-test.outputs.should_test == 'true'
        uses: ./.github/actions/wait-fly-deployment
        with:
          app-name: ${{ steps.setup.outputs.app-name }}
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}
          timeout-seconds: "300"

      - name: Verify CI extension manifest
        if: steps.should-test.outputs.should_test == 'true'
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          # Source retry utilities
          source .github/scripts/common/ssh-helpers.sh

          app_name="${{ steps.setup.outputs.app-name }}"

          # Upload and chmod with retry
          sftp_upload_and_chmod "$app_name" \
            .github/scripts/common/verify-manifest.sh \
            /tmp/verify-manifest.sh \
            666

          # Execute with retry
          ssh_command_retry "$app_name" "/bin/bash -lc 'bash /tmp/verify-manifest.sh'"

      - name: Add extension to manifest
        if: steps.should-test.outputs.should_test == 'true'
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          # Source retry utilities
          source .github/scripts/common/ssh-helpers.sh

          app_name="${{ steps.setup.outputs.app-name }}"
          extension_name="${{ matrix.extension.name }}"
          depends_on="${{ matrix.extension.depends_on }}"

          echo "Adding $extension_name to manifest"

          # Upload and chmod with retry
          sftp_upload_and_chmod "$app_name" \
            .github/scripts/extension-tests/add-extension.sh \
            /tmp/add-extension.sh \
            666

          # Execute with retry
          ssh_command_retry "$app_name" "/bin/bash -lc 'bash /tmp/add-extension.sh $extension_name $depends_on'"

      - name: Install extension using install-all
        timeout-minutes: 30
        if: steps.should-test.outputs.should_test == 'true'
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          app_name="${{ steps.setup.outputs.app-name }}"
          timeout="${{ matrix.extension.timeout }}"

          echo "Running extension-manager install-all for ${{ matrix.extension.name }} extension (timeout: $timeout)..."

          max_config_attempts=2
          config_attempt=1

          while [ $config_attempt -le $max_config_attempts ]; do
            echo "Configuration attempt $config_attempt/$max_config_attempts..."

            if flyctl ssh console --app $app_name --user developer --command "/bin/bash -lc '
              export CI_MODE=true
              echo \"=== Starting extension installation ===\"
              echo \"Extension: ${{ matrix.extension.name }}\"
              echo \"Timeout: $timeout\"
              echo \"\"

              if timeout --kill-after=60s $timeout bash -c \"cd /workspace/scripts/lib && bash extension-manager.sh install-all\" 2>&1 | tee /tmp/configure.log; then
                config_exit_code=\${PIPESTATUS[0]}

                if [ \$config_exit_code -eq 0 ]; then
                  echo \"\"
                  echo \"✅ Configuration completed successfully\"
                  echo \"\"

                  if grep -q \"Extension setup completed\" /tmp/configure.log || \
                     grep -q \"Configuration complete\" /tmp/configure.log; then
                    echo \"✅ Configuration markers found\"
                  else
                    echo \"⚠️  No completion markers found, but no errors detected\"
                  fi

                  echo \"⏳ Waiting for SSH environment to stabilize (45 seconds)...\"
                  sleep 45

                  if [ -f /etc/profile.d/00-ssh-environment.sh ]; then
                    echo \"✅ SSH environment file present\"
                  else
                    echo \"⚠️  SSH environment file not found\"
                  fi

                  exit 0
                else
                  echo \"\"
                  echo \"❌ Configuration exited with code: \$config_exit_code\"
                  echo \"Last 30 lines of output:\"
                  tail -30 /tmp/configure.log
                  exit 1
                fi
              else
                timeout_exit_code=\$?
                echo \"\"

                if [ \$timeout_exit_code -eq 124 ]; then
                  echo \"❌ Configuration timed out after $timeout\"
                elif [ \$timeout_exit_code -eq 137 ]; then
                  echo \"❌ Configuration was killed (timeout kill signal)\"
                else
                  echo \"❌ Configuration failed with exit code: \$timeout_exit_code\"
                fi

                echo \"\"
                echo \"Last 50 lines of output:\"
                tail -50 /tmp/configure.log

                echo \"\"
                echo \"=== Error Analysis ===\"
                if grep -i \"error\|failed\|timeout\" /tmp/configure.log | tail -10; then
                  echo \"(Errors found in log)\"
                else
                  echo \"No obvious errors in log\"
                fi

                echo \"\"
                echo \"=== Timeout Diagnostics ===\"
                echo \"Running processes (top 20):\"
                ps aux | head -20 || echo \"Failed to get process list\"

                echo \"\"
                echo \"Disk space:\"
                df -h || echo \"Failed to get disk space\"

                echo \"\"
                echo \"Memory usage:\"
                free -h || echo \"Failed to get memory usage\"

                echo \"\"
                echo \"Load average:\"
                uptime || echo \"Failed to get load average\"

                exit 1
              fi
            '"; then
              echo "✅ extension-manager install-all completed successfully"
              break
            else
              exit_code=$?
              config_attempt=$((config_attempt + 1))

              if [ $config_attempt -le $max_config_attempts ]; then
                echo "⚠️  Configuration attempt failed with exit code $exit_code"
                echo "Checking app status before retry..."
                flyctl status --app $app_name || true
                echo "Waiting 30s before retry..."
                sleep 30
              else
                echo "❌ extension-manager install-all failed after $max_config_attempts attempts"
                echo "Retrieving app logs for diagnosis (with 30s timeout)..."
                timeout 30s flyctl logs --app $app_name --limit 200 || {
                  echo "⚠️  Log retrieval timed out or failed"
                  echo "Attempting to get machine status instead..."
                  flyctl status --app $app_name || echo "Status check also failed"
                }
                exit 1
              fi
            fi
          done

      # NEW: Using extracted script for command verification
      - name: Verify commands available
        timeout-minutes: 2
        if: steps.should-test.outputs.should_test == 'true'
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          # Source retry utilities
          source .github/scripts/common/ssh-helpers.sh

          app_name="${{ steps.setup.outputs.app-name }}"
          commands="${{ matrix.extension.commands }}"

          echo "Verifying commands: $commands"

          # Create lib directory with retry
          ssh_mkdir_retry "$app_name" /tmp/lib

          # Upload multiple files with retry
          sftp_upload_multiple "$app_name" 666 \
            .github/scripts/extension-tests/verify-commands.sh:/tmp/verify-commands.sh \
            .github/scripts/extension-tests/lib/test-helpers.sh:/tmp/lib/test-helpers.sh \
            .github/scripts/extension-tests/lib/assertions.sh:/tmp/lib/assertions.sh

          # Execute with retry
          ssh_command_retry "$app_name" "/bin/bash -lc 'bash /tmp/verify-commands.sh \"$commands\"'"

      # NEW: Using extracted script for key functionality testing
      - name: Test key functionality
        timeout-minutes: ${{ matrix.extension.key_test_timeout || 2 }}
        if: steps.should-test.outputs.should_test == 'true'
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          # Source retry utilities
          source .github/scripts/common/ssh-helpers.sh

          app_name="${{ steps.setup.outputs.app-name }}"
          key_tool="${{ matrix.extension.key_tool }}"

          echo "Testing key functionality: $key_tool (timeout: ${{ matrix.extension.key_test_timeout || 2 }} minutes)..."

          # Create lib directory with retry
          ssh_mkdir_retry "$app_name" /tmp/lib

          # Upload and chmod with retry
          sftp_upload_and_chmod "$app_name" \
            .github/scripts/extension-tests/test-key-functionality.sh \
            /tmp/test-key-functionality.sh \
            666

          # Execute with retry
          ssh_command_retry "$app_name" "/bin/bash -lc 'bash /tmp/test-key-functionality.sh $key_tool'"

      - name: Test enhanced status() output
        timeout-minutes: ${{ matrix.extension.status_timeout || 2 }}
        if: steps.should-test.outputs.should_test == 'true'
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          # Source retry utilities
          source .github/scripts/common/ssh-helpers.sh

          app_name="${{ steps.setup.outputs.app-name }}"
          extension_name="${{ matrix.extension.name }}"

          echo "Testing enhanced status() output for $extension_name (timeout: ${{ matrix.extension.status_timeout || 2 }} minutes)..."

          # Use a temporary file to capture output with retry
          if ssh_command_retry "$app_name" "/bin/bash -lc 'cd /workspace/scripts/lib && bash extension-manager.sh status $extension_name'" > /tmp/status_output.txt; then
            status_output=$(cat /tmp/status_output.txt)
            echo "$status_output"

            if echo "$status_output" | grep -q "Extension:"; then
              echo "✅ Status shows extension metadata"
            else
              echo "❌ Status missing extension metadata"
              exit 1
            fi

            if echo "$status_output" | grep -q "Status:"; then
              echo "✅ Status shows installation status"
            else
              echo "❌ Status missing installation status"
              exit 1
            fi

            echo "✅ Enhanced status() output verified"
          else
            echo "❌ Failed to get status output"
            exit 1
          fi

      # NEW: Using extracted script for idempotency testing
      - name: Test idempotency
        timeout-minutes: 10
        if: steps.should-test.outputs.should_test == 'true' && inputs.skip_idempotency != true
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          # Source retry utilities
          source .github/scripts/common/ssh-helpers.sh

          app_name="${{ steps.setup.outputs.app-name }}"

          echo "Testing idempotency..."

          # Upload and chmod with retry
          sftp_upload_and_chmod "$app_name" \
            .github/scripts/extension-tests/test-idempotency.sh \
            /tmp/test-idempotency.sh \
            666

          # Execute with retry
          ssh_command_retry "$app_name" "/bin/bash -lc 'bash /tmp/test-idempotency.sh'"

      # NEW: Using composite action for cleanup
      - name: Cleanup test resources
        if: always() && !inputs.skip_cleanup
        uses: ./.github/actions/cleanup-fly-app
        with:
          app-name: ${{ steps.setup.outputs.app-name }}
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}
