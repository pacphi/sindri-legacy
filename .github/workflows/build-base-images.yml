name: Build Base Images

on:
  workflow_dispatch:
    inputs:
      layer:
        description: 'Which layer to build'
        required: true
        type: choice
        options:
          - base
          - tooling
          - both
        default: 'both'
      version:
        description: 'Version tag (e.g., v1.0.0, leave empty for auto-versioning)'
        required: false
        type: string
  push:
    branches:
      - main
    paths:
      # Base layer triggers
      - 'Dockerfile.base'
      - 'docker/lib/registry-retry.sh'
      - 'docker/scripts/install-packages.sh'
      # Tooling layer triggers
      - 'Dockerfile.tooling'
      - 'docker/config/sshd_config'
      - 'docker/config/developer-sudoers'
      - 'docker/scripts/setup-user.sh'
      - 'docker/scripts/install-mise.sh'
      - 'docker/scripts/setup-ssh-environment.sh'
      - 'docker/scripts/install-claude.sh'
      - 'docker/scripts/install-sops-age.sh'

jobs:
  detect-changes:
    name: Detect Layer Changes
    runs-on: ubuntu-latest
    outputs:
      base-changed: ${{ steps.filter.outputs.base }}
      tooling-changed: ${{ steps.filter.outputs.tooling }}
      build-base: ${{ steps.decide.outputs.build-base }}
      build-tooling: ${{ steps.decide.outputs.build-tooling }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 2

      - name: Check for file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            base:
              - 'Dockerfile.base'
              - 'docker/lib/registry-retry.sh'
              - 'docker/scripts/install-packages.sh'
            tooling:
              - 'Dockerfile.tooling'
              - 'docker/config/sshd_config'
              - 'docker/config/developer-sudoers'
              - 'docker/scripts/setup-user.sh'
              - 'docker/scripts/install-mise.sh'
              - 'docker/scripts/setup-ssh-environment.sh'
              - 'docker/scripts/install-claude.sh'
              - 'docker/scripts/install-sops-age.sh'

      - name: Decide what to build
        id: decide
        run: |
          # For manual dispatch, honor user's choice
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            LAYER="${{ inputs.layer }}"
            if [ "$LAYER" == "both" ] || [ "$LAYER" == "base" ]; then
              echo "build-base=true" >> $GITHUB_OUTPUT
            else
              echo "build-base=false" >> $GITHUB_OUTPUT
            fi

            if [ "$LAYER" == "both" ] || [ "$LAYER" == "tooling" ]; then
              echo "build-tooling=true" >> $GITHUB_OUTPUT
            else
              echo "build-tooling=false" >> $GITHUB_OUTPUT
            fi
          else
            # For automatic triggers, build based on what changed
            if [ "${{ steps.filter.outputs.base }}" == "true" ]; then
              echo "build-base=true" >> $GITHUB_OUTPUT
              # If base changes, tooling must rebuild too
              echo "build-tooling=true" >> $GITHUB_OUTPUT
            else
              echo "build-base=false" >> $GITHUB_OUTPUT

              if [ "${{ steps.filter.outputs.tooling }}" == "true" ]; then
                echo "build-tooling=true" >> $GITHUB_OUTPUT
              else
                echo "build-tooling=false" >> $GITHUB_OUTPUT
              fi
            fi
          fi

  build-base:
    name: Build Base Layer
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.build-base == 'true'
    outputs:
      image-url: ${{ steps.build.outputs.image-url }}
      version-tag: ${{ steps.version.outputs.tag }}
    steps:
      - uses: actions/checkout@v5

      - name: Determine version tag
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            # Auto-version based on commit timestamp
            VERSION="base-$(date +%Y%m%d-%H%M%S)"
          fi
          echo "tag=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building base layer with version: ${VERSION}"

      - name: Build and push base image
        id: build
        uses: ./.github/actions/build-push-image
        with:
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}
          dockerfile: Dockerfile.base
          tag: ${{ steps.version.outputs.tag }}

      - name: Tag as base-stable
        run: |
          docker pull ${{ steps.build.outputs.image-url }}
          docker tag ${{ steps.build.outputs.image-url }} registry.fly.io/sindri-registry:base-stable
          docker push registry.fly.io/sindri-registry:base-stable
          echo "✅ Tagged as base-stable"

  build-tooling:
    name: Build Tooling Layer
    runs-on: ubuntu-latest
    needs: [detect-changes, build-base]
    if: |
      always() &&
      needs.detect-changes.outputs.build-tooling == 'true' &&
      (needs.build-base.result == 'success' || needs.build-base.result == 'skipped')
    outputs:
      image-url: ${{ steps.build.outputs.image-url }}
      version-tag: ${{ steps.version.outputs.tag }}
    steps:
      - uses: actions/checkout@v5

      - name: Install Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Authenticate with Fly Docker registry
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: flyctl auth docker

      - name: Determine version tag
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            # Auto-version based on commit timestamp
            VERSION="tooling-$(date +%Y%m%d-%H%M%S)"
          fi
          echo "tag=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building tooling layer with version: ${VERSION}"

      - name: Determine base image
        id: base
        run: |
          # If we just built base, use that version, otherwise use base-stable
          if [ "${{ needs.build-base.result }}" == "success" ]; then
            BASE_IMAGE="${{ needs.build-base.outputs.image-url }}"
          else
            BASE_IMAGE="registry.fly.io/sindri-registry:base-stable"
          fi
          echo "image=${BASE_IMAGE}" >> $GITHUB_OUTPUT
          echo "Using base image: ${BASE_IMAGE}"

      - name: Build and push tooling image
        id: build
        uses: ./.github/actions/build-push-image
        with:
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}
          dockerfile: Dockerfile.tooling
          tag: ${{ steps.version.outputs.tag }}
          base-image: ${{ steps.base.outputs.image }}

      - name: Tag as tooling-stable
        run: |
          docker pull ${{ steps.build.outputs.image-url }}
          docker tag ${{ steps.build.outputs.image-url }} registry.fly.io/sindri-registry:tooling-stable
          docker push registry.fly.io/sindri-registry:tooling-stable
          echo "✅ Tagged as tooling-stable"

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, build-base, build-tooling]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Base Images Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.build-base.result }}" == "success" ]; then
            echo "✅ **Base Layer**: Built and tagged as \`base-stable\`" >> $GITHUB_STEP_SUMMARY
            echo "   - Version: \`${{ needs.build-base.outputs.version-tag }}\`" >> $GITHUB_STEP_SUMMARY
            echo "   - Image: \`${{ needs.build-base.outputs.image-url }}\`" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-base.result }}" == "skipped" ]; then
            echo "⏭️ **Base Layer**: Skipped (no changes)" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Base Layer**: Build failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.build-tooling.result }}" == "success" ]; then
            echo "✅ **Tooling Layer**: Built and tagged as \`tooling-stable\`" >> $GITHUB_STEP_SUMMARY
            echo "   - Version: \`${{ needs.build-tooling.outputs.version-tag }}\`" >> $GITHUB_STEP_SUMMARY
            echo "   - Image: \`${{ needs.build-tooling.outputs.image-url }}\`" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-tooling.result }}" == "skipped" ]; then
            echo "⏭️ **Tooling Layer**: Skipped (no changes)" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Tooling Layer**: Build failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "The application layer will automatically use the updated base images in subsequent builds." >> $GITHUB_STEP_SUMMARY
