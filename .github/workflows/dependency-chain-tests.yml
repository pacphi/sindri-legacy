name: Dependency Chain Tests

on:
  workflow_call:
    inputs:
      test_app_prefix:
        description: "Test app prefix"
        required: false
        default: "deps-test"
        type: string
      region:
        description: "Fly.io region"
        required: false
        default: "sjc"
        type: string
      skip_cleanup:
        description: "Skip cleanup for debugging"
        required: false
        default: false
        type: boolean
      pre_built_image:
        description: "Pre-built Docker image URL (optional)"
        required: false
        default: ""
        type: string
    secrets:
      FLYIO_AUTH_TOKEN:
        required: true
      ANTHROPIC_API_KEY:
        required: false

permissions:
  contents: read

jobs:
  test-dependency-chain:
    name: Test ${{ matrix.test-case.name }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read

    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        test-case:
          # Test automatic dependency resolution
          - name: "nodejs-devtools → nodejs"
            top_level: "nodejs-devtools"
            expected_chain: "nodejs nodejs-devtools"
            description: "TypeScript tools should auto-install Node.js"

          - name: "openskills → nodejs"
            top_level: "openskills"
            expected_chain: "nodejs openskills"
            description: "OpenSkills should auto-install Node.js (git is pre-installed)"

          - name: "playwright → nodejs"
            top_level: "playwright"
            expected_chain: "nodejs playwright"
            description: "Playwright should auto-install Node.js"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Fly.io test environment
        id: setup
        uses: ./.github/actions/setup-fly-test-env
        with:
          app-prefix: ${{ inputs.test_app_prefix }}
          extension-name: ${{ matrix.test-case.name }}
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}
          region: ${{ inputs.region }}
          # Use heavy tier for playwright (requires 6GB+ RAM), standard for others
          resource-tier: ${{ contains(matrix.test-case.name, 'playwright') && 'heavy' || 'standard' }}

      - name: Deploy test environment
        uses: ./.github/actions/deploy-fly-app
        with:
          app-name: ${{ steps.setup.outputs.app-name }}
          region: ${{ inputs.region }}
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}
          deploy-timeout: "300"
          pre-built-image: ${{ inputs.pre_built_image }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          ci-mode: "true"

      - name: Wait for deployment
        uses: ./.github/actions/wait-fly-deployment
        with:
          app-name: ${{ steps.setup.outputs.app-name }}
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}
          timeout-seconds: "240"
          expected-status: "started"

      - name: Test automatic dependency resolution
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          source "${GITHUB_WORKSPACE}/.github/scripts/lib/retry-utils.sh"
          app_name="${{ steps.setup.outputs.app-name }}"
          top_level="${{ matrix.test-case.top_level }}"
          expected_chain="${{ matrix.test-case.expected_chain }}"

          echo "========================================"
          echo "Testing: ${{ matrix.test-case.description }}"
          echo "========================================"
          echo ""
          echo "Top-level extension: $top_level"
          echo "Expected dependency chain: $expected_chain"
          echo ""

          # Execute test with retry
          ssh_command_retry "$app_name" "/bin/bash -lc '
            set -e

            cd /workspace/.system
            manifest=\"manifest/active-extensions.conf\"

            echo \"Creating manifest with ONLY top-level extension...\"
            echo \"$top_level\" > \$manifest

            echo \"\"
            echo \"=== Manifest (before install) ===\"
            cat \$manifest

            echo \"\"
            echo \"Running: extension-manager install-all\"
            echo \"Expected: Automatic dependency resolution\"
            echo \"\"

            if timeout 15m bash bin/extension-manager install-all 2>&1 | tee /tmp/install.log; then
              echo \"\"
              echo \"=== install-all command completed ===\"

              echo \"\"
              echo \"=== Manifest (after install) ===\"
              cat \$manifest

              echo \"\"
              echo \"=== Checking for installation failures ===\"

              # Check if any extensions failed to install
              if grep -q \"ERROR.*Failed to install:\" /tmp/install.log; then
                echo \"\"
                echo \"❌ One or more extensions failed to install!\"
                echo \"\"
                echo \"Failed extensions:\"
                grep \"ERROR.*Failed to install:\" /tmp/install.log
                echo \"\"
                echo \"Installation log (last 50 lines):\"
                tail -50 /tmp/install.log
                exit 1
              fi

              # Check for failed installation count in summary
              if grep -q \"ERROR.*Failed: [1-9]\" /tmp/install.log; then
                echo \"\"
                echo \"❌ Installation summary shows failures!\"
                grep \"Failed: [1-9]\" /tmp/install.log
                echo \"\"
                echo \"Installation log (last 50 lines):\"
                tail -50 /tmp/install.log
                exit 1
              fi

              echo \"✅ No installation failures detected\"
              echo \"\"
              echo \"Verifying dependency chain was auto-installed...\"

              # Check each expected extension in the chain
              all_found=true
              for ext in $expected_chain; do
                if grep -q \"^\$ext\\\$\" \$manifest; then
                  echo \"  ✅ \$ext found in manifest (auto-installed)\"

                  # Verify the extension actually installed by checking status
                  if bash bin/extension-manager status \"\$ext\" >/dev/null 2>&1; then
                    echo \"     ✓ \$ext status check passed\"
                  else
                    echo \"     ⚠️  \$ext in manifest but status check failed\"
                    all_found=false
                  fi
                else
                  echo \"  ❌ \$ext NOT found in manifest\"
                  all_found=false
                fi
              done

              if [ \"\$all_found\" = \"false\" ]; then
                echo \"\"
                echo \"❌ Dependency resolution verification failed!\"
                echo \"Expected chain: $expected_chain\"
                echo \"Actual manifest:\"
                cat \$manifest
                exit 1
              fi

              echo \"\"
              echo \"✅ All dependencies auto-installed and verified\"
              echo \"======================================\"
              echo \"Test passed: ${{ matrix.test-case.description }}\"
              echo \"======================================\"
            else
              echo \"\"
              echo \"❌ install-all failed\"
              tail -50 /tmp/install.log
              exit 1
            fi
          '"

      - name: Cleanup test resources
        if: always() && !inputs.skip_cleanup
        uses: ./.github/actions/cleanup-fly-app
        with:
          app-name: ${{ steps.setup.outputs.app-name }}
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}
