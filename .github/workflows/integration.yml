name: Integration Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * 6'  # Weekly on Saturday at 2:00 AM UTC
  workflow_dispatch:
    inputs:
      test_region:
        description: "Fly.io region for test deployment"
        required: false
        default: "sjc"
        type: choice
        options:
          - sjc  # San Jose, California (US)
          - lax  # Los Angeles, California (US)
          - dfw  # Dallas, Texas (US)
          - ord  # Chicago, Illinois (US)
          - iad  # Ashburn, Virginia (US)
          - ewr  # Secaucus, New Jersey (US)
          - yyz  # Toronto, Canada
          - lhr  # London, United Kingdom
          - ams  # Amsterdam, Netherlands
          - cdg  # Paris, France
          - fra  # Frankfurt, Germany
          - arn  # Stockholm, Sweden
          - nrt  # Tokyo, Japan
          - sin  # Singapore
          - syd  # Sydney, Australia
          - bom  # Mumbai, India
          - gru  # SÃ£o Paulo, Brazil
          - jnb  # Johannesburg, South Africa
      skip_cleanup:
        description: "Skip cleanup (for debugging)"
        required: false
        default: false
        type: boolean

permissions:
  contents: read

jobs:
  # ============================================================================
  # PHASE 1: Quick Checks (Inline - Fail Fast)
  # ============================================================================

  quick-checks:
    name: Quick Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Shellcheck validation
        run: |
          echo "=== Running shellcheck validation ==="
          shellcheck_failed=0

          for script in docker/lib/*.sh docker/scripts/*.sh scripts/*.sh .github/scripts/**/*.sh; do
            if [ -f "$script" ]; then
              echo "Checking $script..."
              if shellcheck -x "$script" 2>&1; then
                echo "âœ… $script passed"
              else
                echo "âŒ $script failed shellcheck"
                shellcheck_failed=1
              fi
            fi
          done

          if [ $shellcheck_failed -eq 1 ]; then
            echo "âŒ Shellcheck validation failed"
            exit 1
          fi

          echo "âœ… All shell scripts passed shellcheck"

      - name: YAML validation
        run: |
          echo "=== Running YAML validation ==="
          yaml_failed=0

          for yaml in .github/workflows/*.yml .github/actions/**/action.yml docker/compose/*.yml; do
            if [ -f "$yaml" ]; then
              echo "Checking $yaml..."
              if python3 -c "import yaml; yaml.safe_load(open('$yaml'))" 2>&1; then
                echo "âœ… $yaml is valid"
              else
                echo "âŒ $yaml is invalid"
                yaml_failed=1
              fi
            fi
          done

          if [ $yaml_failed -eq 1 ]; then
            echo "âŒ YAML validation failed"
            exit 1
          fi

          echo "âœ… All YAML files are valid"

      - name: Extension manager syntax check
        run: |
          echo "=== Checking extension-manager syntax ==="
          if bash -n docker/lib/extension-manager.sh; then
            echo "âœ… extension-manager.sh syntax valid"
          else
            echo "âŒ extension-manager.sh syntax invalid"
            exit 1
          fi

  # ============================================================================
  # PHASE 2: Extension System Validation (No VM - Fail Fast)
  # ============================================================================

  manager-validation:
    name: Extension Manager Validation
    needs: quick-checks
    if: success()
    uses: ./.github/workflows/manager-validation.yml

  manifest-validation:
    name: Manifest & Extension Validation
    needs: manager-validation
    if: success()
    uses: ./.github/workflows/manifest-validation.yml

  # ============================================================================
  # Setup Configuration
  # ============================================================================

  setup-config:
    name: Setup Configuration
    needs: manifest-validation
    if: success()
    runs-on: ubuntu-latest
    outputs:
      region: ${{ steps.config.outputs.region }}
      test_app_prefix: ${{ steps.config.outputs.test_app_prefix }}
      skip_cleanup: ${{ steps.config.outputs.skip_cleanup }}
    steps:
      - name: Set configuration
        id: config
        run: |
          echo "region=${{ github.event.inputs.test_region || 'sjc' }}" >> $GITHUB_OUTPUT
          echo "test_app_prefix=sindri-ci-test" >> $GITHUB_OUTPUT
          echo "skip_cleanup=${{ github.event.inputs.skip_cleanup == 'true' }}" >> $GITHUB_OUTPUT

  # ============================================================================
  # Build Docker Image
  # ============================================================================

  build-image:
    name: Build Docker Image
    needs: setup-config
    if: success()
    uses: ./.github/workflows/build-image.yml
    secrets:
      FLYIO_AUTH_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}

  # ============================================================================
  # PHASE 2.5: Dependency Chain Tests (Runtime - Fail Fast)
  # ============================================================================

  dependency-chain:
    name: Dependency Chain Tests
    needs: [setup-config, build-image]
    if: success()
    uses: ./.github/workflows/dependency-chain-tests.yml
    with:
      test_app_prefix: ${{ needs.setup-config.outputs.test_app_prefix }}
      region: ${{ needs.setup-config.outputs.region }}
      skip_cleanup: ${{ fromJSON(needs.setup-config.outputs.skip_cleanup) }}
      pre_built_image: ${{ needs.build-image.outputs.image-url }}
    secrets:
      FLYIO_AUTH_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

  # ============================================================================
  # PHASE 3: Infrastructure Tests (1 VM - Fail Fast)
  # ============================================================================

  infrastructure:
    name: Infrastructure Tests
    needs: [setup-config, build-image, dependency-chain]
    if: success()
    uses: ./.github/workflows/infrastructure-tests.yml
    with:
      test_app_prefix: ${{ needs.setup-config.outputs.test_app_prefix }}
      region: ${{ needs.setup-config.outputs.region }}
      skip_cleanup: ${{ fromJSON(needs.setup-config.outputs.skip_cleanup) }}
      pre_built_image: ${{ needs.build-image.outputs.image-url }}
    secrets:
      FLYIO_AUTH_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

  # ============================================================================
  # PHASE 4: Individual Extension Tests (N VMs, 3 Max Concurrent)
  # ============================================================================

  individual-extensions:
    name: Per-Extension Tests
    needs: [setup-config, build-image, infrastructure]
    if: success()
    uses: ./.github/workflows/per-extension-tests.yml
    with:
      test_app_prefix: ${{ needs.setup-config.outputs.test_app_prefix }}
      region: ${{ needs.setup-config.outputs.region }}
      skip_cleanup: ${{ fromJSON(needs.setup-config.outputs.skip_cleanup) }}
      pre_built_image: ${{ needs.build-image.outputs.image-url }}
    secrets:
      FLYIO_AUTH_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

  # ============================================================================
  # PHASE 5: Extension Combinations (N VMs, 3 Max Concurrent)
  # ============================================================================

  extension-combinations:
    name: Extension Combinations
    needs: [setup-config, build-image, individual-extensions]
    if: success()
    uses: ./.github/workflows/extension-combinations.yml
    with:
      test_app_prefix: ${{ needs.setup-config.outputs.test_app_prefix }}
      region: ${{ needs.setup-config.outputs.region }}
      skip_cleanup: ${{ fromJSON(needs.setup-config.outputs.skip_cleanup) }}
      pre_built_image: ${{ needs.build-image.outputs.image-url }}
    secrets:
      FLYIO_AUTH_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

  # ============================================================================
  # Summary
  # ============================================================================

  summary:
    name: Test Summary
    if: always()
    needs: [quick-checks, manager-validation, manifest-validation, dependency-chain, infrastructure, individual-extensions, extension-combinations]
    runs-on: ubuntu-latest

    steps:
      - name: Report results
        run: |
          echo "## ðŸ” Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Phase | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Quick Checks | ${{ needs.quick-checks.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Manager Validation | ${{ needs.manager-validation.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Manifest Validation | ${{ needs.manifest-validation.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Chain | ${{ needs.dependency-chain.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure Tests | ${{ needs.infrastructure.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Individual Extensions | ${{ needs.individual-extensions.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Extension Combinations | ${{ needs.extension-combinations.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.quick-checks.result }}" != "success" ] || \
             [ "${{ needs.manager-validation.result }}" != "success" ] || \
             [ "${{ needs.manifest-validation.result }}" != "success" ] || \
             [ "${{ needs.dependency-chain.result }}" != "success" ] || \
             [ "${{ needs.infrastructure.result }}" != "success" ] || \
             [ "${{ needs.individual-extensions.result }}" != "success" ] || \
             [ "${{ needs.extension-combinations.result }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **One or more test phases failed. Please check the individual job logs.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **All integration tests passed!**" >> $GITHUB_STEP_SUMMARY
          fi
