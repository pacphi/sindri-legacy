name: Cleanup Workflow Logs

on:
  schedule:
    # Run weekly on Sundays at 5:00 AM UTC (after other scheduled workflows)
    - cron: '0 5 * * 0'

  workflow_dispatch:
    inputs:
      runs_to_keep:
        description: 'Number of recent runs to keep per workflow (default branches)'
        required: false
        default: '3'
        type: string
      feature_branch_runs_to_keep:
        description: 'Number of runs to keep for feature branches'
        required: false
        default: '2'
        type: string
      branch_filter:
        description: 'Branch pattern to filter (e.g., "feature/*", "pr-*", or "all")'
        required: false
        default: 'all'
        type: string
      cleanup_deleted_branches:
        description: 'Clean up runs from deleted branches'
        required: false
        default: true
        type: boolean
      dry_run:
        description: 'Dry run mode (preview deletions without executing)'
        required: false
        default: false
        type: boolean

env:
  # Default number of runs to keep per workflow
  DEFAULT_RUNS_TO_KEEP: 3
  FEATURE_BRANCH_RUNS_TO_KEEP: 2
  # Protected branches that get higher retention
  PROTECTED_BRANCHES: 'main,develop'

jobs:
  cleanup:
    name: Clean up old workflow runs
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Cleanup workflow runs
        env:
          GH_TOKEN: ${{ github.token }}
          RUNS_TO_KEEP: ${{ inputs.runs_to_keep || env.DEFAULT_RUNS_TO_KEEP }}
          FEATURE_RUNS_TO_KEEP: ${{ inputs.feature_branch_runs_to_keep || env.FEATURE_BRANCH_RUNS_TO_KEEP }}
          BRANCH_FILTER: ${{ inputs.branch_filter || 'all' }}
          CLEANUP_DELETED_BRANCHES: ${{ inputs.cleanup_deleted_branches != false }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          set -euo pipefail

          echo "::group::Cleanup Configuration"
          echo "Protected branch runs to keep: $RUNS_TO_KEEP"
          echo "Feature branch runs to keep: $FEATURE_RUNS_TO_KEEP"
          echo "Branch filter: $BRANCH_FILTER"
          echo "Cleanup deleted branches: $CLEANUP_DELETED_BRANCHES"
          echo "Dry run mode: $DRY_RUN"
          echo "Protected branches: $PROTECTED_BRANCHES"
          echo "::endgroup::"

          # Helper function to check if branch is protected
          is_protected_branch() {
            local branch="$1"
            echo "$PROTECTED_BRANCHES" | grep -q -w "$branch"
          }

          # Helper function to check if branch exists
          branch_exists() {
            local branch="$1"
            gh api "repos/${{ github.repository }}/branches/$branch" &>/dev/null
          }

          # Helper function to match branch filter
          matches_filter() {
            local branch="$1"
            if [ "$BRANCH_FILTER" = "all" ]; then
              return 0
            fi
            # Simple glob matching
            case "$branch" in
              $BRANCH_FILTER) return 0 ;;
              *) return 1 ;;
            esac
          }

          # Get ALL completed runs (includes runs from deleted workflows)
          echo "::group::Fetching all workflow runs"
          all_runs=$(gh api "repos/${{ github.repository }}/actions/runs" \
            --paginate \
            --jq '.workflow_runs[] | select(.status == "completed") | {id: .id, workflow_id: .workflow_id, workflow_name: .name, branch: .head_branch, number: .run_number, created: .created_at}' 2>/dev/null || echo "")

          if [ -z "$all_runs" ]; then
            echo "No completed runs found"
            echo "::endgroup::"
            exit 0
          fi

          total_runs=$(echo "$all_runs" | wc -l | tr -d ' ')
          echo "Found $total_runs completed runs across all workflows"
          echo "::endgroup::"

          # Group runs by workflow_id + branch
          echo "::group::Grouping runs by workflow and branch"
          declare -A workflow_branch_runs
          declare -A workflow_names

          while IFS= read -r run; do
            workflow_id=$(echo "$run" | jq -r '.workflow_id')
            workflow_name=$(echo "$run" | jq -r '.workflow_name')
            branch=$(echo "$run" | jq -r '.branch')
            key="${workflow_id}:${branch}"

            # Cache workflow name (may be from deleted workflow)
            if [ -z "${workflow_names[$workflow_id]:-}" ]; then
              workflow_names[$workflow_id]="$workflow_name"
            fi

            if [ -z "${workflow_branch_runs[$key]:-}" ]; then
              workflow_branch_runs[$key]="$run"
            else
              workflow_branch_runs[$key]="${workflow_branch_runs[$key]}"$'\n'"$run"
            fi
          done <<< "$all_runs"

          echo "Found ${#workflow_branch_runs[@]} unique workflow+branch combinations"
          echo "::endgroup::"

          total_deleted=0
          total_kept=0
          deleted_from_deleted_branches=0
          declare -A branch_stats
          processed_workflows=0

          # Process each workflow+branch combination
          for key in "${!workflow_branch_runs[@]}"; do
            workflow_id="${key%%:*}"
            branch="${key#*:}"
            runs_for_key="${workflow_branch_runs[$key]}"
            workflow_name="${workflow_names[$workflow_id]}"

            # Verify workflow still exists (detect orphaned runs)
            workflow_exists=true
            if ! gh api "repos/${{ github.repository }}/actions/workflows/$workflow_id" --jq '.id' &>/dev/null; then
              workflow_exists=false
              workflow_name="$workflow_name (DELETED WORKFLOW)"
            fi

            echo "::group::Processing: $workflow_name (ID: $workflow_id, Branch: $branch)"

            if [ "$workflow_exists" = "false" ]; then
              echo "⚠️  Workflow file has been deleted (orphaned runs)"
            fi

            # Check if branch matches filter
            if ! matches_filter "$branch"; then
              echo "Skipping branch '$branch' (doesn't match filter)"
              echo "::endgroup::"
              continue
            fi

            # Check if branch still exists
            branch_deleted=false
            if [ "$CLEANUP_DELETED_BRANCHES" = "true" ]; then
              if ! branch_exists "$branch"; then
                branch_deleted=true
                echo "Branch '$branch' has been deleted"
              fi
            fi

            # Determine retention policy
            if [ "$branch_deleted" = "true" ]; then
              # Keep only 1 run for deleted branches (for historical reference)
              keep_count=1
              echo "Branch '$branch': Using deleted branch policy (keep $keep_count)"
            elif is_protected_branch "$branch"; then
              keep_count=$RUNS_TO_KEEP
              echo "Branch '$branch': Using protected branch policy (keep $keep_count)"
            else
              keep_count=$FEATURE_RUNS_TO_KEEP
              echo "Branch '$branch': Using feature branch policy (keep $keep_count)"
            fi

            # Convert to array (already sorted by created date, newest first)
            readarray -t run_data <<< "$runs_for_key"
            total_runs_for_key=${#run_data[@]}

            echo "Total runs: $total_runs_for_key (keeping $keep_count)"

            # Calculate runs to delete
            if [ "$total_runs_for_key" -le "$keep_count" ]; then
              echo "All runs will be kept (total runs <= retention count)"
              total_kept=$((total_kept + total_runs_for_key))
              branch_stats["$branch:kept"]=$((${branch_stats["$branch:kept"]:-0} + total_runs_for_key))
              echo "::endgroup::"
              continue
            fi

            # Keep first N runs, delete the rest
            deleted_count=0
            for ((i=$keep_count; i<$total_runs_for_key; i++)); do
              run=$(echo "${run_data[$i]}" | jq -c '.')
              run_id=$(echo "$run" | jq -r '.id')
              run_number=$(echo "$run" | jq -r '.number')
              created=$(echo "$run" | jq -r '.created')

              if [ "$DRY_RUN" = "true" ]; then
                echo "[DRY RUN] Would delete run #$run_number (created: $created)"
              else
                echo "Deleting run #$run_number (created: $created)"

                # Delete the run
                if gh api -X DELETE "repos/${{ github.repository }}/actions/runs/$run_id" --silent; then
                  deleted_count=$((deleted_count + 1))
                  if [ "$branch_deleted" = "true" ]; then
                    deleted_from_deleted_branches=$((deleted_from_deleted_branches + 1))
                  fi
                else
                  echo "Warning: Failed to delete run $run_id"
                fi

                # Small delay to avoid rate limiting
                sleep 0.5
              fi
            done

            total_deleted=$((total_deleted + deleted_count))
            total_kept=$((total_kept + keep_count))

            # Update branch statistics
            branch_stats["$branch:deleted"]=$((${branch_stats["$branch:deleted"]:-0} + deleted_count))
            branch_stats["$branch:kept"]=$((${branch_stats["$branch:kept"]:-0} + keep_count))

            if [ "$DRY_RUN" = "true" ]; then
              echo "Summary: Would delete $deleted_count runs, keep $keep_count runs"
            else
              echo "Summary: Deleted $deleted_count runs, kept $keep_count runs"
            fi

            processed_workflows=$((processed_workflows + 1))
            echo "::endgroup::"
          done

          # Final summary
          echo "::group::Cleanup Summary"
          if [ "$DRY_RUN" = "true" ]; then
            echo "DRY RUN MODE - No runs were actually deleted"
            echo "Would delete: $total_deleted runs"
            echo "Would keep: $total_kept runs"
            echo "From deleted branches: $deleted_from_deleted_branches runs"
          else
            echo "Total runs deleted: $total_deleted"
            echo "Total runs kept: $total_kept"
            echo "From deleted branches: $deleted_from_deleted_branches"
          fi
          echo "::endgroup::"

          # Create job summary
          {
            echo "# Workflow Logs Cleanup Summary"
            echo ""
            if [ "$DRY_RUN" = "true" ]; then
              echo "**Mode:** Dry Run (preview only)"
              echo ""
              echo "- Runs that would be deleted: **$total_deleted**"
              echo "- Runs that would be kept: **$total_kept**"
              echo "- From deleted branches: **$deleted_from_deleted_branches**"
            else
              echo "**Mode:** Execution"
              echo ""
              echo "- Runs deleted: **$total_deleted**"
              echo "- Runs kept: **$total_kept**"
              echo "- From deleted branches: **$deleted_from_deleted_branches**"
            fi
            echo ""
            echo "**Configuration:**"
            echo "- Protected branch retention: **$RUNS_TO_KEEP**"
            echo "- Feature branch retention: **$FEATURE_RUNS_TO_KEEP**"
            echo "- Branch filter: **$BRANCH_FILTER**"
            echo "- Cleanup deleted branches: **$CLEANUP_DELETED_BRANCHES**"
            echo "- Total runs analyzed: **$total_runs**"
            echo "- Workflow+branch combinations processed: **$processed_workflows**"
            echo ""
            echo "## Per-Branch Statistics"
            echo ""
            echo "| Branch | Deleted | Kept |"
            echo "|--------|---------|------|"

            # Sort branches and display stats
            for key in "${!branch_stats[@]}"; do
              echo "$key"
            done | cut -d: -f1 | sort -u | while read -r branch; do
              deleted=${branch_stats["$branch:deleted"]:-0}
              kept=${branch_stats["$branch:kept"]:-0}
              echo "| \`$branch\` | $deleted | $kept |"
            done
          } >> $GITHUB_STEP_SUMMARY
