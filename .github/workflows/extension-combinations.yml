name: Extension Combinations Tests

on:
  workflow_call:
    inputs:
      test_app_prefix:
        description: "Test app prefix"
        required: false
        default: "ext-test"
        type: string
      region:
        description: "Fly.io region"
        required: false
        default: "sjc"
        type: string
      skip_cleanup:
        description: "Skip cleanup for debugging"
        required: false
        default: false
        type: boolean
      pre_built_image:
        description: "Pre-built Docker image URL (optional)"
        required: false
        default: ""
        type: string
    secrets:
      FLYIO_AUTH_TOKEN:
        required: true
      ANTHROPIC_API_KEY:
        required: false

permissions:
  contents: read

jobs:
  extension-combinations:
    name: Test Combination - ${{ matrix.combination.name }}
    runs-on: ubuntu-latest
    timeout-minutes: 120
    permissions:
      contents: read
    # Only run on workflow_dispatch or when explicitly requested via commit message
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[test-combinations]')

    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        combination:
          - {
              name: "mise-stack",
              extensions: "nodejs,python,rust,golang",
              description: "mise-Powered Languages (mise pre-installed in base image)",
            }
          - {
              name: "full-node",
              extensions: "nodejs,nodejs-devtools",
              description: "Complete Node.js Development Stack",
            }
          - {
              name: "fullstack",
              extensions: "nodejs,python,docker,cloud-tools",
              description: "Node.js + Python + Docker + Cloud",
            }
          - { name: "systems", extensions: "rust,golang,docker", description: "Rust + Go + Docker" }
          - {
              name: "enterprise",
              extensions: "nodejs,jvm,docker,infra-tools",
              description: "JVM + Docker + Infrastructure",
            }
          - {
              name: "ai-dev",
              extensions: "nodejs,python,ai-tools,monitoring",
              description: "Node.js + Python + AI Tools + Monitoring",
            }

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      # Using composite action for setup
      - name: Setup Fly.io test environment
        id: setup
        uses: ./.github/actions/setup-fly-test-env
        with:
          app-prefix: ${{ inputs.test_app_prefix }}
          extension-name: ${{ matrix.combination.name }}
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}
          region: ${{ inputs.region }}
          vm-memory: "16384"
          vm-cpu-kind: "performance"
          vm-cpu-count: "4"
          volume-size: "20"

      # Using composite action for deployment (includes retry logic)
      - name: Deploy test environment
        uses: ./.github/actions/deploy-fly-app
        with:
          app-name: ${{ steps.setup.outputs.app-name }}
          region: ${{ inputs.region }}
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}
          deploy-timeout: "600"
          max-deploy-attempts: "3"
          pre-built-image: ${{ inputs.pre_built_image }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          ci-mode: "true"

      # Using composite action for waiting
      - name: Wait for deployment
        uses: ./.github/actions/wait-fly-deployment
        with:
          app-name: ${{ steps.setup.outputs.app-name }}
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}
          timeout-seconds: "420"
          expected-status: "started"

      - name: Add extension combination to manifest
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          # Source retry utilities
          source "${GITHUB_WORKSPACE}/.github/scripts/lib/ssh-helpers.sh"

          app_name="${{ steps.setup.outputs.app-name }}"
          extensions="${{ matrix.combination.extensions }}"

          echo "Adding extensions to manifest: $extensions"

          # Execute with retry
          ssh_command_retry "$app_name" "/bin/bash -lc '
            cd /workspace/.system
            manifest_file=\"manifest/active-extensions.conf\"
            failed_extensions=()

            # Create manifest from CI template if needed
            if [ ! -f \"\$manifest_file\" ]; then
              cp extensions.d/active-extensions.ci.conf \"\$manifest_file\" 2>/dev/null || touch \"\$manifest_file\"
            fi

            # Add combination extensions
            echo \"\"
            echo \"Adding combination extensions...\"
            IFS=\",\" read -ra EXT_ARRAY <<< \"$extensions\"

            for ext in \"\${EXT_ARRAY[@]}\"; do
              ext=\$(echo \"\$ext\" | xargs)  # Trim whitespace

              if ! grep -q \"^\$ext\$\" \"\$manifest_file\" 2>/dev/null; then
                echo \"\$ext\" >> \"\$manifest_file\"
                echo \"✅ \$ext added to manifest\"
              else
                echo \"✅ \$ext already in manifest\"
              fi
            done

            echo \"\"
            echo \"=== Extensions in Manifest ===\"
            grep -v \"^[[:space:]]*#\" \"\$manifest_file\" | grep -v \"^[[:space:]]*$\" || echo \"(empty)\"
          '"

      - name: Install all extensions from manifest
        timeout-minutes: 60
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          # Source retry utilities
          source "${GITHUB_WORKSPACE}/.github/scripts/lib/ssh-helpers.sh"

          app_name="${{ steps.setup.outputs.app-name }}"

          echo "Installing all extensions for ${{ matrix.combination.name }} combination..."

          # Execute with retry
          ssh_command_retry "$app_name" "/bin/bash -lc '
            cd /workspace/.system

            echo \"Running install-all...\"
            if extension-manager install-all; then
              echo \"✅ All extensions installed\"
            else
              echo \"❌ Extension installation failed\"
              exit 1
            fi
          '"

      - name: Verify extension combination functionality
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          # Source retry utilities
          source "${GITHUB_WORKSPACE}/.github/scripts/lib/ssh-helpers.sh"

          app_name="${{ steps.setup.outputs.app-name }}"
          combination_name="${{ matrix.combination.name }}"

          echo "Verifying $combination_name combination functionality..."

          # Execute with retry
          ssh_command_retry "$app_name" "/bin/bash -lc '
            # Source SSH environment
            if [ -f /etc/profile.d/00-ssh-environment.sh ]; then
              source /etc/profile.d/00-ssh-environment.sh
            fi

            case \"$combination_name\" in
              core-stack)
                echo \"Testing core extensions...\"
                [ -d /workspace/projects ] || exit 1
                mise --version
                [ -f /etc/profile.d/00-ssh-environment.sh ] || exit 1
                ;;
              mise-stack)
                echo \"Testing mise-powered stack...\"
                mise --version
                node --version && npm --version
                python3 --version
                rustc --version && cargo --version
                go version
                ;;
              full-node)
                echo \"Testing full Node.js stack...\"
                node --version && npm --version
                npx tsc --version
                npx eslint --version
                npx prettier --version
                command -v claude >/dev/null 2>&1 && echo \"✅ Claude CLI available\" || echo \"⚠️  Claude CLI not in PATH\"
                ;;
              fullstack)
                echo \"Testing Python + Docker + Cloud combination...\"
                python3 --version && docker --version && node --version
                ;;
              systems)
                echo \"Testing Rust + Go + Docker combination...\"
                rustc --version && go version && docker --version
                ;;
              enterprise)
                echo \"Testing JVM + Docker + Infrastructure combination...\"
                java -version && terraform version && docker --version && node --version
                ;;
              ai-dev)
                echo \"Testing Python + AI Tools + Monitoring combination...\"
                python3 --version && node --version
                ollama --version || echo \"⚠️  ollama not ready\"
                command -v claude-monitor >/dev/null 2>&1 && echo \"✅ Monitoring available\" || echo \"⚠️  Monitoring not in PATH\"
                ;;
            esac

            echo \"✅ Cross-extension functionality verified\"
          '"

      # Using composite action for cleanup
      - name: Cleanup test resources
        if: always() && !inputs.skip_cleanup
        uses: ./.github/actions/cleanup-fly-app
        with:
          app-name: ${{ steps.setup.outputs.app-name }}
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}
