name: Test Secrets Management

on:
  pull_request:
    paths:
      - 'docker/scripts/setup-secrets.sh'
      - 'docker/scripts/install-sops-age.sh'
      - 'docker/lib/extensions.d/claude-auth-with-api-key/**'
      - 'docker/lib/extensions.d/github-cli/github-cli.extension'
      - 'docker/lib/extensions.d/nodejs-devtools/nodejs-devtools.extension'
      - 'docker/lib/extensions.d/ai-tools/ai-tools.extension'
      - 'docker/lib/extensions.d/cloud-tools/cloud-tools.extension'
      - '.github/scripts/test-secrets-management.sh'
      - '.github/workflows/test-secrets-management.yml'
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App name for test VM (optional, auto-generated if not provided)'
        required: false
        type: string
  workflow_call:
    inputs:
      app_name:
        description: 'App name for test VM (optional, auto-generated if not provided)'
        required: false
        type: string
    secrets:
      FLYIO_AUTH_TOKEN:
        description: 'Fly.io API token for deployment'
        required: true

env:
  FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}

jobs:
  test-secrets-management:
    name: Test Secrets Management Implementation
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Generate unique app name
        id: app-name
        run: |
          if [ -n "${{ inputs.app_name }}" ]; then
            APP_NAME="${{ inputs.app_name }}"
          else
            APP_NAME="sindri-secrets-test-${{ github.run_number }}-$(date +%s | tail -c 5)"
          fi
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "Testing with app: $APP_NAME"

      - name: Generate SSH key for deployment
        run: |
          echo "Generating SSH key pair for test deployment..."
          ssh-keygen -t ed25519 -f test_key -N "" -q
          echo "✅ SSH key generated"

      - name: Deploy test VM
        uses: ./.github/actions/deploy-fly-app
        with:
          app-name: ${{ steps.app-name.outputs.app_name }}
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}
          anthropic-api-key: sk-ant-test-key-for-ci-testing
          ci-mode: true

      - name: Set additional test secrets
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          APP_NAME="${{ steps.app-name.outputs.app_name }}"

          echo "Setting additional test secrets..."
          flyctl secrets set \
            GITHUB_TOKEN=ghp_test_token_for_ci_testing \
            PERPLEXITY_API_KEY=pplx-test-key-for-ci-testing \
            GOOGLE_GEMINI_API_KEY=test-gemini-key-for-ci \
            AWS_ACCESS_KEY_ID=test-aws-access-key \
            AWS_SECRET_ACCESS_KEY=test-aws-secret-key \
            -a "$APP_NAME"

          echo "✓ Additional secrets configured"

      - name: Wait for VM to be ready
        run: |
          APP_NAME="${{ steps.app-name.outputs.app_name }}"
          echo "Waiting for VM to be ready and secrets system initialized..."

          max_attempts=60
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt/$max_attempts: Checking VM readiness..."

            # Check if VM is running
            if ! flyctl status -a "$APP_NAME" 2>/dev/null | grep -q "running"; then
              echo "  VM not running yet..."
              sleep 5
              attempt=$((attempt + 1))
              continue
            fi

            # Check if secrets system is initialized
            if flyctl ssh console -a "$APP_NAME" -C "test -f ~/.secrets/lib.sh && echo 'ready'" 2>/dev/null | grep -q "ready"; then
              echo "✅ VM is ready and secrets system initialized"
              break
            fi

            if [ $attempt -eq $max_attempts ]; then
              echo "❌ VM did not become ready in time"
              exit 1
            fi

            echo "  Secrets system not initialized yet..."
            sleep 5
            attempt=$((attempt + 1))
          done

      - name: Copy test script to VM
        run: |
          APP_NAME="${{ steps.app-name.outputs.app_name }}"

          echo "Copying test script to VM using base64 encoding..."

          # Create directory
          flyctl ssh console -a "$APP_NAME" -C "mkdir -p /workspace/test-scripts"

          # Encode script and transfer via base64 (more reliable than pipes)
          base64 .github/scripts/test-secrets-management.sh | flyctl ssh console -a "$APP_NAME" -C \
            '/bin/bash -c "base64 -d > /workspace/test-scripts/test-secrets-management.sh"'

          # Verify transfer and make executable
          flyctl ssh console -a "$APP_NAME" -C "chmod +x /workspace/test-scripts/test-secrets-management.sh && \
            wc -l /workspace/test-scripts/test-secrets-management.sh"

          echo "✅ Test script transferred successfully"

      - name: Run secrets management tests
        id: run-tests
        run: |
          APP_NAME="${{ steps.app-name.outputs.app_name }}"

          echo "Running secrets management test suite..."

          # Run tests with retry logic for transient failures
          max_attempts=3
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            echo "Test execution attempt $attempt/$max_attempts..."

            if flyctl ssh console -a "$APP_NAME" -C "/workspace/test-scripts/test-secrets-management.sh"; then
              echo "✅ Tests completed successfully"
              exit 0
            else
              exit_code=$?
              echo "⚠️  Tests failed with exit code $exit_code"

              if [ $attempt -lt $max_attempts ]; then
                echo "Retrying in 5 seconds..."
                sleep 5
                attempt=$((attempt + 1))
              else
                echo "❌ Tests failed after $max_attempts attempts"
                exit 1
              fi
            fi
          done

      - name: Run additional verification checks
        run: |
          APP_NAME="${{ steps.app-name.outputs.app_name }}"

          echo "Running consolidated verification checks..."

          # Run all verification checks in a single SSH session for efficiency
          flyctl ssh console -a "$APP_NAME" -C '/bin/bash -c "
            set -e
            echo \"=== Verifying SOPS and age installation ===\"
            sops --version
            age --version
            echo \"\"

            echo \"=== Checking encrypted secrets file ===\"
            ls -la ~/.secrets/
            if grep -q \"sops:\" ~/.secrets/secrets.enc.yaml 2>/dev/null; then
              echo \"✓ File is encrypted with SOPS\"
            else
              echo \"✗ ERROR: File not encrypted\"
              exit 1
            fi
            echo \"\"

            echo \"=== Verifying environment cleanup ===\"
            if env | grep -qE \"ANTHROPIC_API_KEY|GITHUB_TOKEN|PERPLEXITY_API_KEY\"; then
              echo \"✗ ERROR: Secrets found in environment!\"
              exit 1
            else
              echo \"✓ Environment is clean\"
            fi
            echo \"\"

            echo \"=== Checking .bashrc cleanup ===\"
            if grep -qE \"ANTHROPIC_API_KEY|GITHUB_TOKEN\" ~/.bashrc 2>/dev/null; then
              echo \"✗ ERROR: Secrets in .bashrc!\"
              exit 1
            else
              echo \"✓ .bashrc is clean\"
            fi
            echo \"\"

            echo \"=== Testing extension secret metadata ===\"
            if grep -q \"EXT_REQUIRED_SECRETS\" /docker/lib/extensions.d/claude-auth-with-api-key/claude-auth-with-api-key.extension; then
              echo \"✓ Claude auth extension has secret metadata\"
            else
              echo \"✗ Claude auth extension missing secret metadata\"
              exit 1
            fi

            if grep -q \"EXT_REQUIRED_SECRETS\" /docker/lib/extensions.d/github-cli/github-cli.extension; then
              echo \"✓ GitHub CLI extension has secret metadata\"
            else
              echo \"✗ GitHub CLI extension missing secret metadata\"
              exit 1
            fi
            echo \"\"

            echo \"=== Testing user commands ===\"
            type view-secrets || exit 1
            type with-secrets || exit 1
            echo \"✓ User commands available\"
            echo \"\"

            echo \"✅ All verification checks passed\"
          "'

          echo "✅ Additional verifications completed successfully"

      - name: Cleanup test VM
        if: always()
        uses: ./.github/actions/cleanup-fly-app
        with:
          app-name: ${{ steps.app-name.outputs.app_name }}
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: test-secrets-management
    if: always()

    steps:
      - name: Report results
        run: |
          if [ "${{ needs.test-secrets-management.result }}" == "success" ]; then
            echo "✅ All secrets management tests passed!"
            exit 0
          else
            echo "❌ Secrets management tests failed"
            exit 1
          fi
