name: Test Secrets Management

on:
  pull_request:
    paths:
      - 'docker/scripts/setup-secrets.sh'
      - 'docker/scripts/install-sops-age.sh'
      - 'docker/lib/extensions.d/claude-auth-with-api-key/**'
      - 'docker/lib/extensions.d/github-cli/github-cli.extension'
      - 'docker/lib/extensions.d/nodejs-devtools/nodejs-devtools.extension'
      - 'docker/lib/extensions.d/ai-tools/ai-tools.extension'
      - 'docker/lib/extensions.d/cloud-tools/cloud-tools.extension'
      - '.github/scripts/test-secrets-management.sh'
      - '.github/workflows/test-secrets-management.yml'
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App name for test VM (optional, auto-generated if not provided)'
        required: false
        type: string
  workflow_call:
    inputs:
      app_name:
        description: 'App name for test VM (optional, auto-generated if not provided)'
        required: false
        type: string
    secrets:
      FLYIO_AUTH_TOKEN:
        description: 'Fly.io API token for deployment'
        required: true

env:
  FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}

jobs:
  test-secrets-management:
    name: Test Secrets Management Implementation
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Generate unique app name
        id: app-name
        run: |
          if [ -n "${{ inputs.app_name }}" ]; then
            APP_NAME="${{ inputs.app_name }}"
          else
            APP_NAME="sindri-secrets-test-${{ github.run_number }}-$(date +%s | tail -c 5)"
          fi
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "Testing with app: $APP_NAME"

      - name: Deploy test VM
        uses: ./.github/actions/deploy-fly-app
        with:
          app-name: ${{ steps.app-name.outputs.app_name }}
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}
          anthropic-api-key: sk-ant-test-key-for-ci-testing
          ci-mode: true

      - name: Set additional test secrets
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          APP_NAME="${{ steps.app-name.outputs.app_name }}"

          echo "Setting additional test secrets..."
          flyctl secrets set \
            GITHUB_TOKEN=ghp_test_token_for_ci_testing \
            PERPLEXITY_API_KEY=pplx-test-key-for-ci-testing \
            GOOGLE_GEMINI_API_KEY=test-gemini-key-for-ci \
            AWS_ACCESS_KEY_ID=test-aws-access-key \
            AWS_SECRET_ACCESS_KEY=test-aws-secret-key \
            -a "$APP_NAME"

          echo "✓ Additional secrets configured"

      - name: Wait for VM to be ready
        run: |
          APP_NAME="${{ steps.app-name.outputs.app_name }}"
          echo "Waiting for VM to be ready..."

          for i in {1..30}; do
            if flyctl status -a "$APP_NAME" | grep -q "running"; then
              echo "VM is running"
              sleep 10  # Additional wait for secrets setup
              break
            fi
            echo "Attempt $i/30: Waiting..."
            sleep 10
          done

      - name: Copy test script to VM
        run: |
          APP_NAME="${{ steps.app-name.outputs.app_name }}"

          # Copy test script
          flyctl ssh console -a "$APP_NAME" -C "mkdir -p /workspace/test-scripts"
          cat .github/scripts/test-secrets-management.sh | \
            flyctl ssh console -a "$APP_NAME" -C "cat > /workspace/test-scripts/test-secrets-management.sh"

          # Make executable
          flyctl ssh console -a "$APP_NAME" -C "chmod +x /workspace/test-scripts/test-secrets-management.sh"

      - name: Run secrets management tests
        id: run-tests
        run: |
          APP_NAME="${{ steps.app-name.outputs.app_name }}"

          echo "Running secrets management test suite..."
          flyctl ssh console -a "$APP_NAME" -C "/workspace/test-scripts/test-secrets-management.sh" || {
            echo "Tests failed"
            exit 1
          }

      - name: Verify SOPS and age installation
        run: |
          APP_NAME="${{ steps.app-name.outputs.app_name }}"

          echo "Verifying SOPS installation..."
          flyctl ssh console -a "$APP_NAME" -C "sops --version"

          echo "Verifying age installation..."
          flyctl ssh console -a "$APP_NAME" -C "age --version"

      - name: Verify secrets encryption
        run: |
          APP_NAME="${{ steps.app-name.outputs.app_name }}"

          echo "Checking encrypted secrets file..."
          flyctl ssh console -a "$APP_NAME" -C "ls -la ~/.secrets/"

          echo "Verifying encryption (should contain SOPS metadata)..."
          flyctl ssh console -a "$APP_NAME" -C "cat ~/.secrets/secrets.enc.yaml | grep -q 'sops:' && echo 'File is encrypted' || echo 'ERROR: File not encrypted'"

      - name: Verify environment cleanup
        run: |
          APP_NAME="${{ steps.app-name.outputs.app_name }}"

          echo "Checking environment variables (should be clean)..."
          flyctl ssh console -a "$APP_NAME" -C "env | grep -E 'ANTHROPIC_API_KEY|GITHUB_TOKEN|PERPLEXITY_API_KEY' && echo 'ERROR: Secrets in environment!' && exit 1 || echo 'Environment is clean'"

      - name: Verify .bashrc cleanup
        run: |
          APP_NAME="${{ steps.app-name.outputs.app_name }}"

          echo "Checking .bashrc (should not contain secrets)..."
          flyctl ssh console -a "$APP_NAME" -C "grep -E 'ANTHROPIC_API_KEY|GITHUB_TOKEN' ~/.bashrc && echo 'ERROR: Secrets in .bashrc!' && exit 1 || echo '.bashrc is clean'"

      - name: Test extension secret loading
        run: |
          APP_NAME="${{ steps.app-name.outputs.app_name }}"

          echo "Testing Claude auth extension secret metadata..."
          flyctl ssh console -a "$APP_NAME" -C "grep -q 'EXT_REQUIRED_SECRETS' /docker/lib/extensions.d/claude-auth-with-api-key/claude-auth-with-api-key.extension && echo 'Claude auth extension has secret metadata' || exit 1"

          echo "Testing GitHub CLI extension secret metadata..."
          flyctl ssh console -a "$APP_NAME" -C "grep -q 'EXT_REQUIRED_SECRETS' /docker/lib/extensions.d/github-cli/github-cli.extension && echo 'GitHub CLI extension has secret metadata' || exit 1"

      - name: Test user commands
        run: |
          APP_NAME="${{ steps.app-name.outputs.app_name }}"

          echo "Testing view-secrets command..."
          flyctl ssh console -a "$APP_NAME" -C "type view-secrets"

          echo "Testing with-secrets command..."
          flyctl ssh console -a "$APP_NAME" -C "type with-secrets"

      - name: Cleanup test VM
        if: always()
        uses: ./.github/actions/cleanup-fly-app
        with:
          app-name: ${{ steps.app-name.outputs.app_name }}
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: test-secrets-management
    if: always()

    steps:
      - name: Report results
        run: |
          if [ "${{ needs.test-secrets-management.result }}" == "success" ]; then
            echo "✅ All secrets management tests passed!"
            exit 0
          else
            echo "❌ Secrets management tests failed"
            exit 1
          fi
