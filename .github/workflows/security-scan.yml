name: Security Scan

on:
  schedule:
    - cron: '0 2 * * 2'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

      - name: Check for secrets with GitLeaks
        run: |
          echo "Scanning for potential secrets with GitLeaks..."

          wget https://github.com/gitleaks/gitleaks/releases/download/v8.28.0/gitleaks_8.28.0_linux_x64.tar.gz
          tar xzf gitleaks_8.28.0_linux_x64.tar.gz
          sudo mv gitleaks /usr/local/bin/

          cat > .gitleaks.toml << 'EOF'
          [extend]
          useDefault = true

          [[rules]]
          description = "Ignore test and example secrets"
          id = "test-secrets"
          regex = '''(?i)(test|example|sample|placeholder|dummy|fake|mock)'''
          path = '''(test|spec|example|sample|docs?|readme)'''

          [allowlist]
          description = "Ignore false positives"
          paths = [
            '''docs/.*''',
            '''README\.md''',
            '''.*\.md''',
            '''.*\.example$''',
            '''.*\.template$''',
            '''\.cache/.*'''
          ]
          regexes = [
            '''ssh-rsa''',
            '''ssh-ed25519''',
            '''(?i)(test|example|sample|placeholder|dummy|fake|mock)'''
          ]
          EOF

          if gitleaks detect --config .gitleaks.toml --verbose --no-git --source . --report-format json --report-path gitleaks-report.json; then
            echo "✅ No secrets detected by GitLeaks"
          else
            echo "❌ Potential secrets found in repository"
            if [ -f gitleaks-report.json ]; then
              echo "GitLeaks findings:"
              cat gitleaks-report.json
            fi
            exit 1
          fi
