name: "Setup Fly.io Test Environment"
description: "Prepares environment for Fly.io extension testing (checkout, Fly CLI, SSH keys, app naming)"

inputs:
  app-prefix:
    description: 'Prefix for test app name (e.g., "ext-test")'
    required: true
  extension-name:
    description: "Extension name for app naming (will be sanitized)"
    required: false
    default: "generic"
  fly-api-token:
    description: "Fly.io API token"
    required: true
  resource-tier:
    description: "Resource tier (minimal/standard/heavy/xheavy). If specified, overrides individual resource parameters."
    required: false
    default: ""
  vm-memory:
    description: "VM memory in MB (ignored if resource-tier is set)"
    required: false
    default: "8192"
  vm-cpu-kind:
    description: "CPU kind (performance or shared) (ignored if resource-tier is set)"
    required: false
    default: "performance"
  vm-cpu-count:
    description: "Number of CPUs (ignored if resource-tier is set)"
    required: false
    default: "4"
  volume-name:
    description: "Volume name"
    required: false
    default: "test_data"
  volume-size:
    description: "Volume size in GB (ignored if resource-tier is set)"
    required: false
    default: "20"
  region:
    description: "Fly.io region"
    required: false
    default: "sjc"

outputs:
  app-name:
    description: "Generated app name for testing"
    value: ${{ steps.generate-app-name.outputs.app_name }}
  ssh-key-path:
    description: "Path to generated SSH private key"
    value: "test_key"
  ssh-pubkey-path:
    description: "Path to generated SSH public key"
    value: "test_key.pub"
  vm-memory:
    description: "VM memory in MB"
    value: ${{ steps.resources.outputs.vm_memory }}
  cpu-kind:
    description: "CPU kind (shared or performance)"
    value: ${{ steps.resources.outputs.cpu_kind }}
  cpu-count:
    description: "Number of CPUs"
    value: ${{ steps.resources.outputs.cpu_count }}
  volume-size:
    description: "Volume size in GB"
    value: ${{ steps.resources.outputs.volume_size }}

runs:
  using: "composite"
  steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Install Fly CLI
      uses: superfly/flyctl-actions/setup-flyctl@master

    - name: Generate test app name
      id: generate-app-name
      shell: bash
      run: |
        timestamp=$(date +%s)
        # Sanitize extension name for Fly.io app naming requirements:
        # - Only lowercase alphanumeric characters and hyphens
        # - Replace special characters (â†’, spaces, etc.) with hyphens
        # - Avoid abuse filter (e.g., "github" -> "gh")
        extension_name="${{ inputs.extension-name }}"
        extension_name="${extension_name//github/gh}"
        extension_name="${extension_name//â†’/-}"          # Replace arrow
        extension_name="${extension_name// /-}"          # Replace spaces
        extension_name="${extension_name//+/-}"          # Replace plus signs
        extension_name=$(echo "$extension_name" | tr -cd 'a-zA-Z0-9-')  # Remove other special chars
        extension_name=$(echo "$extension_name" | tr '[:upper:]' '[:lower:]')  # Lowercase
        extension_name=$(echo "$extension_name" | sed 's/-\+/-/g')     # Collapse multiple hyphens
        app_name="${{ inputs.app-prefix }}-${extension_name}-${timestamp}"
        echo "app_name=$app_name" >> $GITHUB_OUTPUT
        echo "Generated test app name: $app_name"

    - name: Create test SSH key
      shell: bash
      run: |
        ssh-keygen -t ed25519 -f test_key -N "" -C "ext-test"
        chmod 600 test_key
        chmod 644 test_key.pub
        echo "âœ… SSH key pair created"

    - name: Determine resource configuration
      id: resources
      shell: bash
      run: |
        TIER="${{ inputs.resource-tier }}"

        # If resource tier is specified, set resources based on tier
        # Otherwise, use individual parameters (backward compatible)
        if [ -n "$TIER" ]; then
          echo "Using resource tier: $TIER"
          case "$TIER" in
            minimal)
              VM_MEMORY="1024"
              CPU_KIND="shared"
              CPU_COUNT="1"
              VOLUME_SIZE="10"
              echo "ðŸ“¦ Minimal tier: 1GB RAM, 1 shared CPU, 10GB disk"
              ;;
            standard)
              VM_MEMORY="4096"
              CPU_KIND="shared"
              CPU_COUNT="2"
              VOLUME_SIZE="20"
              echo "ðŸ“¦ Standard tier: 4GB RAM, 2 shared CPUs, 20GB disk"
              ;;
            heavy)
              VM_MEMORY="8192"
              CPU_KIND="performance"
              CPU_COUNT="4"
              VOLUME_SIZE="20"
              echo "ðŸ“¦ Heavy tier: 8GB RAM, 4 performance CPUs, 20GB disk"
              ;;
            xheavy)
              VM_MEMORY="16384"
              CPU_KIND="performance"
              CPU_COUNT="4"
              VOLUME_SIZE="30"
              echo "ðŸ“¦ XHeavy tier: 16GB RAM, 4 performance CPUs, 30GB disk"
              ;;
            *)
              echo "âŒ Invalid resource tier: $TIER"
              echo "Valid tiers: minimal, standard, heavy, xheavy"
              exit 1
              ;;
          esac
        else
          echo "Using individual resource parameters (backward compatible mode)"
          VM_MEMORY="${{ inputs.vm-memory }}"
          CPU_KIND="${{ inputs.vm-cpu-kind }}"
          CPU_COUNT="${{ inputs.vm-cpu-count }}"
          VOLUME_SIZE="${{ inputs.volume-size }}"
          echo "ðŸ“¦ Custom: ${VM_MEMORY}MB RAM, ${CPU_COUNT} ${CPU_KIND} CPUs, ${VOLUME_SIZE}GB disk"
        fi

        # Export to GITHUB_OUTPUT for use in subsequent steps
        echo "vm_memory=$VM_MEMORY" >> $GITHUB_OUTPUT
        echo "cpu_kind=$CPU_KIND" >> $GITHUB_OUTPUT
        echo "cpu_count=$CPU_COUNT" >> $GITHUB_OUTPUT
        echo "volume_size=$VOLUME_SIZE" >> $GITHUB_OUTPUT

    - name: Prepare fly.toml for testing
      shell: bash
      env:
        FLY_API_TOKEN: ${{ inputs.fly-api-token }}
        APP_NAME: ${{ steps.generate-app-name.outputs.app_name }}
        REGION: ${{ inputs.region }}
        VOLUME_NAME: ${{ inputs.volume-name }}
        VOLUME_SIZE: ${{ steps.resources.outputs.volume_size }}
        VM_MEMORY: ${{ steps.resources.outputs.vm_memory }}
        CPU_KIND: ${{ steps.resources.outputs.cpu_kind }}
        CPU_COUNT: ${{ steps.resources.outputs.cpu_count }}
        CI_MODE: "true"
      run: |
        ./scripts/prepare-fly-config.sh --ci-mode
        echo "âœ… fly.toml prepared for testing"
