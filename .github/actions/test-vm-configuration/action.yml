name: "Test VM Configuration"
description: "Tests VM configuration, tools, and extension system"

inputs:
  app-name:
    description: "Fly.io app name"
    required: true
  fly-api-token:
    description: "Fly.io API token"
    required: true
  required-tools:
    description: 'Comma-separated list of required tools to check (e.g., "curl,git,ssh")'
    required: false
    default: "curl,git,ssh"
  user:
    description: "SSH user"
    required: false
    default: "developer"
  expected-memory-mb:
    description: "Expected memory in MB (e.g., 1024, 4096, 8192). If provided, will verify actual matches expected."
    required: false
    default: ""
  expected-cpus:
    description: "Expected number of CPUs (e.g., 1, 2, 4). If provided, will verify actual matches expected."
    required: false
    default: ""
  expected-cpu-kind:
    description: "Expected CPU kind (shared or performance). If provided, will verify."
    required: false
    default: ""
  expected-volume-size:
    description: "Expected volume size in GB. If provided, will verify."
    required: false
    default: ""

outputs:
  status:
    description: "Test status (success or failure)"
    value: ${{ steps.test.outputs.status }}

runs:
  using: "composite"
  steps:
    - name: Test VM configuration
      id: test
      shell: bash
      env:
        FLY_API_TOKEN: ${{ inputs.fly-api-token }}
      run: |
        echo "Testing VM configuration, tools, and extension system..."

        app_name="${{ inputs.app-name }}"
        user="${{ inputs.user }}"
        script_path=".github/scripts/infrastructure/test-vm-configuration.sh"
        vm_script_path="/tmp/test-vm-configuration.sh"

        # Verify local script exists
        if [ ! -f "$script_path" ]; then
          echo "âŒ Script not found: $script_path"
          echo "status=failure" >> $GITHUB_OUTPUT
          exit 1
        fi

        # Copy script to VM via SFTP
        echo "ðŸ“¤ Copying test script to VM..."
        flyctl ssh sftp shell --app $app_name <<SFTP_EOF
          put $script_path $vm_script_path
          quit
        SFTP_EOF

        if [ $? -ne 0 ]; then
          echo "âŒ Failed to copy script to VM"
          echo "status=failure" >> $GITHUB_OUTPUT
          exit 1
        fi

        echo "âœ… Script copied successfully"
        echo ""

        # Execute script on VM with environment variables
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸ” Testing VM Configuration"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

        if flyctl ssh console --app $app_name --user $user -C "/bin/bash -c 'export REQUIRED_TOOLS=\"${{ inputs.required-tools }}\" EXPECTED_MEMORY_MB=\"${{ inputs.expected-memory-mb }}\" EXPECTED_CPUS=\"${{ inputs.expected-cpus }}\" EXPECTED_CPU_KIND=\"${{ inputs.expected-cpu-kind }}\" EXPECTED_VOLUME_SIZE=\"${{ inputs.expected-volume-size }}\"; bash $vm_script_path'"; then
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… VM configuration test passed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "status=success" >> $GITHUB_OUTPUT
          exit 0
        else
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ VM configuration test failed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "status=failure" >> $GITHUB_OUTPUT
          exit 1
        fi
