name: "Test VM Configuration"
description: "Tests VM configuration, tools, and extension system"

inputs:
  app-name:
    description: "Fly.io app name"
    required: true
  fly-api-token:
    description: "Fly.io API token"
    required: true
  required-tools:
    description: 'Comma-separated list of required tools to check (e.g., "curl,git,ssh")'
    required: false
    default: "curl,git,ssh"
  user:
    description: "SSH user"
    required: false
    default: "developer"
  expected-memory-mb:
    description: "Expected memory in MB (e.g., 1024, 4096, 8192). If provided, will verify actual matches expected."
    required: false
    default: ""
  expected-cpus:
    description: "Expected number of CPUs (e.g., 1, 2, 4). If provided, will verify actual matches expected."
    required: false
    default: ""
  expected-cpu-kind:
    description: "Expected CPU kind (shared or performance). If provided, will verify."
    required: false
    default: ""

outputs:
  status:
    description: "Test status (success or failure)"
    value: ${{ steps.test.outputs.status }}

runs:
  using: "composite"
  steps:
    - name: Test VM configuration
      id: test
      shell: bash
      env:
        FLY_API_TOKEN: ${{ inputs.fly-api-token }}
      run: |
        echo "Testing VM configuration, tools, and extension system..."

        app_name="${{ inputs.app-name }}"
        required_tools="${{ inputs.required-tools }}"
        user="${{ inputs.user }}"

        # Build tool checks dynamically
        tool_checks=""
        IFS=',' read -ra TOOLS <<< "$required_tools"
        for tool in "${TOOLS[@]}"; do
          tool=$(echo "$tool" | xargs)  # Trim whitespace
          tool_checks="$tool_checks
            which $tool || { echo \"âŒ $tool not found\"; exit 1; }"
        done

        # Build resource verification commands
        expected_memory="${{ inputs.expected-memory-mb }}"
        expected_cpus="${{ inputs.expected-cpus }}"
        expected_cpu_kind="${{ inputs.expected-cpu-kind }}"

        resource_checks=""
        if [ -n "$expected_memory" ]; then
          # Allow 10% variance for system overhead
          min_memory=$((expected_memory * 90 / 100))
          resource_checks="$resource_checks
          echo \"\"
          echo \"ðŸ“Š Verifying VM Resources...\"
          echo \"\"
          actual_memory=\$(free -m | awk '/^Mem:/{print \$2}')
          echo \"ðŸ’¾ Memory: \${actual_memory}MB (expected ~${expected_memory}MB)\"
          if [ \"\$actual_memory\" -lt \"$min_memory\" ]; then
            echo \"âŒ Memory below minimum threshold (${min_memory}MB)\"
            exit 1
          else
            echo \"âœ… Memory OK\"
          fi
          "
        fi

        if [ -n "$expected_cpus" ]; then
          resource_checks="$resource_checks
          actual_cpus=\$(nproc)
          echo \"âš¡ CPUs: \${actual_cpus} (expected ${expected_cpus})\"
          if [ \"\$actual_cpus\" != \"$expected_cpus\" ]; then
            echo \"âŒ CPU count mismatch\"
            exit 1
          else
            echo \"âœ… CPU count OK\"
          fi
          "
        fi

        if [ -n "$expected_cpu_kind" ]; then
          resource_checks="$resource_checks
          echo \"ðŸ”§ CPU kind verification (expected: ${expected_cpu_kind})\"
          # Note: CPU kind detection is approximate - we check for performance indicators
          if [ \"$expected_cpu_kind\" = \"performance\" ]; then
            # Performance CPUs should show dedicated CPU info
            if grep -q \"Xeon\\|EPYC\" /proc/cpuinfo 2>/dev/null; then
              echo \"âœ… CPU kind appears to be performance (dedicated)\"
            else
              echo \"âš ï¸  Warning: Could not confirm performance CPU type\"
            fi
          else
            echo \"â„¹ï¸  CPU kind: ${expected_cpu_kind} (shared CPUs - verification skipped)\"
          fi
          "
        fi

        # Test that configuration script and extension system exists
        if flyctl ssh console --app $app_name --user $user --command "
          echo \"Testing VM environment...\"
          echo \"\"

          # Check extension manager
          if [ -f \"/workspace/.system/bin/extension-manager\" ]; then
            echo \"âœ… Extension manager found\"
          else
            echo \"âŒ Extension manager missing\"
            exit 1
          fi

          # Check for extension examples
          if [ -d \"/workspace/scripts/lib/extensions.d\" ]; then
            ext_count=\$(ls -1 /workspace/scripts/lib/extensions.d/*.extension 2>/dev/null | wc -l)
            echo \"âœ… Extension directory found with \$ext_count extension examples\"
          else
            echo \"âŒ Extensions directory missing\"
            exit 1
          fi

          # Check basic tools
          $tool_checks

          # Check workspace directory
          ls -la /workspace/ || { echo \"âŒ workspace directory issue\"; exit 1; }

          # Verify VM resources if expected values provided
          $resource_checks

          echo \"\"
          echo \"âœ… All VM tests passed\"
        "; then
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… VM configuration test passed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "status=success" >> $GITHUB_OUTPUT
          exit 0
        else
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ VM configuration test failed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "status=failure" >> $GITHUB_OUTPUT
          exit 1
        fi
