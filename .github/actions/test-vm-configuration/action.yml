name: "Test VM Configuration"
description: "Tests VM configuration, tools, and extension system"

inputs:
  app-name:
    description: "Fly.io app name"
    required: true
  fly-api-token:
    description: "Fly.io API token"
    required: true
  required-tools:
    description: 'Comma-separated list of required tools to check (e.g., "curl,git,ssh")'
    required: false
    default: "curl,git,ssh"
  user:
    description: "SSH user"
    required: false
    default: "developer"
  expected-memory-mb:
    description: "Expected memory in MB (e.g., 1024, 4096, 8192). If provided, will verify actual matches expected."
    required: false
    default: ""
  expected-cpus:
    description: "Expected number of CPUs (e.g., 1, 2, 4). If provided, will verify actual matches expected."
    required: false
    default: ""
  expected-cpu-kind:
    description: "Expected CPU kind (shared or performance). If provided, will verify."
    required: false
    default: ""

outputs:
  status:
    description: "Test status (success or failure)"
    value: ${{ steps.test.outputs.status }}

runs:
  using: "composite"
  steps:
    - name: Test VM configuration
      id: test
      shell: bash
      env:
        FLY_API_TOKEN: ${{ inputs.fly-api-token }}
      run: |
        echo "Testing VM configuration, tools, and extension system..."

        app_name="${{ inputs.app-name }}"
        required_tools="${{ inputs.required-tools }}"
        user="${{ inputs.user }}"

        # Build tool checks dynamically
        tool_checks=""
        IFS=',' read -ra TOOLS <<< "$required_tools"
        for tool in "${TOOLS[@]}"; do
          tool=$(echo "$tool" | xargs)  # Trim whitespace
          tool_checks="$tool_checks
          if which $tool > /dev/null 2>&1; then
            tool_path=\$(which $tool)
            printf \"%-40s %-30s %s\\n\" \"$tool\" \"\$tool_path\" \"âœ… PASS\"
          else
            printf \"%-40s %-30s %s\\n\" \"$tool\" \"Not found\" \"âŒ FAIL\"
            exit 1
          fi"
        done

        # Build resource verification commands
        expected_memory="${{ inputs.expected-memory-mb }}"
        expected_cpus="${{ inputs.expected-cpus }}"
        expected_cpu_kind="${{ inputs.expected-cpu-kind }}"

        resource_checks=""
        if [ -n "$expected_memory" ] || [ -n "$expected_cpus" ] || [ -n "$expected_cpu_kind" ]; then
          resource_checks="
          echo \"\"
          echo \"ðŸ“Š Verifying VM Resources...\"
          echo \"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\"
          printf \"%-40s %-15s %-15s %s\\n\" \"Resource\" \"Expected\" \"Actual\" \"Status\"
          echo \"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\"
          "
        fi

        if [ -n "$expected_memory" ]; then
          # Allow 10% variance for system overhead
          min_memory=$((expected_memory * 90 / 100))
          resource_checks="$resource_checks
          actual_memory=\$(free -m | awk '/^Mem:/{print \$2}')
          if [ \"\$actual_memory\" -lt \"$min_memory\" ]; then
            printf \"%-40s %-15s %-15s %s\\n\" \"Memory (MB)\" \"${expected_memory}MB\" \"\${actual_memory}MB\" \"âŒ FAIL (below ${min_memory}MB min)\"
            exit 1
          else
            printf \"%-40s %-15s %-15s %s\\n\" \"Memory (MB)\" \"${expected_memory}MB\" \"\${actual_memory}MB\" \"âœ… PASS\"
          fi
          "
        fi

        if [ -n "$expected_cpus" ]; then
          resource_checks="$resource_checks
          actual_cpus=\$(nproc)
          if [ \"\$actual_cpus\" != \"$expected_cpus\" ]; then
            printf \"%-40s %-15s %-15s %s\\n\" \"CPU Count\" \"$expected_cpus\" \"\$actual_cpus\" \"âŒ FAIL\"
            exit 1
          else
            printf \"%-40s %-15s %-15s %s\\n\" \"CPU Count\" \"$expected_cpus\" \"\$actual_cpus\" \"âœ… PASS\"
          fi
          "
        fi

        if [ -n "$expected_cpu_kind" ]; then
          resource_checks="$resource_checks
          if [ \"$expected_cpu_kind\" = \"performance\" ]; then
            if grep -q \"Xeon\\|EPYC\" /proc/cpuinfo 2>/dev/null; then
              cpu_model=\$(grep -m1 'model name' /proc/cpuinfo | cut -d: -f2 | xargs)
              printf \"%-40s %-15s %-15s %s\\n\" \"CPU Type\" \"Performance\" \"Detected\" \"âœ… PASS (\$cpu_model)\"
            else
              printf \"%-40s %-15s %-15s %s\\n\" \"CPU Type\" \"Performance\" \"Unknown\" \"âš ï¸  WARNING (Could not confirm)\"
            fi
          else
            printf \"%-40s %-15s %-15s %s\\n\" \"CPU Type\" \"Shared\" \"Shared\" \"âœ… PASS\"
          fi
          "
        fi

        # Test that configuration script and extension system exists
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸ” Testing VM Configuration"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

        if flyctl ssh console --app $app_name --user $user -C "/bin/bash -c '
          set -e
          echo \"\"
          echo \"ðŸ“¦ Checking Extension System...\"
          echo \"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\"
          printf \"%-40s %-30s %s\\n\" \"Component\" \"Expected\" \"Status\"
          echo \"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\"

          # Check extension manager
          if [ -f \"/workspace/.system/bin/extension-manager\" ]; then
            printf \"%-40s %-30s %s\\n\" \"Extension Manager\" \"/workspace/.system/bin/extension-manager\" \"âœ… PASS\"
          else
            printf \"%-40s %-30s %s\\n\" \"Extension Manager\" \"/workspace/.system/bin/extension-manager\" \"âŒ FAIL\"
            exit 1
          fi

          # Check extension definitions directory (from Docker image)
          if [ -d \"/docker/lib/extensions.d\" ]; then
            ext_count=\$(ls -1 /docker/lib/extensions.d/*.extension 2>/dev/null | wc -l)
            printf \"%-40s %-30s %s\\n\" \"Extension Definitions\" \"/docker/lib/extensions.d/\" \"âœ… PASS (\$ext_count files)\"
          else
            printf \"%-40s %-30s %s\\n\" \"Extension Definitions\" \"/docker/lib/extensions.d/\" \"âŒ FAIL\"
            exit 1
          fi

          # Check manifest directory
          if [ -d \"/workspace/.system/manifest\" ]; then
            printf \"%-40s %-30s %s\\n\" \"Manifest Directory\" \"/workspace/.system/manifest/\" \"âœ… PASS\"
          else
            printf \"%-40s %-30s %s\\n\" \"Manifest Directory\" \"/workspace/.system/manifest/\" \"âŒ FAIL\"
            exit 1
          fi

          echo \"\"
          echo \"ðŸ› ï¸  Checking Required Tools...\"
          echo \"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\"
          printf \"%-40s %-30s %s\\n\" \"Tool\" \"Command\" \"Status\"
          echo \"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\"
          $tool_checks

          echo \"\"
          echo \"ðŸ“ Checking Workspace Directory...\"
          echo \"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\"
          printf \"%-40s %-30s %s\\n\" \"Component\" \"Expected\" \"Status\"
          echo \"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\"
          if ls -la /workspace/ > /dev/null 2>&1; then
            printf \"%-40s %-30s %s\\n\" \"Workspace Directory\" \"/workspace/\" \"âœ… PASS\"
          else
            printf \"%-40s %-30s %s\\n\" \"Workspace Directory\" \"/workspace/\" \"âŒ FAIL\"
            exit 1
          fi

          $resource_checks

          echo \"\"
          echo \"âœ… All VM configuration tests passed\"
        '"; then
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… VM configuration test passed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "status=success" >> $GITHUB_OUTPUT
          exit 0
        else
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ VM configuration test failed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "status=failure" >> $GITHUB_OUTPUT
          exit 1
        fi
