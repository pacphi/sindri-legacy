name: "Build and Push Docker Image"
description: "Builds Docker image and pushes to Fly.io registry"

inputs:
  fly-api-token:
    description: "Fly.io API token"
    required: true
  tag:
    description: "Image tag (e.g., pr-123-a1b2c3d)"
    required: true
  registry-app:
    description: "Fly registry app name"
    required: false
    default: "sindri-registry"
  dockerfile:
    description: "Path to Dockerfile"
    required: false
    default: "Dockerfile"
  build-context:
    description: "Docker build context directory"
    required: false
    default: "."
  base-image:
    description: "Base image to use (for layered builds)"
    required: false
    default: ""
  tooling-image:
    description: "Tooling image to use (for layered builds)"
    required: false
    default: ""
  build-args:
    description: "Additional build arguments (comma-separated, e.g., 'ARG1=value1,ARG2=value2')"
    required: false
    default: ""

outputs:
  image-url:
    description: "Full image URL (registry.fly.io/app:tag)"
    value: ${{ steps.push.outputs.url }}
  image-tag:
    description: "Image tag used"
    value: ${{ inputs.tag }}

runs:
  using: "composite"
  steps:
    - name: Install Fly CLI
      uses: superfly/flyctl-actions/setup-flyctl@master

    - name: Authenticate with Fly Docker registry
      shell: bash
      env:
        FLY_API_TOKEN: ${{ inputs.fly-api-token }}
      run: |
        echo "Authenticating with Fly.io Docker registry..."
        flyctl auth docker

    - name: Pull base images (if specified)
      shell: bash
      run: |
        # Pull base image if specified
        if [ -n "${{ inputs.base-image }}" ]; then
          echo "Pulling base image: ${{ inputs.base-image }}"
          docker pull ${{ inputs.base-image }} || echo "⚠️ Base image not found, will build from scratch"
        fi

        # Pull tooling image if specified
        if [ -n "${{ inputs.tooling-image }}" ]; then
          echo "Pulling tooling image: ${{ inputs.tooling-image }}"
          docker pull ${{ inputs.tooling-image }} || echo "⚠️ Tooling image not found, will build from scratch"
        fi

    - name: Build and push image
      id: push
      shell: bash
      run: |
        IMAGE_URL="registry.fly.io/${{ inputs.registry-app }}:${{ inputs.tag }}"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo "Building Docker image"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo "Image: ${IMAGE_URL}"
        echo "Dockerfile: ${{ inputs.dockerfile }}"
        echo "Context: ${{ inputs.build-context }}"
        echo ""

        # Prepare build args
        BUILD_ARGS=""

        # Add base image if specified
        if [ -n "${{ inputs.base-image }}" ]; then
          BUILD_ARGS="${BUILD_ARGS} --build-arg BASE_IMAGE=${{ inputs.base-image }}"
          echo "Using base image: ${{ inputs.base-image }}"
        fi

        # Add tooling image if specified
        if [ -n "${{ inputs.tooling-image }}" ]; then
          BUILD_ARGS="${BUILD_ARGS} --build-arg TOOLING_IMAGE=${{ inputs.tooling-image }}"
          echo "Using tooling image: ${{ inputs.tooling-image }}"
        fi

        # Add additional build args if specified
        if [ -n "${{ inputs.build-args }}" ]; then
          # Split comma-separated build args and add them
          IFS=',' read -ra ARGS <<< "${{ inputs.build-args }}"
          for arg in "${ARGS[@]}"; do
            BUILD_ARGS="${BUILD_ARGS} --build-arg ${arg}"
          done
          echo "Additional build args: ${{ inputs.build-args }}"
        fi

        echo ""

        # Build image
        docker build \
          -f ${{ inputs.dockerfile }} \
          -t ${IMAGE_URL} \
          ${BUILD_ARGS} \
          ${{ inputs.build-context }}

        echo ""
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo "Pushing to Fly.io registry"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

        # Push to registry
        docker push ${IMAGE_URL}

        # Set outputs
        echo "url=${IMAGE_URL}" >> $GITHUB_OUTPUT
        echo ""
        echo "✅ Image pushed successfully: ${IMAGE_URL}"
